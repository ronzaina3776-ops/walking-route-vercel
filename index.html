<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; width: 100%; }
        @media (max-width: 640px) {
            #map { height: 400px; }
        }
        
        /* Places Autocompleteç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pac-container {
            z-index: 10000;
            font-family: inherit;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .pac-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-top: 1px solid #e5e7eb;
        }
        
        .pac-item:hover {
            background-color: #f3f4f6;
        }
        
        .pac-item-query {
            font-weight: 600;
            color: #1f2937;
        }
        
        .pac-icon {
            display: none;
        }

        /* ãƒŠãƒ“ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        
        .nav-pulse {
            animation: pulse-ring 1.5s ease-out infinite;
        }

        /* ãƒŠãƒ“ãƒ¢ãƒ¼ãƒ‰æ™‚ã®åœ°å›³ã‚’å¤§ãã */
        #map.nav-mode {
            height: 70vh;
            min-height: 400px;
        }

        /* ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .stamp-card {
            transition: all 0.2s;
        }
        .stamp-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .stamp-visited {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }
        .stamp-unvisited {
            background: white;
            border-color: #e5e7eb;
        }
        .category-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-4">
    
    <!-- é–‹å§‹ç”»é¢ -->
    <div id="startScreen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="bg-green-500 p-4 rounded-2xl inline-block mb-4">
                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold mb-2">ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>
                <p class="text-gray-500">æ•£æ­©ã‚³ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
            </div>
            
            <button onclick="getLocation()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl hover:bg-green-600 transition-colors">
                ğŸ“ ç¾åœ¨åœ°ã‚’ä½¿ã†
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="max-w-4xl mx-auto space-y-6 hidden">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div>
                <h1 class="text-2xl font-bold">ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>
                <p class="text-sm text-gray-500">Google Mapsç‰ˆ</p>
            </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆ3ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
        <div id="modeSection" class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="font-medium mb-3">ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h2>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="setMode('loop')" id="loopModeBtn" class="p-4 rounded-xl border-2 border-green-500 bg-green-50 transition-all">
                    <div class="text-2xl mb-2">ğŸ”„</div>
                    <div class="font-bold text-sm">å‘¨å›</div>
                    <div class="text-xs text-gray-600 mt-1">æˆ»ã£ã¦ãã‚‹</div>
                </button>
                <button onclick="setMode('oneway')" id="onewayModeBtn" class="p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 transition-all">
                    <div class="text-2xl mb-2">â¡ï¸</div>
                    <div class="font-bold text-sm">ç‰‡é“</div>
                    <div class="text-xs text-gray-600 mt-1">ç›®çš„åœ°ã¾ã§</div>
                </button>
                <button onclick="setMode('stamp')" id="stampModeBtn" class="p-4 rounded-xl border-2 border-gray-200 hover:border-purple-500 transition-all">
                    <div class="text-2xl mb-2">ğŸ“</div>
                    <div class="font-bold text-sm">ã‚¹ã‚¿ãƒ³ãƒ—</div>
                    <div class="text-xs text-gray-600 mt-1">ãƒ©ãƒªãƒ¼å·¡ã‚Š</div>
                </button>
            </div>
        </div>

        <!-- ========== ãƒ«ãƒ¼ãƒˆä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå‘¨å›ãƒ»ç‰‡é“ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ ========== -->
        <div id="routeCreationSection">
            <!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³ -->
            <div id="missionSection" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h2>
                <button onclick="showRandomMission()" class="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold hover:shadow-xl transition-all text-lg">
                    ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹
                </button>
                
                <div id="missionDisplay" class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl hidden">
                    <div class="text-center">
                        <div id="missionEmoji" class="text-5xl mb-3">ğŸªœ</div>
                        <div id="missionText" class="text-lg font-bold text-gray-800 mb-2">æ„å‘³ã®ãªã„éšæ®µã‚’è¦‹ã¤ã‘ã‚ˆã†</div>
                        <div id="missionHint" class="text-sm text-gray-600 mb-4">ã©ã“ã«ã‚‚è¡Œã‹ãªã„ç´”ç²‹éšæ®µã‚’æ¢ã—ã¦ã¿ã‚ˆã†</div>
                        <button onclick="showRandomMission()" class="px-4 py-2 bg-white rounded-lg text-purple-600 font-medium hover:bg-purple-50 transition-all">
                            ğŸ”„ åˆ¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç‰‡é“ãƒ¢ãƒ¼ãƒ‰: ç›®çš„åœ°é¸æŠ -->
            <div id="destinationSection" class="bg-white rounded-2xl shadow-lg p-6 mb-6 hidden">
                <h2 class="font-medium mb-3">ğŸ“ ç›®çš„åœ°</h2>
                
                <button onclick="selectFromMap()" id="mapSelectBtn" class="w-full mb-4 py-4 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition-all text-lg">
                    ğŸ—ºï¸ åœ°å›³ã‹ã‚‰é¸æŠï¼ˆãŠã™ã™ã‚ï¼‰
                </button>
                
                <div class="mb-3">
                    <div class="text-sm font-medium text-gray-600 mb-2">ç™»éŒ²æ¸ˆã¿ã®ç›®çš„åœ°:</div>
                    <div id="savedDestinations" class="space-y-2"></div>
                </div>
                
                <button onclick="showAddDestination()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-green-500 hover:text-green-600 transition-all text-sm">
                    ï¼‹ ã¾ãŸã¯ä½æ‰€ã§è¿½åŠ 
                </button>
                
                <div id="selectedDestinationDisplay" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
                    <div class="text-sm text-gray-600">é¸æŠä¸­ã®ç›®çš„åœ°:</div>
                    <div id="selectedDestinationName" class="font-bold text-lg"></div>
                    <div id="selectedDestinationDistance" class="text-sm text-gray-600 mt-1"></div>
                </div>
            </div>

            <!-- æ­©æ•°è¨­å®š -->
            <div id="stepsSection" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ç›®æ¨™æ­©æ•°</h2>
                <div class="flex items-center gap-4">
                    <input type="range" id="stepsRange" min="1000" max="20000" step="500" value="5000" 
                        class="flex-1 h-2 bg-gray-200 rounded-lg cursor-pointer accent-green-500"
                        oninput="updateSteps(this.value)">
                    <div class="text-right min-w-32">
                        <div id="stepsDisplay" class="text-3xl font-bold text-green-600">5,000</div>
                        <div id="distanceDisplay" class="text-sm text-gray-500">æ­© (3.5km)</div>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button onclick="setSteps(3000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">3åƒæ­©</button>
                    <button onclick="setSteps(5000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">5åƒæ­©</button>
                    <button onclick="setSteps(10000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">1ä¸‡æ­©</button>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒˆè¨­å®š -->
            <div id="routeSettingsSection" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ãƒ«ãƒ¼ãƒˆè¨­å®š</h2>
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="avoidHighways" checked class="w-5 h-5 accent-green-500">
                    <span class="text-gray-700">å¤§é€šã‚Šãƒ»å¹¹ç·šé“è·¯ã‚’é¿ã‘ã‚‹</span>
                </label>
            </div>

            <!-- ãƒ«ãƒ¼ãƒˆä½œæˆãƒœã‚¿ãƒ³ -->
            <button onclick="createRoute()" id="createRouteBtn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition-all mb-6">
                ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰
            </button>
        </div>

        <!-- ========== ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== -->
        <div id="stampRallySection" class="hidden">
            <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ã‚«ãƒ†ã‚´ãƒª</h2>
                <div class="flex flex-wrap gap-2" id="categoryButtons">
                    <button onclick="filterByCategory('all')" class="category-btn active px-4 py-2 rounded-full border-2 transition-all text-sm font-medium">
                        ğŸ¯ ã™ã¹ã¦
                    </button>
                    <button onclick="filterByCategory('temples')" class="category-btn px-4 py-2 rounded-full border-2 border-gray-200 transition-all text-sm font-medium">
                        â›©ï¸ ç¥ç¤¾ä»é–£
                    </button>
                    <button onclick="filterByCategory('public')" class="category-btn px-4 py-2 rounded-full border-2 border-gray-200 transition-all text-sm font-medium">
                        ğŸ›ï¸ å…¬å…±æ–½è¨­
                    </button>
                </div>
            </div>

            <!-- ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ä¸€è¦§ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h2>
                <div id="rallyList" class="space-y-3">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼è©³ç´°ï¼ˆã‚¹ãƒãƒƒãƒˆä¸€è¦§ï¼‰ -->
            <div id="rallyDetailSection" class="bg-white rounded-2xl shadow-lg p-6 mb-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="closeRallyDetail()" class="text-gray-500 hover:text-gray-700">
                        â† æˆ»ã‚‹
                    </button>
                    <div id="rallyProgress" class="text-sm font-medium text-green-600"></div>
                </div>
                <h2 id="rallyDetailTitle" class="text-xl font-bold mb-2"></h2>
                <p id="rallyDetailDesc" class="text-sm text-gray-600 mb-4"></p>
                
                <!-- ä¸¦ã³æ›¿ãˆ -->
                <div class="flex gap-2 mb-4">
                    <button onclick="sortSpots('default')" class="sort-btn active px-3 py-1 text-sm rounded-lg bg-gray-100">ç•ªå·é †</button>
                    <button onclick="sortSpots('distance')" class="sort-btn px-3 py-1 text-sm rounded-lg bg-gray-100">è·é›¢é †</button>
                    <button onclick="sortSpots('unvisited')" class="sort-btn px-3 py-1 text-sm rounded-lg bg-gray-100">æœªè¨ªå•å„ªå…ˆ</button>
                </div>
                
                <div id="spotList" class="space-y-3">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                
                <!-- è¿‘ãã®æœªè¨ªå•ã‚¹ãƒãƒƒãƒˆã¸ãƒ«ãƒ¼ãƒˆä½œæˆ -->
                <button onclick="createRouteToNearestSpot()" class="w-full mt-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-bold hover:shadow-xl transition-all">
                    ğŸš¶ è¿‘ãã®æœªè¨ªå•ã‚¹ãƒãƒƒãƒˆã¸ãƒ«ãƒ¼ãƒˆä½œæˆ
                </button>
            </div>
        </div>

        <!-- åœ°å›³ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-lg font-bold mb-4">ğŸ“ åœ°å›³</h2>
            <div id="map" class="rounded-xl border-2 border-gray-200"></div>
            
            <!-- ãƒ«ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
            <div id="routeSwitch" class="mt-4 hidden">
                <div class="text-sm font-medium text-gray-600 mb-2">ãƒ«ãƒ¼ãƒˆã‚’é¸æŠ:</div>
                <div id="routeSwitchButtons" class="flex gap-2"></div>
            </div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒˆæƒ…å ± -->
        <div id="routeInfo" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <h2 class="text-lg font-bold mb-4">ğŸ“Š ãƒ«ãƒ¼ãƒˆæƒ…å ±</h2>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-green-50 p-4 rounded-xl text-center">
                    <div id="routeDistance" class="text-2xl font-bold text-green-600">0</div>
                    <div class="text-sm text-gray-600">km</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl text-center">
                    <div id="routeSteps" class="text-2xl font-bold text-blue-600">0</div>
                    <div class="text-sm text-gray-600">æ­©</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl text-center">
                    <div id="routeTime" class="text-2xl font-bold text-purple-600">0</div>
                    <div class="text-sm text-gray-600">åˆ†</div>
                </div>
            </div>

            <button id="startNavBtn" onclick="startNavigation()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 rounded-xl hover:shadow-xl transition-all mb-3">
                ğŸ§­ ã“ã®ã‚¢ãƒ—ãƒªã§ãƒŠãƒ“é–‹å§‹
            </button>

            <button id="openInGoogleMaps" onclick="openInGoogleMaps()" class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200 transition-colors">
                ğŸ“± Googleãƒãƒƒãƒ—ã§é–‹ã
            </button>
        </div>

        <!-- ãƒŠãƒ“ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º -->
        <div id="navModePanel" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold">ğŸ§­ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä¸­</h2>
                <div id="navStatus" class="text-sm text-green-600 font-medium">
                    ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-xl text-center">
                    <div id="navWalkedDistance" class="text-2xl font-bold text-blue-600">0</div>
                    <div class="text-sm text-gray-600">æ­©ã„ãŸè·é›¢ (km)</div>
                </div>
                <div class="bg-green-50 p-4 rounded-xl text-center">
                    <div id="navRemainingDistance" class="text-2xl font-bold text-green-600">0</div>
                    <div class="text-sm text-gray-600">æ®‹ã‚Š (km)</div>
                </div>
            </div>

            <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 rounded-xl">
                <span class="font-medium">åœ°å›³ã®è‡ªå‹•è¿½å¾“</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="followModeToggle" checked class="sr-only peer" onchange="toggleFollowMode()">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                </label>
            </div>
            
            <button onclick="stopNavigation()" class="w-full bg-red-500 text-white font-bold py-3 rounded-xl hover:bg-red-600 transition-colors">
                â¹ï¸ ãƒŠãƒ“ã‚’çµ‚äº†
            </button>
        </div>

    </div>

    <!-- ç›®çš„åœ°è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addDestinationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">æ–°ã—ã„ç›®çš„åœ°ã‚’è¿½åŠ </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åå‰ï¼ˆä¿å­˜ã™ã‚‹å ´åˆã®ã¿å¿…è¦ï¼‰</label>
                    <input type="text" id="destName" placeholder="ä¾‹: è‡ªå®…ã€è·å ´ã€ã‚«ãƒ•ã‚§" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-green-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä½æ‰€ï¼ˆæ–½è¨­åã§ã‚‚OKï¼‰</label>
                    <input type="text" id="destAddress" placeholder="ä¾‹: å¤§é˜ªåŸå…¬åœ’ã€æ¢…ç”°é§…ã€é“é “å €" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-green-500 outline-none">
                    <p class="mt-2 text-xs text-gray-500">ğŸ’¡ å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
            
            <div class="space-y-3 mt-6">
                <button onclick="useDestinationNow()" class="w-full py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all font-bold">
                    ğŸš€ ç™»éŒ²ã›ãšã«ã™ãä½¿ã†
                </button>
                <div class="flex gap-3">
                    <button onclick="closeAddDestination()" class="flex-1 py-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 transition-all">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button onclick="saveDestination()" class="flex-1 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all">
                        ğŸ’¾ ä¿å­˜ã—ã¦ä½¿ã†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="checkinModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div id="checkinContent" class="text-center">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYFFfCe_7Ry15jh7J1n8gw7fF4JLJohxE&libraries=geometry,places"></script>
    <script>
        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let map = null;
        let userLocation = null;
        let currentSteps = 5000;
        let currentRoute = null;
        let currentPolyline = null;
        let allRoutes = [];
        let currentMode = 'loop'; // 'loop', 'oneway', 'stamp'
        let selectedDestination = null;
        let destinationMarker = null;
        let isSelectingFromMap = false;
        let geocoder = null;
        let autocomplete = null;
        let autocompletePlace = null;

        // ãƒŠãƒ“ãƒ¢ãƒ¼ãƒ‰ç”¨
        let isNavigating = false;
        let watchId = null;
        let currentPositionMarker = null;
        let currentPositionCircle = null;
        let followMode = true;
        let startPosition = null;
        let totalRouteDistance = 0;

        // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ç”¨
        let currentRallyKey = null;
        let currentSortMode = 'default';
        let stampMarkers = [];

        // ========================================
        // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿
        // ========================================
        const stampRallies = {
            // ç¥ç¤¾ä»é–£ç³»
            shichifukujin: {
                name: "å¤§é˜ªä¸ƒç¦ç¥å·¡ã‚Š",
                icon: "â›©ï¸",
                category: "temples",
                description: "æ±Ÿæˆ¸æ™‚ä»£ã‹ã‚‰ç¶šãç¦ã‚’æ‹›ãä¸ƒç¦ç¥å·¡ã‚Š",
                spots: [
                    { id: 1, name: "ä¸‰å…‰ç¥ç¤¾", detail: "å¯¿è€ç¥", address: "å¤©ç‹å¯ºåŒºç‰é€ æœ¬ç”º14-90", lat: 34.67361, lng: 135.52833, blessing: "é•·å¯¿ãƒ»å¹¸ç¦" },
                    { id: 2, name: "é•·ä¹…å¯º", detail: "ç¦ç¦„å¯¿", address: "ä¸­å¤®åŒºè°·ç”º8-2-49", lat: 34.67028, lng: 135.51611, blessing: "å¹¸ç¦ãƒ»è²¡ç”£ãƒ»é•·å¯¿" },
                    { id: 3, name: "æ³•æ¡ˆå¯º", detail: "å¼è²¡å¤©", address: "ä¸­å¤®åŒºå³¶ä¹‹å†…2-10-14", lat: 34.66750, lng: 135.50667, blessing: "èŠ¸èƒ½ãƒ»è²¡é‹" },
                    { id: 4, name: "å¤§ä¹—åŠ", detail: "æ¯˜æ²™é–€å¤©", address: "æµªé€ŸåŒºæ—¥æœ¬æ©‹3-6-13", lat: 34.65833, lng: 135.50583, blessing: "å‹é‹ãƒ»å„é™¤ã‘" },
                    { id: 5, name: "å¤§å›½ä¸»ç¥ç¤¾", detail: "å¤§é»’å¤©", address: "æµªé€ŸåŒºæ•·æ´¥è¥¿1-2-12", lat: 34.65444, lng: 135.49944, blessing: "é‡‘é‹ãƒ»å•†å£²ç¹ç››" },
                    { id: 6, name: "ä»Šå®®æˆç¥ç¤¾", detail: "æµæ¯”å¯¿", address: "æµªé€ŸåŒºæµç¾é ˆè¥¿1-6-10", lat: 34.65222, lng: 135.50556, blessing: "å•†å£²ç¹ç››" },
                    { id: 7, name: "å››å¤©ç‹å¯º å¸ƒè¢‹å ‚", detail: "å¸ƒè¢‹å°Š", address: "å¤©ç‹å¯ºåŒºå››å¤©ç‹å¯º1-11-18", lat: 34.65361, lng: 135.51639, blessing: "ç¬‘é–€æ¥ç¦" }
                ]
            },
            naniwashichiko: {
                name: "ãªã«ã‚ä¸ƒå¹¸ã‚ãã‚Š",
                icon: "ğŸ™",
                category: "temples",
                description: "å¤§é˜ªã‚’ä»£è¡¨ã™ã‚‹7ç¤¾å¯ºã§ä¸ƒã¤ã®å¹¸ã›ã‚’",
                spots: [
                    { id: 1, name: "å¤§é˜ªå¤©æº€å®®", detail: "å­¦æ¥­æˆå°±", address: "åŒ—åŒºå¤©ç¥æ©‹2-1-8", lat: 34.69472, lng: 135.51361, blessing: "å­¦å•ãƒ»å—é¨“åˆæ ¼" },
                    { id: 2, name: "ä½å‰å¤§ç¤¾", detail: "å„é™¤ç¥ˆé¡˜", address: "ä½å‰åŒºä½å‰2-9-89", lat: 34.61278, lng: 135.49278, blessing: "å„é™¤ã‘ãƒ»é–‹é‹" },
                    { id: 3, name: "å››æ¢ç•·ç¥ç¤¾", detail: "å¿ƒé¡˜æˆå°±", address: "å››æ¡ç•·å¸‚å—é‡2-18-1", lat: 34.73889, lng: 135.63889, blessing: "é¡˜ã„äº‹æˆå°±" },
                    { id: 4, name: "å¤§å¿µä½›å¯º", detail: "è«¸èŠ¸ä¸Šé”", address: "å¹³é‡åŒºå¹³é‡ä¸Šç”º1-7-26", lat: 34.62639, lng: 135.55194, blessing: "èŠ¸èƒ½ãƒ»æŠ€è¡“å‘ä¸Š" },
                    { id: 5, name: "å¤ªèå¯º", detail: "ç„¡ç—…æ¯ç½", address: "åŒ—åŒºå¤ªèå¯ºç”º3-7", lat: 34.70333, lng: 135.50389, blessing: "å¥åº·ãƒ»ç—…æ°—å¹³ç™’" },
                    { id: 6, name: "ä»Šå®®æˆç¥ç¤¾", detail: "å•†å£²ç¹ç››", address: "æµªé€ŸåŒºæµç¾é ˆè¥¿1-6-10", lat: 34.65222, lng: 135.50556, blessing: "å•†å£²ç¹ç››" },
                    { id: 7, name: "å››å¤©ç‹å¯º", detail: "å®¶å†…å®‰å…¨", address: "å¤©ç‹å¯ºåŒºå››å¤©ç‹å¯º1-11-18", lat: 34.65361, lng: 135.51639, blessing: "å®¶æ—ã®å¹¸ç¦" }
                ]
            },
            shotokutaishi: {
                name: "è–å¾³å¤ªå­ã‚†ã‹ã‚Šã®å¯º",
                icon: "ğŸŒ¸",
                category: "temples",
                description: "æ²³å†…ä¸‰å¤ªå­ã¨æ—¥æœ¬æœ€å¤ã®å®˜å¯º",
                spots: [
                    { id: 1, name: "å››å¤©ç‹å¯º", detail: "æ—¥æœ¬ä»æ³•æœ€åˆã®å®˜å¯º", address: "å¤©ç‹å¯ºåŒºå››å¤©ç‹å¯º1-11-18", lat: 34.65361, lng: 135.51639, blessing: "593å¹´å‰µå»º" },
                    { id: 2, name: "å¡ç¦å¯ºï¼ˆä¸Šã®å¤ªå­ï¼‰", detail: "è–å¾³å¤ªå­å¾¡å»Ÿ", address: "å—æ²³å†…éƒ¡å¤ªå­ç”ºå¤ªå­2146", lat: 34.51722, lng: 135.64639, blessing: "å¤ªå­ã®å¢“æ‰€" },
                    { id: 3, name: "é‡ä¸­å¯ºï¼ˆä¸­ã®å¤ªå­ï¼‰", detail: "é£›é³¥æ™‚ä»£å‰µå»º", address: "ç¾½æ›³é‡å¸‚é‡ã€…ä¸Š5-9-24", lat: 34.55361, lng: 135.59917, blessing: "å¼¥å‹’è©è–©åƒ" },
                    { id: 4, name: "å¤§è–å‹è»å¯ºï¼ˆä¸‹ã®å¤ªå­ï¼‰", detail: "ç‰©éƒ¨å®ˆå±‹è¨ä¼ã®åœ°", address: "å…«å°¾å¸‚å¤ªå­å ‚3-3-16", lat: 34.62278, lng: 135.59889, blessing: "æˆ¦å‹ç¥ˆé¡˜" }
                ]
            },
            joyanokane: {
                name: "é™¤å¤œã®é˜å·¡ã‚Šï¼ˆå¤§é˜ªå¸‚å†…ï¼‰",
                icon: "ğŸ””",
                category: "temples",
                description: "å¤§æ™¦æ—¥ã«é˜ã‚’ã¤ã‘ã‚‹å¯ºé™¢ï¼ˆ8ãƒ¶æ‰€ï¼‰",
                spots: [
                    { id: 1, name: "å››å¤©ç‹å¯º", detail: "åŒ—é˜å ‚ãƒ»å—é˜å ‚ãƒ»é¼“æ¥¼", address: "å¤©ç‹å¯ºåŒºå››å¤©ç‹å¯º1-11-18", lat: 34.65361, lng: 135.51639, blessing: "å…ˆç€108åÃ—3ãƒ¶æ‰€" },
                    { id: 2, name: "ä¸€å¿ƒå¯º", detail: "æ–‡æ²»å…ƒå¹´é–‹åŸº", address: "å¤©ç‹å¯ºåŒºé€¢é˜ª2-8-69", lat: 34.65194, lng: 135.50889, blessing: "å½“æ—¥å…ˆç€é †" },
                    { id: 3, name: "å¤§å¿µä½›å¯º", detail: "æ—¥æœ¬æœ€åˆã®å¿µä»é“å ´", address: "å¹³é‡åŒºå¹³é‡ä¸Šç”º1-7-26", lat: 34.62639, lng: 135.55194, blessing: "108çµ„é™å®š" },
                    { id: 4, name: "æµæµ„å¯º", detail: "å¹³é‡åŒºã®å¤åˆ¹", address: "å¹³é‡åŒºå¹³é‡å¸‚ç”º3-9-17", lat: 34.62500, lng: 135.55833, blessing: "åˆ¶é™ãªã—" },
                    { id: 5, name: "æ³•æ€§å¯º", detail: "400å¹´ä»¥ä¸Šã®æ­´å²", address: "ä¸­å¤®åŒºä¸­å¯º1-1-32", lat: 34.66722, lng: 135.51500, blessing: "è‡ªç”±å‚åŠ " },
                    { id: 6, name: "åŒ—å¾¡å ‚", detail: "å¾¡å ‚ç­‹ã®ç”±æ¥", address: "ä¸­å¤®åŒºæœ¬ç”º4-1-3", lat: 34.68361, lng: 135.50028, blessing: "å…ˆç€500å" },
                    { id: 7, name: "å—å¾¡å ‚", detail: "å¾¡å ‚ç­‹ã®ç”±æ¥", address: "ä¸­å¤®åŒºä¹…å¤ªéƒç”º4-1-11", lat: 34.68028, lng: 135.50222, blessing: "22æ™‚é–‹å§‹" },
                    { id: 8, name: "å¤ªèå¯º", detail: "å¼˜æ³•å¤§å¸«å‰µå»º", address: "åŒ—åŒºå¤ªèå¯ºç”º3-7", lat: 34.70333, lng: 135.50389, blessing: "0æ™‚ã¾ã§åˆ¶é™ãªã—" }
                ]
            },
            // å…¬å…±æ–½è¨­ç³»
            libraries: {
                name: "å¤§é˜ªå¸‚ç«‹å›³æ›¸é¤¨",
                icon: "ğŸ“š",
                category: "public",
                description: "å¤§é˜ªå¸‚ç«‹å›³æ›¸é¤¨24é¤¨ã‚’å·¡ã‚‹",
                spots: [
                    { id: 1, name: "ä¸­å¤®å›³æ›¸é¤¨", address: "è¥¿åŒºåŒ—å €æ±Ÿ4-3-2", lat: 34.67222, lng: 135.48361 },
                    { id: 2, name: "åŒ—å›³æ›¸é¤¨", address: "åŒ—åŒºæœ¬åº„æ±3-2-2", lat: 34.71194, lng: 135.51583 },
                    { id: 3, name: "éƒ½å³¶å›³æ›¸é¤¨", address: "éƒ½å³¶åŒºä¸­é‡ç”º2-16-25", lat: 34.70750, lng: 135.53028 },
                    { id: 4, name: "ç¦å³¶å›³æ›¸é¤¨", address: "ç¦å³¶åŒºå‰é‡3-17-23", lat: 34.69444, lng: 135.47028 },
                    { id: 5, name: "æ­¤èŠ±å›³æ›¸é¤¨", address: "æ­¤èŠ±åŒºå››è²«å³¶1-1-18", lat: 34.68250, lng: 135.45111 },
                    { id: 6, name: "å³¶ä¹‹å†…å›³æ›¸é¤¨", address: "ä¸­å¤®åŒºå³¶ä¹‹å†…1-10-13", lat: 34.67139, lng: 135.50583 },
                    { id: 7, name: "æ¸¯å›³æ›¸é¤¨", address: "æ¸¯åŒºå¼å¤©2-1-5", lat: 34.66611, lng: 135.46083 },
                    { id: 8, name: "å¤§æ­£å›³æ›¸é¤¨", address: "å¤§æ­£åŒºåƒå³¶3-6-15", lat: 34.64750, lng: 135.47111 },
                    { id: 9, name: "å¤©ç‹å¯ºå›³æ›¸é¤¨", address: "å¤©ç‹å¯ºåŒºä¸Šä¹‹å®®ç”º4-47", lat: 34.66139, lng: 135.52139 },
                    { id: 10, name: "æµªé€Ÿå›³æ›¸é¤¨", address: "æµªé€ŸåŒºæ•·æ´¥è¥¿1-5-23", lat: 34.65417, lng: 135.49833 },
                    { id: 11, name: "è¥¿æ·€å·å›³æ›¸é¤¨", address: "è¥¿æ·€å·åŒºå¾¡å¹£å³¶1-2-10", lat: 34.71139, lng: 135.45194 },
                    { id: 12, name: "æ·€å·å›³æ›¸é¤¨", address: "æ·€å·åŒºæ–°é«˜3-9-36", lat: 34.73361, lng: 135.48083 },
                    { id: 13, name: "æ±æ·€å·å›³æ›¸é¤¨", address: "æ±æ·€å·åŒºæ±ä¸­å³¶1-13-21", lat: 34.73389, lng: 135.52139 },
                    { id: 14, name: "æ±æˆå›³æ›¸é¤¨", address: "æ±æˆåŒºå¤§ä»Šé‡Œè¥¿3-2-17", lat: 34.67028, lng: 135.54500 },
                    { id: 15, name: "ç”Ÿé‡å›³æ›¸é¤¨", address: "ç”Ÿé‡åŒºå‹å±±å—3-14-23", lat: 34.64861, lng: 135.53972 },
                    { id: 16, name: "æ—­å›³æ›¸é¤¨", address: "æ—­åŒºä¸­å®®1-11-14", lat: 34.72556, lng: 135.54139 },
                    { id: 17, name: "åŸæ±å›³æ›¸é¤¨", address: "åŸæ±åŒºä¸­æµœ2-8-28", lat: 34.69861, lng: 135.55806 },
                    { id: 18, name: "é¶´è¦‹å›³æ›¸é¤¨", address: "é¶´è¦‹åŒºæ¨ªå ¤5-3-28", lat: 34.70917, lng: 135.58222 },
                    { id: 19, name: "é˜¿å€é‡å›³æ›¸é¤¨", address: "é˜¿å€é‡åŒºé˜¿å€é‡ç­‹4-19-118", lat: 34.63222, lng: 135.51444 },
                    { id: 20, name: "ä½ä¹‹æ±Ÿå›³æ›¸é¤¨", address: "ä½ä¹‹æ±ŸåŒºç²‰æµœ1-1-36", lat: 34.61000, lng: 135.48694 },
                    { id: 21, name: "ä½å‰å›³æ›¸é¤¨", address: "ä½å‰åŒºå—ä½å‰1-8-26", lat: 34.60528, lng: 135.50500 },
                    { id: 22, name: "æ±ä½å‰å›³æ›¸é¤¨", address: "æ±ä½å‰åŒºæ±ç”°è¾º2-11-28", lat: 34.61611, lng: 135.52222 },
                    { id: 23, name: "å¹³é‡å›³æ›¸é¤¨", address: "å¹³é‡åŒºå¹³é‡æ±2-2-95", lat: 34.62139, lng: 135.56917 },
                    { id: 24, name: "è¥¿æˆå›³æ›¸é¤¨", address: "è¥¿æˆåŒºå²¸é‡Œæ±1-3-16", lat: 34.63806, lng: 135.49889 }
                ]
            },
            kuyakusho: {
                name: "å¤§é˜ª24åŒºå½¹æ‰€",
                icon: "ğŸ›ï¸",
                category: "public",
                description: "å¤§é˜ªå¸‚24åŒºã®åŒºå½¹æ‰€ã‚’å·¡ã‚‹",
                spots: [
                    { id: 1, name: "åŒ—åŒºå½¹æ‰€", address: "åŒ—åŒºæ‰‡ç”º2-1-27", lat: 34.70333, lng: 135.51111 },
                    { id: 2, name: "éƒ½å³¶åŒºå½¹æ‰€", address: "éƒ½å³¶åŒºä¸­é‡ç”º2-16-20", lat: 34.70750, lng: 135.52972 },
                    { id: 3, name: "ç¦å³¶åŒºå½¹æ‰€", address: "ç¦å³¶åŒºå¤§é–‹1-8-1", lat: 34.69111, lng: 135.47167 },
                    { id: 4, name: "æ­¤èŠ±åŒºå½¹æ‰€", address: "æ­¤èŠ±åŒºæ˜¥æ—¥å‡ºåŒ—1-8-4", lat: 34.68056, lng: 135.45000 },
                    { id: 5, name: "ä¸­å¤®åŒºå½¹æ‰€", address: "ä¸­å¤®åŒºä¹…å¤ªéƒç”º1-2-27", lat: 34.68028, lng: 135.51583 },
                    { id: 6, name: "è¥¿åŒºå½¹æ‰€", address: "è¥¿åŒºæ–°ç”º4-5-14", lat: 34.67528, lng: 135.48639 },
                    { id: 7, name: "æ¸¯åŒºå½¹æ‰€", address: "æ¸¯åŒºå¸‚å²¡1-15-25", lat: 34.66583, lng: 135.46667 },
                    { id: 8, name: "å¤§æ­£åŒºå½¹æ‰€", address: "å¤§æ­£åŒºåƒå³¶3-18-21", lat: 34.64694, lng: 135.47278 },
                    { id: 9, name: "å¤©ç‹å¯ºåŒºå½¹æ‰€", address: "å¤©ç‹å¯ºåŒºçœŸæ³•é™¢ç”º20-33", lat: 34.65806, lng: 135.52028 },
                    { id: 10, name: "æµªé€ŸåŒºå½¹æ‰€", address: "æµªé€ŸåŒºæ•·æ´¥æ±1-4-20", lat: 34.65472, lng: 135.50194 },
                    { id: 11, name: "è¥¿æ·€å·åŒºå½¹æ‰€", address: "è¥¿æ·€å·åŒºå¾¡å¹£å³¶1-2-10", lat: 34.71139, lng: 135.45194 },
                    { id: 12, name: "æ·€å·åŒºå½¹æ‰€", address: "æ·€å·åŒºåä¸‰æ±2-3-3", lat: 34.72222, lng: 135.47611 },
                    { id: 13, name: "æ±æ·€å·åŒºå½¹æ‰€", address: "æ±æ·€å·åŒºè±Šæ–°2-1-4", lat: 34.74611, lng: 135.52111 },
                    { id: 14, name: "æ±æˆåŒºå½¹æ‰€", address: "æ±æˆåŒºå¤§ä»Šé‡Œè¥¿2-8-4", lat: 34.67111, lng: 135.54306 },
                    { id: 15, name: "ç”Ÿé‡åŒºå½¹æ‰€", address: "ç”Ÿé‡åŒºå‹å±±å—3-1-19", lat: 34.64917, lng: 135.53806 },
                    { id: 16, name: "æ—­åŒºå½¹æ‰€", address: "æ—­åŒºå¤§å®®1-1-17", lat: 34.72139, lng: 135.54028 },
                    { id: 17, name: "åŸæ±åŒºå½¹æ‰€", address: "åŸæ±åŒºä¸­å¤®3-5-45", lat: 34.69556, lng: 135.55583 },
                    { id: 18, name: "é¶´è¦‹åŒºå½¹æ‰€", address: "é¶´è¦‹åŒºæ¨ªå ¤5-4-19", lat: 34.70944, lng: 135.58139 },
                    { id: 19, name: "é˜¿å€é‡åŒºå½¹æ‰€", address: "é˜¿å€é‡åŒºæ–‡ã®é‡Œ1-1-40", lat: 34.63722, lng: 135.51917 },
                    { id: 20, name: "ä½ä¹‹æ±ŸåŒºå½¹æ‰€", address: "ä½ä¹‹æ±ŸåŒºå¾¡å´3-1-17", lat: 34.61222, lng: 135.47028 },
                    { id: 21, name: "ä½å‰åŒºå½¹æ‰€", address: "ä½å‰åŒºå—ä½å‰3-15-55", lat: 34.60056, lng: 135.50667 },
                    { id: 22, name: "æ±ä½å‰åŒºå½¹æ‰€", address: "æ±ä½å‰åŒºæ±ç”°è¾º1-13-4", lat: 34.61889, lng: 135.52167 },
                    { id: 23, name: "å¹³é‡åŒºå½¹æ‰€", address: "å¹³é‡åŒºèƒŒæˆ¸å£3-8-19", lat: 34.62028, lng: 135.55389 },
                    { id: 24, name: "è¥¿æˆåŒºå½¹æ‰€", address: "è¥¿æˆåŒºå²¸é‡Œ1-5-20", lat: 34.63917, lng: 135.49944 }
                ]
            }
        };

        // ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
        const missions = [
            { emoji: 'ğŸªœ', text: 'æ„å‘³ã®ãªã„éšæ®µã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã©ã“ã«ã‚‚è¡Œã‹ãªã„ç´”ç²‹éšæ®µã‚’æ¢ã—ã¦ã¿ã‚ˆã†' },
            { emoji: 'ğŸšª', text: 'é–‹ã‹ãªã„æ‰‰ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'å£ã®ä¸­ã®ãƒ‰ã‚¢ã€2éšã®å®™ã¶ã‚‰ã‚Šã‚“ãƒ‰ã‚¢ãªã©' },
            { emoji: 'ğŸªŸ', text: 'å¡ãŒã‚ŒãŸçª“ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ¬ãƒ³ã‚¬ã‚„ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã§å¡ãŒã‚ŒãŸçª“æ ' },
            { emoji: 'ğŸ—ï¸', text: 'å·¥äº‹ç¾å ´ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ä½•ãŒã§ãã‚‹ï¼ŸåŠå¹´å¾Œã«æ¥ã¦ã¿ã‚ˆã†' },
            { emoji: 'ğŸšï¸', text: 'å»ƒå¢Ÿã£ã½ã„å»ºç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'æ™‚ãŒæ­¢ã¾ã£ãŸå ´æ‰€' },
            { emoji: 'âœï¸', text: 'æ‰‹æ›¸ãã®çœ‹æ¿ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'åº—ä¸»ã®äººæŸ„ãŒå‡ºã‚‹' },
            { emoji: 'ğŸ®', text: 'æ˜­å’Œã®é›°å›²æ°—ã®çœ‹æ¿ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ›ãƒ¼ãƒ­ãƒ¼çœ‹æ¿ã€å¤ã„å­—ä½“' },
            { emoji: 'â­•', text: 'é¢ç™½ã„ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ‡ã‚¶ã‚¤ãƒ³ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã€ã”å½“åœ°æŸ„' },
            { emoji: 'ğŸŒ±', text: 'éš™é–“ã®æ¤ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã‚¢ã‚¹ãƒ•ã‚¡ãƒ«ãƒˆã®å‰²ã‚Œç›®ã‹ã‚‰' },
            { emoji: 'ğŸ¦', text: 'é³¥ã®å·£ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'çœ‹æ¿ã®è£ã€è»’ä¸‹ãªã©' },
            { emoji: 'ğŸŒˆ', text: 'åŒã˜è‰²ãŒ3ã¤ä¸¦ã‚“ã§ã„ã‚‹å ´æ‰€ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'å¶ç„¶ã®é…è‰²ã‚’æ¥½ã—ã‚€' },
            { emoji: 'ğŸ”€', text: 'ä¸‰å‰è·¯ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'Yå­—è·¯ã€ã©ã£ã¡ã«è¡Œãï¼Ÿ' },
            { emoji: 'â›©ï¸', text: 'è¦‹ã‹ã‘ãŸç¥ç¤¾ã®ç”±æ¥ã‚’èª¿ã¹ã‚ˆã†', hint: 'ç¥€ã‚‰ã‚Œã¦ã„ã‚‹ã®ã¯èª°ï¼Ÿ' },
            { emoji: 'ğŸ—¿', text: 'çŸ³ç¢‘ã®æ–‡å­—ã‚’èª­ã‚“ã§ã¿ã‚ˆã†', hint: 'ä½•ãŒæ›¸ã„ã¦ã‚ã‚‹ï¼Ÿ' },
            { emoji: 'ğŸ‘‚', text: 'è€³ã‚’æ¾„ã¾ã—ã¦éŸ³ã‚’èã“ã†', hint: 'é³¥ã€æ°´ã€é¢¨ã€è¡—ã®éŸ³' }
        ];

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        showMainScreen();
                    },
                    (error) => {
                        alert('ä½ç½®æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                );
            }
        }

        function showMainScreen() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            setTimeout(() => {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: userLocation,
                    zoom: 15
                });

                geocoder = new google.maps.Geocoder();
                initAutocomplete();

                new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: 'ç¾åœ¨åœ°',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                loadSavedDestinations();
                renderRallyList();
            }, 100);
        }

        // ========================================
        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        function setMode(mode) {
            currentMode = mode;
            
            const loopBtn = document.getElementById('loopModeBtn');
            const onewayBtn = document.getElementById('onewayModeBtn');
            const stampBtn = document.getElementById('stampModeBtn');
            
            // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
            loopBtn.className = 'p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 transition-all';
            onewayBtn.className = 'p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 transition-all';
            stampBtn.className = 'p-4 rounded-xl border-2 border-gray-200 hover:border-purple-500 transition-all';
            
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            const routeSection = document.getElementById('routeCreationSection');
            const stampSection = document.getElementById('stampRallySection');
            
            if (mode === 'loop') {
                loopBtn.className = 'p-4 rounded-xl border-2 border-green-500 bg-green-50 transition-all';
                routeSection.classList.remove('hidden');
                stampSection.classList.add('hidden');
                document.getElementById('destinationSection').classList.add('hidden');
                document.getElementById('createRouteBtn').textContent = 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰';
            } else if (mode === 'oneway') {
                onewayBtn.className = 'p-4 rounded-xl border-2 border-green-500 bg-green-50 transition-all';
                routeSection.classList.remove('hidden');
                stampSection.classList.add('hidden');
                document.getElementById('destinationSection').classList.remove('hidden');
                document.getElementById('createRouteBtn').textContent = 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ';
            } else if (mode === 'stamp') {
                stampBtn.className = 'p-4 rounded-xl border-2 border-purple-500 bg-purple-50 transition-all';
                routeSection.classList.add('hidden');
                stampSection.classList.remove('hidden');
                clearStampMarkers();
                renderRallyList();
            }

            // ãƒ«ãƒ¼ãƒˆé–¢é€£ã‚’ã‚¯ãƒªã‚¢
            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }
            document.getElementById('routeInfo').classList.add('hidden');
            document.getElementById('routeSwitch').classList.add('hidden');
        }

        // ========================================
        // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼æ©Ÿèƒ½
        // ========================================
        function renderRallyList(category = 'all') {
            const container = document.getElementById('rallyList');
            container.innerHTML = '';
            
            for (const [key, rally] of Object.entries(stampRallies)) {
                if (category !== 'all' && rally.category !== category) continue;
                
                const visited = JSON.parse(localStorage.getItem(`stamp_${key}`) || '[]');
                const progress = `${visited.length}/${rally.spots.length}`;
                const isComplete = visited.length === rally.spots.length;
                
                const card = document.createElement('div');
                card.className = `stamp-card p-4 rounded-xl border-2 cursor-pointer ${isComplete ? 'stamp-visited' : 'stamp-unvisited'}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="text-3xl">${rally.icon}</div>
                            <div>
                                <div class="font-bold">${rally.name}</div>
                                <div class="text-xs text-gray-600">${rally.description}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${isComplete ? 'text-green-600' : 'text-gray-600'}">${progress}</div>
                            ${isComplete ? '<div class="text-xs text-green-600">ğŸ† åˆ¶è¦‡ï¼</div>' : ''}
                        </div>
                    </div>
                `;
                card.onclick = () => openRallyDetail(key);
                container.appendChild(card);
            }
        }

        function filterByCategory(category) {
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('border-gray-200');
            });
            event.target.classList.add('active');
            event.target.classList.remove('border-gray-200');
            
            renderRallyList(category);
        }

        function openRallyDetail(rallyKey) {
            currentRallyKey = rallyKey;
            const rally = stampRallies[rallyKey];
            
            document.getElementById('rallyDetailTitle').textContent = `${rally.icon} ${rally.name}`;
            document.getElementById('rallyDetailDesc').textContent = rally.description;
            
            const visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
            document.getElementById('rallyProgress').textContent = `${visited.length}/${rally.spots.length} è¨ªå•æ¸ˆã¿`;
            
            renderSpotList(rallyKey);
            showSpotsOnMap(rallyKey);
            
            document.getElementById('rallyDetailSection').classList.remove('hidden');
        }

        function closeRallyDetail() {
            currentRallyKey = null;
            document.getElementById('rallyDetailSection').classList.add('hidden');
            clearStampMarkers();
            renderRallyList();
        }

        function renderSpotList(rallyKey, sortMode = 'default') {
            const rally = stampRallies[rallyKey];
            const visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
            const container = document.getElementById('spotList');
            container.innerHTML = '';
            
            let spots = [...rally.spots];
            
            // ã‚½ãƒ¼ãƒˆ
            if (sortMode === 'distance' && userLocation) {
                spots.sort((a, b) => {
                    const distA = calculateDistance(userLocation, { lat: a.lat, lng: a.lng });
                    const distB = calculateDistance(userLocation, { lat: b.lat, lng: b.lng });
                    return distA - distB;
                });
            } else if (sortMode === 'unvisited') {
                spots.sort((a, b) => {
                    const aVisited = visited.includes(a.id);
                    const bVisited = visited.includes(b.id);
                    if (aVisited === bVisited) return 0;
                    return aVisited ? 1 : -1;
                });
            }
            
            spots.forEach(spot => {
                const isVisited = visited.includes(spot.id);
                const distance = userLocation ? calculateDistance(userLocation, { lat: spot.lat, lng: spot.lng }) : null;
                
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl border-2 ${isVisited ? 'stamp-visited' : 'stamp-unvisited'}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">${isVisited ? 'âœ…' : 'â¬œ'}</span>
                                <span class="font-bold">${spot.name}</span>
                            </div>
                            ${spot.detail ? `<div class="text-sm text-gray-600 ml-7">${spot.detail}</div>` : ''}
                            ${spot.blessing ? `<div class="text-xs text-purple-600 ml-7">ğŸ™ ${spot.blessing}</div>` : ''}
                            ${distance !== null ? `<div class="text-xs text-gray-500 ml-7">ğŸ“ ${(distance * 1000).toFixed(0)}m</div>` : ''}
                        </div>
                        ${!isVisited ? `
                            <button onclick="checkIn('${rallyKey}', ${spot.id})" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600">
                                ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function sortSpots(mode) {
            currentSortMode = mode;
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active', 'bg-green-100'));
            event.target.classList.add('active', 'bg-green-100');
            renderSpotList(currentRallyKey, mode);
        }

        function showSpotsOnMap(rallyKey) {
            clearStampMarkers();
            
            const rally = stampRallies[rallyKey];
            const visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
            const bounds = new google.maps.LatLngBounds();
            
            if (userLocation) {
                bounds.extend(userLocation);
            }
            
            rally.spots.forEach(spot => {
                const isVisited = visited.includes(spot.id);
                const marker = new google.maps.Marker({
                    position: { lat: spot.lat, lng: spot.lng },
                    map: map,
                    title: spot.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: isVisited ? '#10b981' : '#ef4444',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div style="padding:8px;"><strong>${spot.name}</strong><br>${spot.detail || ''}<br>${isVisited ? 'âœ… è¨ªå•æ¸ˆã¿' : 'â¬œ æœªè¨ªå•'}</div>`
                });
                
                marker.addListener('click', () => infoWindow.open(map, marker));
                stampMarkers.push(marker);
                bounds.extend({ lat: spot.lat, lng: spot.lng });
            });
            
            map.fitBounds(bounds);
        }

        function clearStampMarkers() {
            stampMarkers.forEach(marker => marker.setMap(null));
            stampMarkers = [];
        }

        // ========================================
        // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆé‡è¤‡é€£å‹•å¯¾å¿œï¼‰
        // ========================================
        function checkIn(rallyKey, spotId) {
            if (!navigator.geolocation) {
                alert('ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    const rally = stampRallies[rallyKey];
                    const spot = rally.spots.find(s => s.id === spotId);
                    const spotPos = { lat: spot.lat, lng: spot.lng };
                    
                    const distance = calculateDistance(userPos, spotPos);
                    
                    if (distance <= 0.1) { // 100mä»¥å†…
                        // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æˆåŠŸ
                        let visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
                        if (!visited.includes(spotId)) {
                            visited.push(spotId);
                            localStorage.setItem(`stamp_${rallyKey}`, JSON.stringify(visited));
                        }
                        
                        // ä»–ã®ãƒ©ãƒªãƒ¼ã§é‡è¤‡ã™ã‚‹ã‚¹ãƒãƒƒãƒˆã‚’æ¤œå‡º
                        const overlaps = findOverlappingSpots(spot.name, spot.lat, spot.lng, rallyKey);
                        
                        // å…¨åˆ¶è¦‡ãƒã‚§ãƒƒã‚¯
                        const isComplete = visited.length === rally.spots.length;
                        
                        if (overlaps.length > 0) {
                            showOverlapDialog(spot.name, spot.blessing, overlaps, isComplete, rallyKey);
                        } else if (isComplete) {
                            showCompleteModal(rally.name);
                        } else {
                            showCheckinSuccess(spot.name, spot.blessing);
                        }
                        
                        openRallyDetail(rallyKey);
                    } else {
                        alert(`ã¾ã ${spot.name}ã‹ã‚‰${(distance * 1000).toFixed(0)}mé›¢ã‚Œã¦ã„ã¾ã™ã€‚\n100mä»¥å†…ã«è¿‘ã¥ã„ã¦ãã ã•ã„ã€‚`);
                    }
                },
                (error) => {
                    alert('ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            );
        }

        function findOverlappingSpots(spotName, spotLat, spotLng, currentRallyKey) {
            const overlaps = [];
            const baseSpotName = spotName.replace(/ï¼ˆ.*ï¼‰/g, '').replace(/\(.*\)/g, '');
            
            for (const [rallyKey, rally] of Object.entries(stampRallies)) {
                if (rallyKey === currentRallyKey) continue;
                
                for (const spot of rally.spots) {
                    const baseTargetName = spot.name.replace(/ï¼ˆ.*ï¼‰/g, '').replace(/\(.*\)/g, '');
                    const distance = calculateDistance(
                        { lat: spotLat, lng: spotLng },
                        { lat: spot.lat, lng: spot.lng }
                    );
                    
                    if (baseSpotName.includes(baseTargetName) || 
                        baseTargetName.includes(baseSpotName) ||
                        distance <= 0.05) {
                        
                        const visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
                        if (!visited.includes(spot.id)) {
                            overlaps.push({
                                rallyKey: rallyKey,
                                rallyName: rally.name,
                                rallyIcon: rally.icon,
                                spotId: spot.id,
                                spotName: spot.name,
                                spotDetail: spot.detail
                            });
                        }
                    }
                }
            }
            return overlaps;
        }

        function showOverlapDialog(spotName, blessing, overlaps, isComplete, currentRallyKey) {
            let checkboxes = overlaps.map((o, i) => `
                <label style="display:flex;align-items:center;padding:10px;background:#f5f5f5;border-radius:8px;margin:5px 0;cursor:pointer;">
                    <input type="checkbox" id="overlap_${i}" data-rally="${o.rallyKey}" data-spot="${o.spotId}" checked style="width:20px;height:20px;margin-right:10px;">
                    <div>
                        <div style="font-weight:bold;">${o.rallyIcon} ${o.rallyName}</div>
                        <div style="font-size:12px;color:#666;">${o.spotName}${o.spotDetail ? ' - ' + o.spotDetail : ''}</div>
                    </div>
                </label>
            `).join('');
            
            document.getElementById('checkinContent').innerHTML = `
                <div class="text-5xl mb-4">âœ…</div>
                <h2 class="text-xl font-bold mb-2">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æˆåŠŸï¼</h2>
                <p class="font-bold text-lg">${spotName}</p>
                ${blessing ? `<p class="text-purple-600 mt-2">ğŸ™ ${blessing}</p>` : ''}
                
                <div class="mt-4 p-4 bg-orange-50 rounded-xl text-left">
                    <p class="font-bold mb-2">ğŸ“ ã“ã®å ´æ‰€ã¯ä»–ã®ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã«ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ï¼š</p>
                    ${checkboxes}
                </div>
                
                <button onclick="applyOverlapCheckins(${isComplete}, '${currentRallyKey}')" class="w-full mt-4 py-3 bg-green-500 text-white rounded-xl font-bold">
                    é¸æŠã—ãŸãƒ©ãƒªãƒ¼ã‚‚è¨ªå•æ¸ˆã¿ã«ã™ã‚‹
                </button>
                <button onclick="closeCheckinModal();${isComplete ? `showCompleteModal(stampRallies['${currentRallyKey}'].name)` : ''}" class="w-full mt-2 py-3 bg-gray-200 rounded-xl font-bold">
                    ã“ã®ãƒ©ãƒªãƒ¼ã ã‘
                </button>
            `;
            document.getElementById('checkinModal').style.display = 'flex';
        }

        function applyOverlapCheckins(isComplete, currentRallyKey) {
            const checkboxes = document.querySelectorAll('#checkinContent input[type="checkbox"]:checked');
            let appliedCount = 0;
            let completedRallies = [];
            
            checkboxes.forEach(cb => {
                const rallyKey = cb.dataset.rally;
                const spotId = parseInt(cb.dataset.spot);
                
                let visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
                if (!visited.includes(spotId)) {
                    visited.push(spotId);
                    localStorage.setItem(`stamp_${rallyKey}`, JSON.stringify(visited));
                    appliedCount++;
                    
                    if (visited.length === stampRallies[rallyKey].spots.length) {
                        completedRallies.push(stampRallies[rallyKey].name);
                    }
                }
            });
            
            let resultHtml = `
                <div class="text-5xl mb-4">${completedRallies.length > 0 || isComplete ? 'ğŸ†' : 'âœ…'}</div>
                <h2 class="text-xl font-bold mb-2">${appliedCount}ä»¶ã®ãƒ©ãƒªãƒ¼ã«åæ˜ ã—ã¾ã—ãŸï¼</h2>
            `;
            
            if (isComplete) {
                completedRallies.unshift(stampRallies[currentRallyKey].name);
            }
            
            if (completedRallies.length > 0) {
                resultHtml += `
                    <div class="mt-4 p-4 bg-green-50 rounded-xl">
                        <p class="font-bold">ğŸ‰ å…¨åˆ¶è¦‡é”æˆï¼</p>
                        ${completedRallies.map(name => `<p>ãƒ»${name}</p>`).join('')}
                    </div>
                `;
            }
            
            resultHtml += `<button onclick="closeCheckinModal()" class="w-full mt-4 py-3 bg-green-500 text-white rounded-xl font-bold">é–‰ã˜ã‚‹</button>`;
            
            document.getElementById('checkinContent').innerHTML = resultHtml;
        }

        function showCheckinSuccess(spotName, blessing) {
            document.getElementById('checkinContent').innerHTML = `
                <div class="text-5xl mb-4">âœ…</div>
                <h2 class="text-xl font-bold mb-2">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æˆåŠŸï¼</h2>
                <p class="font-bold text-lg">${spotName}</p>
                ${blessing ? `<p class="text-purple-600 mt-2">ğŸ™ ${blessing}</p>` : ''}
                <button onclick="closeCheckinModal()" class="w-full mt-4 py-3 bg-green-500 text-white rounded-xl font-bold">é–‰ã˜ã‚‹</button>
            `;
            document.getElementById('checkinModal').style.display = 'flex';
        }

        function showCompleteModal(rallyName) {
            document.getElementById('checkinContent').innerHTML = `
                <div class="text-5xl mb-4">ğŸ†</div>
                <h2 class="text-xl font-bold mb-2">å…¨åˆ¶è¦‡ãŠã‚ã§ã¨ã†ï¼</h2>
                <p class="font-bold text-lg">${rallyName}</p>
                <p class="mt-2">ã™ã¹ã¦ã®ã‚¹ãƒãƒƒãƒˆã‚’è¨ªå•ã—ã¾ã—ãŸï¼</p>
                <div class="text-4xl mt-4">ğŸ‰ğŸŠğŸ‰</div>
                <button onclick="closeCheckinModal()" class="w-full mt-4 py-3 bg-green-500 text-white rounded-xl font-bold">é–‰ã˜ã‚‹</button>
            `;
            document.getElementById('checkinModal').style.display = 'flex';
        }

        function closeCheckinModal() {
            document.getElementById('checkinModal').style.display = 'none';
        }

        // è¿‘ãã®æœªè¨ªå•ã‚¹ãƒãƒƒãƒˆã¸ãƒ«ãƒ¼ãƒˆä½œæˆ
        function createRouteToNearestSpot() {
            if (!currentRallyKey || !userLocation) return;
            
            const rally = stampRallies[currentRallyKey];
            const visited = JSON.parse(localStorage.getItem(`stamp_${currentRallyKey}`) || '[]');
            
            const unvisitedSpots = rally.spots.filter(s => !visited.includes(s.id));
            
            if (unvisitedSpots.length === 0) {
                alert('ã™ã¹ã¦ã®ã‚¹ãƒãƒƒãƒˆã‚’è¨ªå•æ¸ˆã¿ã§ã™ï¼');
                return;
            }
            
            // æœ€ã‚‚è¿‘ã„æœªè¨ªå•ã‚¹ãƒãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹
            let nearest = null;
            let nearestDistance = Infinity;
            
            unvisitedSpots.forEach(spot => {
                const dist = calculateDistance(userLocation, { lat: spot.lat, lng: spot.lng });
                if (dist < nearestDistance) {
                    nearestDistance = dist;
                    nearest = spot;
                }
            });
            
            if (nearest) {
                // ç‰‡é“ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¦ç›®çš„åœ°ã‚’è¨­å®š
                setMode('oneway');
                selectDestination({
                    name: nearest.name,
                    lat: nearest.lat,
                    lng: nearest.lng
                });
                
                alert(`${nearest.name}ã¸ã®çµŒè·¯ã‚’ä½œæˆã—ã¾ã™ã€‚\nç›®æ¨™æ­©æ•°ã‚’è¨­å®šã—ã¦ã€Œãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
            }
        }

        // ========================================
        // ãƒ«ãƒ¼ãƒˆä½œæˆæ©Ÿèƒ½ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’ç¶­æŒï¼‰
        // ========================================
        function showRandomMission() {
            const randomIndex = Math.floor(Math.random() * missions.length);
            const mission = missions[randomIndex];
            
            document.getElementById('missionEmoji').textContent = mission.emoji;
            document.getElementById('missionText').textContent = mission.text;
            document.getElementById('missionHint').textContent = mission.hint || '';
            
            document.getElementById('missionDisplay').classList.remove('hidden');
        }

        function updateSteps(value) {
            currentSteps = parseInt(value);
            document.getElementById('stepsDisplay').textContent = currentSteps.toLocaleString();
            const distance = ((currentSteps * 0.7) / 1000).toFixed(1);
            document.getElementById('distanceDisplay').textContent = `æ­© (${distance}km)`;
            
            if (currentMode === 'oneway' && selectedDestination) {
                updateDestinationDisplay();
            }
        }

        function setSteps(value) {
            currentSteps = value;
            document.getElementById('stepsRange').value = value;
            updateSteps(value);
        }

        function initAutocomplete() {
            const input = document.getElementById('destAddress');
            
            const options = {
                componentRestrictions: { country: 'jp' },
                fields: ['formatted_address', 'geometry', 'name', 'place_id'],
                types: ['establishment', 'geocode']
            };

            autocomplete = new google.maps.places.Autocomplete(input, options);

            if (map) {
                autocomplete.bindTo('bounds', map);
            }

            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();

                if (!place.geometry || !place.geometry.location) {
                    autocompletePlace = null;
                    return;
                }

                autocompletePlace = {
                    name: place.name || place.formatted_address,
                    address: place.formatted_address,
                    location: {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    }
                };
            });
        }

        function loadSavedDestinations() {
            const destinations = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
            const container = document.getElementById('savedDestinations');
            container.innerHTML = '';
            
            if (destinations.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 py-2">ç™»éŒ²ã•ã‚ŒãŸç›®çš„åœ°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            destinations.forEach((dest, index) => {
                const button = document.createElement('button');
                button.className = 'w-full p-3 rounded-lg border-2 border-gray-200 hover:border-green-500 transition-all text-left relative';
                button.innerHTML = `
                    <div class="font-medium">${dest.name}</div>
                    <div class="text-xs text-gray-500 mt-1">${dest.address || 'ä½æ‰€ãªã—'}</div>
                    <button onclick="deleteDestination(${index}); event.stopPropagation();" class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-xl">&times;</button>
                `;
                button.onclick = () => selectDestination(dest);
                container.appendChild(button);
            });
        }

        function showAddDestination() {
            document.getElementById('addDestinationModal').classList.remove('hidden');
        }

        function closeAddDestination() {
            document.getElementById('addDestinationModal').classList.add('hidden');
            document.getElementById('destName').value = '';
            document.getElementById('destAddress').value = '';
            autocompletePlace = null;
        }

        async function saveDestination() {
            const name = document.getElementById('destName').value.trim();
            const addressInput = document.getElementById('destAddress').value.trim();
            
            if (!name) {
                alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!addressInput) {
                alert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (autocompletePlace) {
                const dest = {
                    name: name,
                    address: autocompletePlace.address,
                    lat: autocompletePlace.location.lat,
                    lng: autocompletePlace.location.lng
                };
                
                const destinations = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
                destinations.push(dest);
                localStorage.setItem('savedDestinations', JSON.stringify(destinations));
                
                selectDestination(dest);
                autocompletePlace = null;
                closeAddDestination();
                loadSavedDestinations();
                return;
            }
            
            try {
                const results = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: addressInput }, (results, status) => {
                        if (status === 'OK') resolve(results);
                        else reject(status);
                    });
                });
                
                const location = results[0].geometry.location;
                const dest = {
                    name: name,
                    address: results[0].formatted_address,
                    lat: location.lat(),
                    lng: location.lng()
                };
                
                const destinations = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
                destinations.push(dest);
                localStorage.setItem('savedDestinations', JSON.stringify(destinations));
                
                selectDestination(dest);
                closeAddDestination();
                loadSavedDestinations();
            } catch (error) {
                alert('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
        }

        async function useDestinationNow() {
            const addressInput = document.getElementById('destAddress').value.trim();
            
            if (!addressInput) {
                alert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (autocompletePlace) {
                selectDestination({
                    name: autocompletePlace.name,
                    address: autocompletePlace.address,
                    lat: autocompletePlace.location.lat,
                    lng: autocompletePlace.location.lng
                });
                autocompletePlace = null;
                closeAddDestination();
                return;
            }
            
            try {
                const results = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: addressInput }, (results, status) => {
                        if (status === 'OK') resolve(results);
                        else reject(status);
                    });
                });
                
                const location = results[0].geometry.location;
                selectDestination({
                    name: results[0].formatted_address,
                    address: results[0].formatted_address,
                    lat: location.lat(),
                    lng: location.lng()
                });
                closeAddDestination();
            } catch (error) {
                alert('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
        }

        function deleteDestination(index) {
            if (!confirm('ã“ã®ç›®çš„åœ°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const destinations = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
            destinations.splice(index, 1);
            localStorage.setItem('savedDestinations', JSON.stringify(destinations));
            
            if (selectedDestination && selectedDestination.index === index) {
                selectedDestination = null;
                document.getElementById('selectedDestinationDisplay').classList.add('hidden');
                if (destinationMarker) {
                    destinationMarker.setMap(null);
                    destinationMarker = null;
                }
            }
            
            loadSavedDestinations();
        }

        function selectDestination(dest) {
            selectedDestination = { ...dest };
            
            if (destinationMarker) {
                destinationMarker.setMap(null);
            }
            
            destinationMarker = new google.maps.Marker({
                position: { lat: dest.lat, lng: dest.lng },
                map: map,
                title: dest.name,
                animation: google.maps.Animation.DROP,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: '#EA4335',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                }
            });
            
            map.panTo({ lat: dest.lat, lng: dest.lng });
            updateDestinationDisplay();
        }

        function updateDestinationDisplay() {
            if (!selectedDestination) return;
            
            const directDistance = calculateDistance(userLocation, selectedDestination);
            const directSteps = Math.round((directDistance / 0.7) * 1000);
            const targetDistance = (currentSteps * 0.7) / 1000;
            const detourDistance = targetDistance - directDistance;
            
            document.getElementById('selectedDestinationName').textContent = selectedDestination.name;
            
            if (detourDistance > 0) {
                document.getElementById('selectedDestinationDistance').textContent = 
                    `ç›´ç·š: ${directDistance.toFixed(1)}km + å¯„ã‚Šé“: ${detourDistance.toFixed(1)}km`;
            } else {
                document.getElementById('selectedDestinationDistance').textContent = 
                    `ç›´ç·šè·é›¢: ${directDistance.toFixed(1)}kmï¼ˆè¨­å®šæ­©æ•°ã‚ˆã‚Šé•·ã„ãŸã‚æœ€çŸ­ãƒ«ãƒ¼ãƒˆï¼‰`;
            }
            
            document.getElementById('selectedDestinationDisplay').classList.remove('hidden');
        }

        function selectFromMap() {
            if (!map) return;
            
            isSelectingFromMap = true;
            document.getElementById('mapSelectBtn').textContent = 'ğŸ“ åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠä¸­...';
            document.getElementById('mapSelectBtn').classList.add('bg-green-100', 'text-green-700');
            
            let tempMarker = null;
            
            const listener = map.addListener('click', (e) => {
                if (tempMarker) tempMarker.setMap(null);
                
                const selectedLat = e.latLng.lat();
                const selectedLng = e.latLng.lng();
                
                selectedDestination = {
                    name: 'åœ°å›³ã§é¸æŠ',
                    lat: selectedLat,
                    lng: selectedLng
                };
                
                if (destinationMarker) destinationMarker.setMap(null);
                
                destinationMarker = new google.maps.Marker({
                    position: e.latLng,
                    map: map,
                    title: 'é¸æŠã—ãŸç›®çš„åœ°',
                    animation: google.maps.Animation.DROP,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#EA4335',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    }
                });
                
                updateDestinationDisplay();
                isSelectingFromMap = false;
                document.getElementById('mapSelectBtn').textContent = 'ğŸ—ºï¸ åœ°å›³ã‹ã‚‰é¸æŠï¼ˆãŠã™ã™ã‚ï¼‰';
                document.getElementById('mapSelectBtn').classList.remove('bg-green-100', 'text-green-700');
                google.maps.event.removeListener(listener);
                google.maps.event.removeListener(moveListener);
            });
            
            const moveListener = map.addListener('mousemove', (e) => {
                if (tempMarker) {
                    tempMarker.setPosition(e.latLng);
                } else {
                    tempMarker = new google.maps.Marker({
                        position: e.latLng,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: '#EA4335',
                            fillOpacity: 0.5,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        }
                    });
                }
            });
        }

        async function createRoute() {
            if (!map || !userLocation) {
                alert('åœ°å›³ãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“');
                return;
            }

            if (currentMode === 'oneway' && !selectedDestination) {
                alert('ç›®çš„åœ°ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const button = document.getElementById('createRouteBtn');
            button.disabled = true;
            button.textContent = currentMode === 'loop' ? 'â³ ãƒ«ãƒ¼ãƒˆä½œæˆä¸­...ï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰' : 'â³ ãƒ«ãƒ¼ãƒˆä½œæˆä¸­...';

            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }

            try {
                const targetDistance = (currentSteps * 0.7) / 1000;
                const avoidHighways = document.getElementById('avoidHighways').checked;

                if (currentMode === 'loop') {
                    allRoutes = [];
                    const routePromises = [];
                    const candidateCount = 6;

                    for (let i = 0; i < candidateCount; i++) {
                        const waypoints = generateWaypoints(userLocation, targetDistance, i * 1000);
                        
                        const promise = fetch('/api/directions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                origin: userLocation,
                                destination: userLocation,
                                waypoints: waypoints,
                                avoidHighways: avoidHighways,
                                optimizeWaypoints: false
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'OK' && data.routes && data.routes.length > 0) {
                                return data.routes[0];
                            }
                            return null;
                        });

                        routePromises.push(promise);
                    }

                    const routes = await Promise.all(routePromises);
                    const validRoutes = routes.filter(route => route !== null);

                    const scoredRoutes = validRoutes.map(route => {
                        const score = calculateRouteOverlapScore(route);
                        return { route, score };
                    });

                    scoredRoutes.sort((a, b) => a.score - b.score);
                    allRoutes = scoredRoutes.slice(0, 3).map(sr => sr.route);

                    if (allRoutes.length > 0) {
                        displayRoute(0);
                        if (allRoutes.length > 1) {
                            showRouteSelection();
                        } else {
                            document.getElementById('routeSwitch').classList.add('hidden');
                        }
                    } else {
                        alert('ãƒ«ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } else {
                    const directDistance = calculateDistance(userLocation, selectedDestination);
                    const detourDistance = targetDistance - directDistance;
                    
                    let waypoints = [];
                    if (detourDistance > 0) {
                        waypoints = generateDetourWaypoints(userLocation, selectedDestination, detourDistance);
                    }
                    
                    const response = await fetch('/api/directions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            origin: userLocation,
                            destination: selectedDestination,
                            waypoints: waypoints,
                            avoidHighways: avoidHighways,
                            optimizeWaypoints: false
                        })
                    });

                    const data = await response.json();

                    if (data.status === 'OK' && data.routes && data.routes.length > 0) {
                        allRoutes = [data.routes[0]];
                        displayRoute(0);
                        document.getElementById('routeSwitch').classList.add('hidden');
                    } else {
                        alert('ãƒ«ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || data.status));
                    }
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = currentMode === 'loop' ? 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰' : 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ';
            }
        }

        function calculateRouteOverlapScore(route) {
            const path = google.maps.geometry.encoding.decodePath(route.overview_polyline.points);
            const segmentSet = new Map();
            let overlapCount = 0;
            
            for (let i = 0; i < path.length - 1; i++) {
                const p1 = path[i];
                const p2 = path[i + 1];
                
                const key1 = `${p1.lat().toFixed(5)},${p1.lng().toFixed(5)}`;
                const key2 = `${p2.lat().toFixed(5)},${p2.lng().toFixed(5)}`;
                const segmentKey = key1 < key2 ? `${key1}-${key2}` : `${key2}-${key1}`;
                
                if (segmentSet.has(segmentKey)) {
                    overlapCount++;
                    segmentSet.set(segmentKey, segmentSet.get(segmentKey) + 1);
                } else {
                    segmentSet.set(segmentKey, 1);
                }
            }
            
            const totalSegments = path.length - 1;
            return totalSegments > 0 ? overlapCount / totalSegments : 0;
        }

        function generateDetourWaypoints(origin, destination, detourDistanceKm) {
            const waypoints = [];
            
            let numWaypoints;
            if (detourDistanceKm < 1.0) numWaypoints = 2;
            else if (detourDistanceKm < 2.0) numWaypoints = 3;
            else if (detourDistanceKm < 3.5) numWaypoints = 4;
            else if (detourDistanceKm < 5.0) numWaypoints = 5;
            else numWaypoints = 6;
            
            const radiusKm = detourDistanceKm / 2.0;
            const mainAngle = Math.atan2(destination.lng - origin.lng, destination.lat - origin.lat);
            const side = Math.random() > 0.5 ? 1 : -1;
            
            for (let i = 0; i < numWaypoints; i++) {
                const progress = 0.15 + (i / (numWaypoints - 1)) * 0.7;
                const baseLat = origin.lat + (destination.lat - origin.lat) * progress;
                const baseLng = origin.lng + (destination.lng - origin.lng) * progress;
                
                const detourFactor = Math.sin(Math.PI * (i + 1) / (numWaypoints + 1));
                const perpDistance = radiusKm * detourFactor * side;
                const perpAngle = mainAngle + Math.PI / 2;
                
                const lat = baseLat + (perpDistance / 111) * Math.cos(perpAngle);
                const lng = baseLng + (perpDistance / (111 * Math.cos(baseLat * Math.PI / 180))) * Math.sin(perpAngle);
                
                waypoints.push({ lat, lng });
            }
            
            return waypoints;
        }

        function displayRoute(routeIndex) {
            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }

            currentRoute = allRoutes[routeIndex];

            const path = google.maps.geometry.encoding.decodePath(currentRoute.overview_polyline.points);
            
            currentPolyline = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#22c55e',
                strokeOpacity: 1.0,
                strokeWeight: 5,
                map: map
            });

            const bounds = new google.maps.LatLngBounds();
            path.forEach(point => bounds.extend(point));
            map.fitBounds(bounds);

            let totalDistance = 0;
            let totalDuration = 0;

            currentRoute.legs.forEach(leg => {
                totalDistance += leg.distance.value;
                totalDuration += leg.duration.value;
            });

            totalRouteDistance = totalDistance;

            const distanceKm = (totalDistance / 1000).toFixed(1);
            const actualSteps = Math.round((totalDistance / 1000) / 0.7 * 1000);
            const timeMinutes = Math.round(totalDuration / 60);

            document.getElementById('routeDistance').textContent = distanceKm;
            document.getElementById('routeSteps').textContent = actualSteps.toLocaleString();
            document.getElementById('routeTime').textContent = timeMinutes;

            document.getElementById('routeInfo').classList.remove('hidden');
        }

        function showRouteSelection() {
            const routeSwitchContainer = document.getElementById('routeSwitchButtons');
            routeSwitchContainer.innerHTML = '';

            allRoutes.forEach((route, index) => {
                let totalDistance = 0;
                route.legs.forEach(leg => {
                    totalDistance += leg.distance.value;
                });

                const distanceKm = (totalDistance / 1000).toFixed(1);
                const actualSteps = Math.round((totalDistance / 1000) / 0.7 * 1000);

                const button = document.createElement('button');
                button.className = 'flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 hover:border-green-500 transition-all font-medium';
                button.innerHTML = `
                    <div class="text-center">
                        <div class="text-sm">ãƒ«ãƒ¼ãƒˆ${index + 1}</div>
                        <div class="text-xs text-gray-600 mt-1">${distanceKm}km Â· ${actualSteps.toLocaleString()}æ­©</div>
                    </div>
                `;
                button.onclick = () => {
                    displayRoute(index);
                    document.querySelectorAll('#routeSwitchButtons button').forEach(btn => {
                        btn.classList.remove('border-green-500', 'bg-green-50');
                        btn.classList.add('border-gray-200');
                    });
                    button.classList.add('border-green-500', 'bg-green-50');
                    button.classList.remove('border-gray-200');
                };

                routeSwitchContainer.appendChild(button);
            });

            const firstButton = routeSwitchContainer.querySelector('button');
            if (firstButton) {
                firstButton.classList.add('border-green-500', 'bg-green-50');
                firstButton.classList.remove('border-gray-200');
            }

            document.getElementById('routeSwitch').classList.remove('hidden');
        }

        function generateWaypoints(center, targetDistanceKm, seed = 0) {
            const waypoints = [];
            const timeSeed = (Date.now() % 1000 + seed) / 1000;
            
            const numWaypoints = 4;
            const radiusKm = targetDistanceKm / 7.45;
            const minDistanceBetweenWaypoints = radiusKm * 1.0;
            const startAngle = Math.random() * Math.PI * 2 + timeSeed * Math.PI;

            let attempts = 0;
            const maxAttempts = 50;

            while (waypoints.length < numWaypoints && attempts < maxAttempts) {
                const i = waypoints.length;
                const baseAngle = (Math.PI * 2 / numWaypoints) * i;
                const randomOffset = (Math.random() - 0.5) * 0.15;
                const angle = startAngle + baseAngle + randomOffset;
                const distance = radiusKm * (0.97 + Math.random() * 0.06);

                const lat = center.lat + (distance / 111) * Math.cos(angle);
                const lng = center.lng + (distance / (111 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle);

                const newWaypoint = { lat, lng };

                let tooClose = false;
                for (const existingWaypoint of waypoints) {
                    const dist = calculateDistance(existingWaypoint, newWaypoint);
                    if (dist < minDistanceBetweenWaypoints) {
                        tooClose = true;
                        break;
                    }
                }

                if (!tooClose) {
                    waypoints.push(newWaypoint);
                } else {
                    attempts++;
                }
            }

            if (waypoints.length < numWaypoints) {
                return generateWaypointsSimple(center, targetDistanceKm, seed);
            }

            return waypoints;
        }

        function generateWaypointsSimple(center, targetDistanceKm, seed = 0) {
            const waypoints = [];
            const timeSeed = (Date.now() % 1000 + seed) / 1000;
            const numWaypoints = 4;
            const radiusKm = targetDistanceKm / 7.45;
            const startAngle = Math.random() * Math.PI * 2 + timeSeed * Math.PI;

            for (let i = 0; i < numWaypoints; i++) {
                const baseAngle = (Math.PI * 2 / numWaypoints) * i;
                const randomOffset = (Math.random() - 0.5) * 0.15;
                const angle = startAngle + baseAngle + randomOffset;
                const distance = radiusKm * (0.97 + Math.random() * 0.06);

                const lat = center.lat + (distance / 111) * Math.cos(angle);
                const lng = center.lng + (distance / (111 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle);

                waypoints.push({ lat, lng });
            }

            return waypoints;
        }

        function calculateDistance(point1, point2) {
            const R = 6371;
            const dLat = (point2.lat - point1.lat) * Math.PI / 180;
            const dLng = (point2.lng - point1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function openInGoogleMaps() {
            if (!currentRoute || !userLocation) {
                alert('ã¾ãšãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }

            const waypoints = [];
            currentRoute.legs.forEach((leg, index) => {
                if (index < currentRoute.legs.length - 1) {
                    const loc = leg.end_location;
                    waypoints.push(`${loc.lat},${loc.lng}`);
                }
            });

            const origin = `${userLocation.lat},${userLocation.lng}`;
            let destination;
            
            if (currentMode === 'loop') {
                destination = origin;
            } else {
                destination = `${selectedDestination.lat},${selectedDestination.lng}`;
            }
            
            const waypointsParam = waypoints.join('|');
            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypointsParam}&travelmode=walking`;

            window.open(url, '_blank');
        }

        // ========================================
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        // ========================================
        function startNavigation() {
            if (!currentRoute) {
                alert('ãƒ«ãƒ¼ãƒˆã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }

            if (!navigator.geolocation) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
                return;
            }

            isNavigating = true;
            followMode = true;
            startPosition = { ...userLocation };

            enterNavigationMode();

            watchId = navigator.geolocation.watchPosition(
                updateCurrentPosition,
                handlePositionError,
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );

            document.getElementById('navStatus').textContent = 'ğŸ“ GPSè¿½è·¡ä¸­';
            document.getElementById('navStatus').className = 'text-sm text-green-600 font-medium';
        }

        function stopNavigation() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            isNavigating = false;

            if (currentPositionMarker) {
                currentPositionMarker.setMap(null);
                currentPositionMarker = null;
            }
            if (currentPositionCircle) {
                currentPositionCircle.setMap(null);
                currentPositionCircle = null;
            }

            exitNavigationMode();
        }

        function enterNavigationMode() {
            document.getElementById('modeSection').classList.add('hidden');
            document.getElementById('routeCreationSection').classList.add('hidden');
            document.getElementById('stampRallySection').classList.add('hidden');
            document.getElementById('routeSwitch').classList.add('hidden');
            document.getElementById('routeInfo').classList.add('hidden');

            document.getElementById('navModePanel').classList.remove('hidden');
            document.getElementById('map').classList.add('nav-mode');
            
            setTimeout(() => {
                google.maps.event.trigger(map, 'resize');
                if (userLocation) {
                    map.setCenter(userLocation);
                    map.setZoom(17);
                }
            }, 100);
        }

        function exitNavigationMode() {
            document.getElementById('modeSection').classList.remove('hidden');
            
            if (currentMode === 'stamp') {
                document.getElementById('stampRallySection').classList.remove('hidden');
            } else {
                document.getElementById('routeCreationSection').classList.remove('hidden');
            }
            
            if (allRoutes.length > 1) {
                document.getElementById('routeSwitch').classList.remove('hidden');
            }
            document.getElementById('routeInfo').classList.remove('hidden');

            document.getElementById('navModePanel').classList.add('hidden');
            document.getElementById('map').classList.remove('nav-mode');
            
            setTimeout(() => {
                google.maps.event.trigger(map, 'resize');
            }, 100);
        }

        function updateCurrentPosition(position) {
            const currentPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            if (currentPositionMarker) {
                currentPositionMarker.setPosition(currentPos);
            } else {
                currentPositionMarker = new google.maps.Marker({
                    position: currentPos,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    },
                    zIndex: 999
                });
            }

            if (currentPositionCircle) {
                currentPositionCircle.setCenter(currentPos);
            } else {
                currentPositionCircle = new google.maps.Circle({
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.4,
                    strokeWeight: 2,
                    fillColor: '#4285F4',
                    fillOpacity: 0.15,
                    map: map,
                    center: currentPos,
                    radius: position.coords.accuracy || 20,
                    zIndex: 998
                });
            }

            if (followMode) {
                map.panTo(currentPos);
            }

            updateNavigationStats(currentPos);
        }

        function handlePositionError(error) {
            console.error('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('navStatus').textContent = 'âš ï¸ GPSä¿¡å·ãŒå¼±ã„ã§ã™';
            document.getElementById('navStatus').className = 'text-sm text-yellow-600 font-medium';
        }

        function updateNavigationStats(currentPos) {
            const walkedDistance = calculateDistance(startPosition, currentPos);
            document.getElementById('navWalkedDistance').textContent = walkedDistance.toFixed(2);

            const remainingDistance = Math.max(0, (totalRouteDistance / 1000) - walkedDistance);
            document.getElementById('navRemainingDistance').textContent = remainingDistance.toFixed(2);
        }

        function toggleFollowMode() {
            followMode = document.getElementById('followModeToggle').checked;
        }
    </script>
</body>
</html>
