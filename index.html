<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Autocompleteã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .pac-container {
            z-index: 10000;
            font-family: inherit;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .pac-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-top: 1px solid #e5e7eb;
        }
        
        .pac-item:hover {
            background-color: #f3f4f6;
        }
        
        .pac-item-query {
            font-weight: 600;
            color: #1f2937;
        }
        
        .pac-icon {
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 min-h-screen">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">ğŸš¶â€â™‚ï¸ ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
            <div class="mb-6">
                <label class="block text-sm font-bold mb-3 text-gray-700">ãƒ¢ãƒ¼ãƒ‰é¸æŠ</label>
                <div class="flex gap-4">
                    <button id="roundTripBtn" class="flex-1 px-6 py-3 rounded-xl font-semibold transition-all bg-blue-500 text-white shadow-lg">
                        ğŸ”„ å‘¨å›ãƒ¢ãƒ¼ãƒ‰
                    </button>
                    <button id="oneWayBtn" class="flex-1 px-6 py-3 rounded-xl font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300">
                        â¡ï¸ ç‰‡é“ãƒ¢ãƒ¼ãƒ‰
                    </button>
                </div>
            </div>

            <!-- æ­©æ•°å…¥åŠ› -->
            <div class="mb-6">
                <label for="steps" class="block text-sm font-bold mb-2 text-gray-700">ç›®æ¨™æ­©æ•°</label>
                <input type="number" id="steps" value="5000" min="1000" max="50000" step="100"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg">
            </div>

            <!-- ç‰‡é“ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨: ç›®çš„åœ°å…¥åŠ›ï¼ˆPlaces Autocompleteï¼‰ -->
            <div id="destinationSection" class="mb-6 hidden">
                <label for="destinationInput" class="block text-sm font-bold mb-2 text-gray-700">
                    ğŸ¯ ç›®çš„åœ°ã‚’æ¤œç´¢
                </label>
                <input type="text" id="destinationInput" placeholder="ä¾‹: å¤§é˜ªåŸå…¬åœ’ã€æ¢…ç”°é§…ã€é“é “å €"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg">
                <p class="mt-2 text-sm text-gray-500">
                    ğŸ’¡ æ–½è¨­åã€ä½æ‰€ã€é§…åãªã©ã‚’å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </p>
            </div>

            <!-- ãƒ«ãƒ¼ãƒˆä½œæˆãƒœã‚¿ãƒ³ -->
            <button id="createRouteBtn" 
                class="w-full bg-gradient-to-r from-blue-500 to-green-500 text-white py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition-all">
                âœ¨ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ
            </button>
        </div>

        <!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º -->
        <div id="missionCard" class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-3 text-purple-800">ğŸ¯ ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h2>
            <p id="missionText" class="text-lg text-gray-700"></p>
        </div>

        <!-- åœ°å›³è¡¨ç¤º -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
            <div id="map" class="w-full h-96"></div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒˆæƒ…å ± -->
        <div id="routeInfo" class="bg-white rounded-2xl shadow-xl p-6 hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“Š ãƒ«ãƒ¼ãƒˆæƒ…å ±</h2>
            <div id="routeDetails"></div>
        </div>
    </div>

    <script>
        let map;
        let directionsRenderer;
        let currentMode = 'roundTrip'; // 'roundTrip' or 'oneWay'
        let destinationPlace = null; // é¸æŠã•ã‚ŒãŸç›®çš„åœ°æƒ…å ±
        let autocomplete;

        // 70å€‹ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
        const missions = [
            "è¦‹ã‹ã‘ãŸèŠ±ã®åå‰ã‚’èª¿ã¹ã‚ˆã†",
            "è¦‹ã‹ã‘ãŸé³¥ã®åå‰ã‚’èª¿ã¹ã‚ˆã†",
            "æ°—ã«ãªã‚‹å»ºç‰©ã®æ­´å²ã‚’èª¿ã¹ã‚ˆã†",
            "è¦‹ã‹ã‘ãŸç¥ç¤¾ã®ç”±æ¥ã‚’èª¿ã¹ã‚ˆã†",
            "è¦‹ã‹ã‘ãŸæ©‹ã®åå‰ã®ç”±æ¥ã‚’èª¿ã¹ã‚ˆã†",
            "æ°—ã«ãªã‚‹å»ºç‰©ã®éå»ã‚’æƒ³åƒã—ã‚ˆã†",
            "é“ç«¯ã®çœ‹æ¿ã®æ–‡å­—ã‚’é›†ã‚ã¦è¨€è‘‰ã‚’ä½œã‚ã†",
            "æ„å‘³ã®ãªã„éšæ®µã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "çŒ«ã‚’3åŒ¹è¦‹ã¤ã‘ã‚ˆã†",
            "é¢ç™½ã„å½¢ã®é›²ã‚’æ¢ãã†",
            "èª°ã‹ã®ç¬‘é¡”ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ãã‚Œã„ãªçŸ³ã‚’æ‹¾ãŠã†",
            "å¤‰ã‚ã£ãŸåå‰ã®ãŠåº—ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "å¤ã„è‡ªå‹•è²©å£²æ©Ÿã‚’æ¢ãã†",
            "å£ã®è½æ›¸ãã‚¢ãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "å­£ç¯€ã‚’æ„Ÿã˜ã‚‹ã‚‚ã®ã‚’3ã¤è¦‹ã¤ã‘ã‚ˆã†",
            "ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªéƒµä¾¿ãƒã‚¹ãƒˆã‚’æ¢ãã†",
            "æœ¨ã®å½±ã®å½¢ã‚’è¦³å¯Ÿã—ã‚ˆã†",
            "ãƒ¬ãƒˆãƒ­ãªå»ºç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "è‰²ã¨ã‚Šã©ã‚Šã®èŠ±å£‡ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "è·¯åœ°è£ã®éš ã‚Œå®¶ã‚«ãƒ•ã‚§ã‚’æ¢ãã†",
            "é¢ç™½ã„è»Šã®ãƒŠãƒ³ãƒãƒ¼ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "å…¬åœ’ã®ãƒ™ãƒ³ãƒã«åº§ã£ã¦ä¼‘æ†©ã—ã‚ˆã†",
            "çŠ¬ã®æ•£æ­©ã‚’ã—ã¦ã„ã‚‹äººã«æŒ¨æ‹¶ã—ã‚ˆã†",
            "é³¥ã®ã•ãˆãšã‚Šã«è€³ã‚’å‚¾ã‘ã‚ˆã†",
            "å‚é“ã‚’ç™»ã‚Šãã‚ã†",
            "çŸ¥ã‚‰ãªã„é“ã‚’1æœ¬é€šã£ã¦ã¿ã‚ˆã†",
            "åœ°å…ƒã®æ²ç¤ºæ¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†",
            "å°ã•ãªç¥ç¤¾ã‚„ãŠå¯ºã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "å•†åº—è¡—ã‚’æ­©ã„ã¦ã¿ã‚ˆã†",
            "å·ã‚„æ± ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "æ¡œã®æœ¨ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼ˆå­£ç¯€å•ã‚ãšï¼‰",
            "ç´…è‘‰ã—ã¦ã„ã‚‹æœ¨ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼ˆå­£ç¯€å•ã‚ãšï¼‰",
            "é¢ç™½ã„å½¢ã®è‘‰ã£ã±ã‚’æ‹¾ãŠã†",
            "ã©ã‚“ãã‚Šã‚„æ¾ã¼ã£ãã‚Šã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "è™«ã®éŸ³ã‚’èã“ã†",
            "å¤•ç„¼ã‘ã‚’è¦‹ã‚ˆã†ï¼ˆæ™‚é–“å¸¯ãŒåˆãˆã°ï¼‰",
            "æ˜Ÿç©ºã‚’è¦‹ä¸Šã’ã‚ˆã†ï¼ˆå¤œãªã‚‰ï¼‰",
            "æœˆã‚’æ¢ãã†",
            "é¢¨ã‚’æ„Ÿã˜ã‚ˆã†",
            "é›¨ä¸ŠãŒã‚Šã®æ°´ãŸã¾ã‚Šã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "è™¹ã‚’æ¢ãã†ï¼ˆé›¨ä¸ŠãŒã‚Šãªã‚‰ï¼‰",
            "éœ§ã‚’è¦³å¯Ÿã—ã‚ˆã†ï¼ˆæ¡ä»¶ãŒåˆãˆã°ï¼‰",
            "æœéœ²ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼ˆæ—©æœãªã‚‰ï¼‰",
            "æ—¥å‘ã¨æ—¥é™°ã®æ¸©åº¦å·®ã‚’æ„Ÿã˜ã‚ˆã†",
            "é¦™ã‚Šã®ã™ã‚‹æ¤ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "è‹”ã‚€ã—ãŸå ´æ‰€ã‚’æ¢ãã†",
            "ã¤ã‚‹æ¤ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "å››ã¤è‘‰ã®ã‚¯ãƒ­ãƒ¼ãƒãƒ¼ã‚’æ¢ãã†",
            "ã‚¿ãƒ³ãƒãƒã®ç¶¿æ¯›ã‚’å¹ã“ã†",
            "ã‚¢ãƒªã®è¡Œåˆ—ã‚’è¦³å¯Ÿã—ã‚ˆã†",
            "è¶ã€…ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ãƒˆãƒ³ãƒœã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ã‚»ãƒŸã®æŠœã‘æ®»ã‚’æ¢ãã†ï¼ˆå¤ãªã‚‰ï¼‰",
            "ã‚¯ãƒ¢ã®å·£ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "é³©ã®ç¾¤ã‚Œã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ã‚«ãƒ©ã‚¹ã‚’5ç¾½æ•°ãˆã‚ˆã†",
            "ã™ãšã‚ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ç™½ã„çŠ¬ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ä¸‰æ¯›çŒ«ã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "è‡ªè»¢è»Šã«ä¹—ã£ã¦ã„ã‚‹äººã‚’10äººæ•°ãˆã‚ˆã†",
            "ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼ã‚’æŠ¼ã—ã¦ã„ã‚‹äººã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ã‚¸ãƒ§ã‚®ãƒ³ã‚°ã—ã¦ã„ã‚‹äººã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "åŒã˜è‰²ã®æœã‚’ç€ãŸäººã‚’2äººè¦‹ã¤ã‘ã‚ˆã†",
            "å¸½å­ã‚’ã‹ã¶ã£ã¦ã„ã‚‹äººã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ã‚µãƒ³ã‚°ãƒ©ã‚¹ã‚’ã‹ã‘ã¦ã„ã‚‹äººã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ãƒã‚¹ã‚¯ã‚’ã—ã¦ã„ã‚‹äººã‚’10äººæ•°ãˆã‚ˆã†",
            "å‚˜ã‚’å·®ã—ã¦ã„ã‚‹äººã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "å¤§ããªè·ç‰©ã‚’æŒã£ã¦ã„ã‚‹äººã‚’è¦‹ã¤ã‘ã‚ˆã†",
            "ç¬‘é¡”ã§æŒ¨æ‹¶ã—ã‚ˆã†"
        ];

        // åœ°å›³åˆæœŸåŒ–
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: { lat: 34.6937, lng: 135.5023 }, // å¤§é˜ªåŸ
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true
            });

            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#3B82F6',
                    strokeWeight: 5
                }
            });

            // Places Autocompleteã®åˆæœŸåŒ–
            initAutocomplete();

            // ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦åœ°å›³ã®ä¸­å¿ƒã«è¨­å®š
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(pos);
                    },
                    () => {
                        console.log('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                );
            }
        }

        // Places Autocompleteã®åˆæœŸåŒ–
        function initAutocomplete() {
            const input = document.getElementById('destinationInput');
            
            // Autocompleteã‚ªãƒ—ã‚·ãƒ§ãƒ³
            const options = {
                componentRestrictions: { country: 'jp' }, // æ—¥æœ¬ã«é™å®š
                fields: ['formatted_address', 'geometry', 'name', 'place_id'],
                types: ['establishment', 'geocode'] // æ–½è¨­ã¨ä½æ‰€
            };

            autocomplete = new google.maps.places.Autocomplete(input, options);

            // åœ°å›³ã®è¡¨ç¤ºç¯„å›²ã‚’Autocompleteã«åæ˜ 
            autocomplete.bindTo('bounds', map);

            // å ´æ‰€ãŒé¸æŠã•ã‚ŒãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆ
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();

                if (!place.geometry || !place.geometry.location) {
                    alert('é¸æŠã•ã‚ŒãŸå ´æ‰€ã®ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // ç›®çš„åœ°æƒ…å ±ã‚’ä¿å­˜
                destinationPlace = {
                    name: place.name || place.formatted_address,
                    address: place.formatted_address,
                    location: {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    }
                };

                // åœ°å›³ã‚’ç›®çš„åœ°ã«ç§»å‹•
                map.setCenter(destinationPlace.location);
                map.setZoom(15);

                console.log('ç›®çš„åœ°ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', destinationPlace);
            });
        }

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('roundTripBtn').addEventListener('click', () => {
            currentMode = 'roundTrip';
            document.getElementById('roundTripBtn').className = 'flex-1 px-6 py-3 rounded-xl font-semibold transition-all bg-blue-500 text-white shadow-lg';
            document.getElementById('oneWayBtn').className = 'flex-1 px-6 py-3 rounded-xl font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
            document.getElementById('destinationSection').classList.add('hidden');
            destinationPlace = null;
        });

        document.getElementById('oneWayBtn').addEventListener('click', () => {
            currentMode = 'oneWay';
            document.getElementById('oneWayBtn').className = 'flex-1 px-6 py-3 rounded-xl font-semibold transition-all bg-green-500 text-white shadow-lg';
            document.getElementById('roundTripBtn').className = 'flex-1 px-6 py-3 rounded-xl font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
            document.getElementById('destinationSection').classList.remove('hidden');
        });

        // ãƒ«ãƒ¼ãƒˆä½œæˆ
        document.getElementById('createRouteBtn').addEventListener('click', async () => {
            const steps = parseInt(document.getElementById('steps').value);

            if (steps < 1000 || steps > 50000) {
                alert('æ­©æ•°ã¯1000ã€œ50000ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (currentMode === 'oneWay' && !destinationPlace) {
                alert('ç›®çš„åœ°ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ç¾åœ¨åœ°ã‚’å–å¾—
            if (!navigator.geolocation) {
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async position => {
                    const origin = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    if (currentMode === 'roundTrip') {
                        await createRoundTripRoute(origin, steps);
                    } else {
                        await createOneWayRoute(origin, destinationPlace.location, steps);
                    }

                    // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º
                    displayRandomMission();
                },
                () => {
                    alert('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚');
                }
            );
        });

        // å‘¨å›ãƒ«ãƒ¼ãƒˆç”Ÿæˆ
        async function createRoundTripRoute(origin, steps) {
            const distanceKm = steps * 0.0007; // æ­©æ•°â†’è·é›¢å¤‰æ›
            const waypoints = generateCircularWaypoints(origin, distanceKm, 4);

            try {
                const response = await fetch('/api/directions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        origin: origin,
                        destination: origin,
                        waypoints: waypoints
                    })
                });

                const data = await response.json();
                
                if (data.status === 'OK') {
                    directionsRenderer.setDirections(data);
                    displayRouteInfo(data, 'å‘¨å›ãƒ¢ãƒ¼ãƒ‰');
                } else {
                    alert('ãƒ«ãƒ¼ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.status);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ãƒ«ãƒ¼ãƒˆã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ç‰‡é“ãƒ«ãƒ¼ãƒˆç”Ÿæˆ
        async function createOneWayRoute(origin, destination, steps) {
            const directDistance = getDistance(origin, destination);
            const targetDistanceKm = steps * 0.0007;
            const detourDistanceKm = targetDistanceKm - directDistance;

            if (detourDistanceKm <= 0) {
                alert(`ç›®çš„åœ°ã¾ã§ç›´ç·šè·é›¢ã§ç´„${Math.round(directDistance * 1.43 / 0.0007)}æ­©ã‹ã‹ã‚Šã¾ã™ã€‚è¨­å®šæ­©æ•°ãŒå°‘ãªã™ãã¾ã™ã€‚`);
                return;
            }

            const waypoints = generateDetourWaypoints(origin, destination, detourDistanceKm);

            try {
                const response = await fetch('/api/directions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        origin: origin,
                        destination: destination,
                        waypoints: waypoints
                    })
                });

                const data = await response.json();
                
                if (data.status === 'OK') {
                    directionsRenderer.setDirections(data);
                    displayRouteInfo(data, `ç‰‡é“ãƒ¢ãƒ¼ãƒ‰ â†’ ${destinationPlace.name}`);
                } else {
                    alert('ãƒ«ãƒ¼ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.status);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ãƒ«ãƒ¼ãƒˆã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // å††å½¢ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆç”Ÿæˆ
        function generateCircularWaypoints(center, radiusKm, numPoints) {
            const waypoints = [];
            const adjustedRadius = radiusKm / 7.45;

            for (let i = 0; i < numPoints; i++) {
                const angle = (i * 2 * Math.PI) / numPoints;
                const lat = center.lat + (adjustedRadius / 111) * Math.cos(angle);
                const lng = center.lng + (adjustedRadius / (111 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle);
                waypoints.push({ lat, lng });
            }

            return waypoints;
        }

        // å¯„ã‚Šé“ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆç”Ÿæˆ
        function generateDetourWaypoints(start, end, detourDistanceKm) {
            const waypoints = [];
            const numWaypoints = Math.min(Math.max(Math.floor(detourDistanceKm / 0.5), 2), 6);
            
            const radiusKm = detourDistanceKm / 7.0;
            const midLat = (start.lat + end.lat) / 2;
            const midLng = (start.lng + end.lng) / 2;
            
            const dx = end.lng - start.lng;
            const dy = end.lat - start.lat;
            const length = Math.sqrt(dx * dx + dy * dy);
            const perpDx = -dy / length;
            const perpDy = dx / length;

            for (let i = 0; i < numWaypoints; i++) {
                const t = (i + 1) / (numWaypoints + 1);
                const baseLat = start.lat + t * (end.lat - start.lat);
                const baseLng = start.lng + t * (end.lng - start.lng);
                
                const side = i % 2 === 0 ? 1 : -1;
                const detourFactor = 1 - Math.abs(2 * t - 1);
                const perpDistance = radiusKm * detourFactor * side;
                
                const lat = baseLat + perpDistance * perpDy / 111;
                const lng = baseLng + perpDistance * perpDx / (111 * Math.cos(baseLat * Math.PI / 180));
                
                waypoints.push({ lat, lng });
            }

            return waypoints;
        }

        // 2ç‚¹é–“ã®è·é›¢è¨ˆç®—ï¼ˆkmï¼‰
        function getDistance(point1, point2) {
            const R = 6371;
            const dLat = (point2.lat - point1.lat) * Math.PI / 180;
            const dLon = (point2.lng - point1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º
        function displayRandomMission() {
            const randomMission = missions[Math.floor(Math.random() * missions.length)];
            document.getElementById('missionText').textContent = randomMission;
            document.getElementById('missionCard').classList.remove('hidden');
        }

        // ãƒ«ãƒ¼ãƒˆæƒ…å ±è¡¨ç¤º
        function displayRouteInfo(result, mode) {
            const route = result.routes[0];
            const leg = route.legs[0];

            const distanceKm = leg.distance.value / 1000;
            const estimatedSteps = Math.round(distanceKm / 0.0007);

            let html = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-xl">
                        <p class="text-sm text-gray-600">ãƒ¢ãƒ¼ãƒ‰</p>
                        <p class="text-xl font-bold text-blue-600">${mode}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl">
                        <p class="text-sm text-gray-600">è·é›¢</p>
                        <p class="text-2xl font-bold text-green-600">${leg.distance.text}</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl">
                        <p class="text-sm text-gray-600">äºˆæƒ³æ­©æ•°</p>
                        <p class="text-2xl font-bold text-purple-600">ç´„ ${estimatedSteps.toLocaleString()} æ­©</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-xl">
                        <p class="text-sm text-gray-600">æ‰€è¦æ™‚é–“</p>
                        <p class="text-2xl font-bold text-orange-600">${leg.duration.text}</p>
                    </div>
                </div>
            `;

            document.getElementById('routeDetails').innerHTML = html;
            document.getElementById('routeInfo').classList.remove('hidden');
        }

        // Google Maps APIèª­ã¿è¾¼ã¿å¾Œã«åˆæœŸåŒ–
        window.initMap = initMap;
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYFFfCe_7Ry15jh7J1n8gw7fF4JLJohxE&libraries=places&callback=initMap&language=ja" async defer></script>
</body>
</html>
