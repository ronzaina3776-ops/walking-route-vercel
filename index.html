<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; width: 100%; }
        @media (max-width: 640px) {
            #map { height: 400px; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-4">
    
    <!-- é–‹å§‹ç”»é¢ -->
    <div id="startScreen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="bg-green-500 p-4 rounded-2xl inline-block mb-4">
                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold mb-2">ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>
                <p class="text-gray-500">æ•£æ­©ã‚³ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
            </div>
            
            <button onclick="getLocation()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl hover:bg-green-600 transition-colors">
                ğŸ“ ç¾åœ¨åœ°ã‚’ä½¿ã†
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="max-w-4xl mx-auto space-y-6 hidden">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div>
                <h1 class="text-2xl font-bold">ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>
                <p class="text-sm text-gray-500">Google Mapsç‰ˆ</p>
            </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="font-medium mb-3">ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h2>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="setMode('loop')" id="loopModeBtn" class="p-4 rounded-xl border-2 border-green-500 bg-green-50 transition-all">
                    <div class="text-2xl mb-2">ğŸ”„</div>
                    <div class="font-bold">å‘¨å›ãƒ¢ãƒ¼ãƒ‰</div>
                    <div class="text-xs text-gray-600 mt-1">ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«æˆ»ã‚‹</div>
                </button>
                <button onclick="setMode('oneway')" id="onewayModeBtn" class="p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 transition-all">
                    <div class="text-2xl mb-2">â¡ï¸</div>
                    <div class="font-bold">ç‰‡é“ãƒ¢ãƒ¼ãƒ‰</div>
                    <div class="text-xs text-gray-600 mt-1">ç›®çš„åœ°ã¾ã§å¯„ã‚Šé“</div>
                </button>
            </div>
        </div>

        <!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="font-medium mb-3">ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h2>
            <button onclick="showRandomMission()" class="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold hover:shadow-xl transition-all text-lg">
                ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹
            </button>
            
            <!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="missionDisplay" class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl hidden">
                <div class="text-center">
                    <div id="missionEmoji" class="text-5xl mb-3">ğŸªœ</div>
                    <div id="missionText" class="text-lg font-bold text-gray-800 mb-2">æ„å‘³ã®ãªã„éšæ®µã‚’è¦‹ã¤ã‘ã‚ˆã†</div>
                    <div id="missionHint" class="text-sm text-gray-600 mb-4">ã©ã“ã«ã‚‚è¡Œã‹ãªã„ç´”ç²‹éšæ®µã‚’æ¢ã—ã¦ã¿ã‚ˆã†</div>
                    <button onclick="showRandomMission()" class="px-4 py-2 bg-white rounded-lg text-purple-600 font-medium hover:bg-purple-50 transition-all">
                        ğŸ”„ åˆ¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- ç‰‡é“ãƒ¢ãƒ¼ãƒ‰: ç›®çš„åœ°é¸æŠ -->
        <div id="destinationSection" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <h2 class="font-medium mb-3">ğŸ“ ç›®çš„åœ°</h2>
            
            <!-- åœ°å›³ã‹ã‚‰é¸æŠï¼ˆä¸€ç•ªä¸Šã«ï¼‰ -->
            <button onclick="selectFromMap()" id="mapSelectBtn" class="w-full mb-4 py-4 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition-all text-lg">
                ğŸ—ºï¸ åœ°å›³ã‹ã‚‰é¸æŠï¼ˆãŠã™ã™ã‚ï¼‰
            </button>
            
            <!-- ç™»éŒ²æ¸ˆã¿ç›®çš„åœ° -->
            <div class="mb-3">
                <div class="text-sm font-medium text-gray-600 mb-2">ç™»éŒ²æ¸ˆã¿ã®ç›®çš„åœ°:</div>
                <div id="savedDestinations" class="space-y-2">
                    <!-- ç™»éŒ²åœ°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
            
            <!-- æ–°ã—ã„ç›®çš„åœ°ã‚’è¿½åŠ  -->
            <button onclick="showAddDestination()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-green-500 hover:text-green-600 transition-all text-sm">
                ï¼‹ ã¾ãŸã¯ä½æ‰€ã§è¿½åŠ 
            </button>
            
            <!-- é¸æŠä¸­ã®ç›®çš„åœ° -->
            <div id="selectedDestinationDisplay" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
                <div class="text-sm text-gray-600">é¸æŠä¸­ã®ç›®çš„åœ°:</div>
                <div id="selectedDestinationName" class="font-bold text-lg"></div>
                <div id="selectedDestinationDistance" class="text-sm text-gray-600 mt-1"></div>
            </div>
        </div>

        <!-- æ­©æ•°è¨­å®š -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="font-medium mb-3">ç›®æ¨™æ­©æ•°</h2>
            <div class="flex items-center gap-4">
                <input type="range" id="stepsRange" min="1000" max="20000" step="500" value="5000" 
                    class="flex-1 h-2 bg-gray-200 rounded-lg cursor-pointer accent-green-500"
                    oninput="updateSteps(this.value)">
                <div class="text-right min-w-32">
                    <div id="stepsDisplay" class="text-3xl font-bold text-green-600">5,000</div>
                    <div id="distanceDisplay" class="text-sm text-gray-500">æ­© (3.5km)</div>
                </div>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button onclick="setSteps(3000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">3åƒæ­©</button>
                <button onclick="setSteps(5000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">5åƒæ­©</button>
                <button onclick="setSteps(10000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">1ä¸‡æ­©</button>
            </div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒˆè¨­å®š -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="font-medium mb-3">ãƒ«ãƒ¼ãƒˆè¨­å®š</h2>
            <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="avoidHighways" checked class="w-5 h-5 accent-green-500">
                <span class="text-gray-700">å¤§é€šã‚Šãƒ»å¹¹ç·šé“è·¯ã‚’é¿ã‘ã‚‹</span>
            </label>
        </div>

        <!-- ãƒ«ãƒ¼ãƒˆä½œæˆãƒœã‚¿ãƒ³ -->
        <button onclick="createRoute()" id="createRouteBtn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition-all">
            ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰
        </button>

        <!-- åœ°å›³ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-lg font-bold mb-4">ğŸ“ åœ°å›³</h2>
            <div id="map" class="rounded-xl border-2 border-gray-200"></div>
            
            <!-- ãƒ«ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ï¼ˆåœ°å›³ã®ã™ãä¸‹ï¼‰ -->
            <div id="routeSwitch" class="mt-4 hidden">
                <div class="text-sm font-medium text-gray-600 mb-2">ãƒ«ãƒ¼ãƒˆã‚’é¸æŠ:</div>
                <div id="routeSwitchButtons" class="flex gap-2">
                    <!-- ãƒ«ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒˆæƒ…å ±ï¼ˆè©³ç´°ï¼‰ -->
        <div id="routeInfo" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <h2 class="text-lg font-bold mb-4">ğŸ“Š ãƒ«ãƒ¼ãƒˆæƒ…å ±</h2>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-green-50 p-4 rounded-xl text-center">
                    <div id="routeDistance" class="text-2xl font-bold text-green-600">0</div>
                    <div class="text-sm text-gray-600">km</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl text-center">
                    <div id="routeSteps" class="text-2xl font-bold text-blue-600">0</div>
                    <div class="text-sm text-gray-600">æ­©</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl text-center">
                    <div id="routeTime" class="text-2xl font-bold text-purple-600">0</div>
                    <div class="text-sm text-gray-600">åˆ†</div>
                </div>
            </div>

            <!-- çµŒç”±åœ°æƒ…å ±ï¼ˆPhase 2è¿½åŠ ï¼‰ -->
            <div id="waypointsInfo" class="mt-4">
                <h3 class="text-sm font-medium text-gray-600 mb-2">ğŸ“ çµŒç”±åœ°:</h3>
                <div id="waypointsList" class="space-y-2">
                    <!-- çµŒç”±åœ°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>

            <button id="openInGoogleMaps" onclick="openInGoogleMaps()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition-colors">
                ğŸ“± Googleãƒãƒƒãƒ—ã§é–‹ã
            </button>
        </div>

    </div>

    <!-- ç›®çš„åœ°è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addDestinationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">æ–°ã—ã„ç›®çš„åœ°ã‚’è¿½åŠ </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åå‰</label>
                    <input type="text" id="destName" placeholder="ä¾‹: è‡ªå®…ã€è·å ´ã€ã‚«ãƒ•ã‚§" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-green-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä½æ‰€</label>
                    <input type="text" id="destAddress" placeholder="ä½æ‰€ã‚’å…¥åŠ›" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-green-500 outline-none">
                </div>
                
                <div class="text-sm text-gray-500">
                    ã¾ãŸã¯åœ°å›³ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddDestination()" class="flex-1 py-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 transition-all">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="saveDestination()" class="flex-1 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all">
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYFFfCe_7Ry15jh7J1n8gw7fF4JLJohxE&libraries=geometry,places"></script>
    <script>
        let map = null;
        let userLocation = null;
        let currentSteps = 5000;
        let currentRoute = null;
        let currentPolyline = null;
        let allRoutes = [];
        let currentMode = 'loop'; // 'loop' or 'oneway'
        let selectedDestination = null;
        let destinationMarker = null;
        let isSelectingFromMap = false;
        let geocoder = null;

        // ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
        const missions = [
            // ãƒˆãƒã‚½ãƒ³ãƒ»å»ºç¯‰ã®è¬ç³»
            { emoji: 'ğŸªœ', text: 'æ„å‘³ã®ãªã„éšæ®µã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã©ã“ã«ã‚‚è¡Œã‹ãªã„ç´”ç²‹éšæ®µã‚’æ¢ã—ã¦ã¿ã‚ˆã†' },
            { emoji: 'ğŸšª', text: 'é–‹ã‹ãªã„æ‰‰ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'å£ã®ä¸­ã®ãƒ‰ã‚¢ã€2éšã®å®™ã¶ã‚‰ã‚Šã‚“ãƒ‰ã‚¢ãªã©' },
            { emoji: 'ğŸªŸ', text: 'å¡ãŒã‚ŒãŸçª“ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ¬ãƒ³ã‚¬ã‚„ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã§å¡ãŒã‚ŒãŸçª“æ ' },
            { emoji: 'ğŸ—ï¸', text: 'å·¥äº‹ç¾å ´ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ä½•ãŒã§ãã‚‹ï¼ŸåŠå¹´å¾Œã«æ¥ã¦ã¿ã‚ˆã†' },
            { emoji: 'ğŸšï¸', text: 'å»ƒå¢Ÿã£ã½ã„å»ºç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'æ™‚ãŒæ­¢ã¾ã£ãŸå ´æ‰€' },
            { emoji: 'ğŸ“¦', text: 'ãƒ–ãƒ«ãƒ¼ã‚·ãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ä½•ãŒéš ã•ã‚Œã¦ã„ã‚‹ï¼Ÿ' },
            { emoji: 'ğŸ§±', text: 'ä¸­é€”åŠç«¯ãªå£ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãªãœã“ã“ã§çµ‚ã‚ã‚‹ï¼Ÿ' },
            { emoji: 'ğŸª§', text: 'ä½¿ã‚ã‚Œã¦ã„ãªã„çœ‹æ¿ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'åº—ã¯ãªããªã£ãŸã®ã«çœ‹æ¿ã ã‘' },
            { emoji: 'ğŸš°', text: 'ä¸æ€è­°ãªé…ç®¡ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãªãœã“ã“ã«ï¼Ÿã©ã“ã¸ç¶šãï¼Ÿ' },
            
            // çœ‹æ¿ãƒ»æ–‡å­—ç³»
            { emoji: 'âœï¸', text: 'æ‰‹æ›¸ãã®çœ‹æ¿ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'åº—ä¸»ã®äººæŸ„ãŒå‡ºã‚‹' },
            { emoji: 'ğŸ®', text: 'æ˜­å’Œã®é›°å›²æ°—ã®çœ‹æ¿ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ›ãƒ¼ãƒ­ãƒ¼çœ‹æ¿ã€å¤ã„å­—ä½“' },
            { emoji: 'ğŸ˜‚', text: 'èª¤å­—ãƒ»è„±å­—ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãªãœèª°ã‚‚ç›´ã•ãªã„ï¼Ÿ' },
            { emoji: 'ğŸ“¢', text: 'é¢ç™½ã„ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã‚¯ã‚¹ãƒƒã¨ç¬‘ãˆã‚‹å®£ä¼æ–‡å¥' },
            { emoji: 'ğŸ”¤', text: 'æ¶ˆãˆã‹ã‘ã®æ–‡å­—ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã‹ã‚ã†ã˜ã¦èª­ã‚ã‚‹çœ‹æ¿ã‚„æ¨™è­˜' },
            { emoji: 'âš ï¸', text: 'æ„å‘³ä¸æ˜ãªæ³¨æ„æ›¸ãã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãªãœã“ã®æ³¨æ„ãŒå¿…è¦ï¼Ÿ' },
            
            // ãƒ¬ãƒˆãƒ­ãƒ»æ™‚ä»£ç³»
            { emoji: 'ğŸ ', text: 'ãƒ¬ãƒˆãƒ­ãªå»ºç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'æ˜­å’Œã®é¢å½±ã‚’æ®‹ã™å»ºç‰©' },
            { emoji: 'ğŸ¨', text: 'ã‚¿ã‚¤ãƒ«å¼µã‚Šã®å»ºç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¿ã‚¤ãƒ«ã€éŠ­æ¹¯ã‚¿ã‚¤ãƒ«ãªã©' },
            { emoji: 'ğŸ“', text: 'ä½¿ã‚ã‚Œã¦ã„ãªã„é›»è©±ãƒœãƒƒã‚¯ã‚¹ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ä»Šã¯èª°ã‚‚ä½¿ã‚ãªã„' },
            { emoji: 'ğŸª', text: 'æ˜”ãªãŒã‚‰ã®å•†åº—ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã‚·ãƒ£ãƒƒã‚¿ãƒ¼å•†åº—è¡—ã®ç”Ÿãæ®‹ã‚Š' },
            { emoji: 'ğŸ­', text: 'ç…™çªã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã‚‚ã†ç…™ã¯å‡ºã¦ã„ãªã„ï¼Ÿ' },
            { emoji: 'ğŸªŸ', text: 'æ ¼å­çª“ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'æ˜”ã®é˜²çŠ¯å¯¾ç­–' },
            
            // ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ãƒ»è£…é£¾ç³»
            { emoji: 'â­•', text: 'é¢ç™½ã„ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ‡ã‚¶ã‚¤ãƒ³ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã€ã”å½“åœ°æŸ„' },
            { emoji: 'ğŸ”²', text: 'å¤‰ã‚ã£ãŸå½¢ã®çª“ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ä¸¸çª“ã€ä¸‰è§’çª“ã€èˆ¹çª“ãªã©' },
            { emoji: 'ğŸšª', text: 'è£…é£¾ã•ã‚ŒãŸãƒ‰ã‚¢ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'å½«åˆ»ã€ã‚¹ãƒ†ãƒ³ãƒ‰ã‚°ãƒ©ã‚¹ãªã©' },
            { emoji: 'ğŸ›¤ï¸', text: 'ç¾ã—ã„æ‰‹ã™ã‚Šã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'é‰„ç´°å·¥ã€è£…é£¾çš„ãªãƒ‡ã‚¶ã‚¤ãƒ³' },
            { emoji: 'ğŸŒ€', text: 'æ¸¦å·»ãæ¨¡æ§˜ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'çœ‹æ¿ã€è£…é£¾ã€èºæ—‹éšæ®µãªã©' },
            { emoji: 'ğŸ‰', text: 'å‹•ç‰©ã®è£…é£¾ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'é¾ã€ç…å­ã€é³¥ãªã©' },
            
            // è¬ãƒ»ä¸æ€è­°ç³»
            { emoji: 'â“', text: 'ãªãœã“ã“ã«ï¼Ÿã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'å ´é•ã„ãªç‰©ä½“ã‚„é…ç½®' },
            { emoji: 'ğŸ­', text: 'è¬ã®ã‚ªãƒ–ã‚¸ã‚§ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'æ„å‘³ä¸æ˜ãªå½«åˆ»ã‚„é€ å½¢ç‰©' },
            { emoji: 'ğŸª´', text: 'ãƒ“ãƒ«ã®å±‹ä¸Šã®æ¤ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'èª°ãŒä¸–è©±ã‚’ï¼Ÿ' },
            { emoji: 'ğŸº', text: 'æ°‘å®¶ã®åº­ã®åƒã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãŸã¬ãã€ã‚«ã‚¨ãƒ«ã€ãŠåœ°è”µã•ã‚“ãªã©' },
            { emoji: 'ğŸ””', text: 'é˜ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã„ã¤é³´ã‚‹ï¼Ÿã©ã‚“ãªéŸ³ï¼Ÿ' },
            { emoji: 'ğŸª', text: 'é¡ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'è¦‹é€šã—ã®æ‚ªã„è§’ã®å®‰å…¨é¡' },
            
            // æ¤ç‰©ãƒ»è‡ªç„¶ç³»
            { emoji: 'ğŸŒ±', text: 'éš™é–“ã®æ¤ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã‚¢ã‚¹ãƒ•ã‚¡ãƒ«ãƒˆã®å‰²ã‚Œç›®ã‹ã‚‰' },
            { emoji: 'ğŸŒ³', text: 'ãƒ“ãƒ«ã®é–“ã®æœ¨ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'éƒ½ä¼šã®ä¸­ã®è‡ªç„¶' },
            { emoji: 'ğŸƒ', text: 'ã‚³ã‚±ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'æ¹¿ã£ãŸå ´æ‰€ã®ç·‘' },
            { emoji: 'ğŸŒ¸', text: 'æ„å¤–ãªå ´æ‰€ã®èŠ±ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'å¡€ã®ä¸Šã€å±‹æ ¹ã®ä¸Šãªã©' },
            { emoji: 'ğŸŒ¿', text: 'åå‰ã‚’çŸ¥ã‚‰ãªã„æ¤ç‰©ã‚’è¦‹ã¤ã‘ã¦èª¿ã¹ã‚ˆã†', hint: 'Google Lensã‚’ä½¿ã†ã¨ç°¡å˜' },
            { emoji: 'ğŸŒº', text: 'è¦‹ã‹ã‘ãŸèŠ±ã®åå‰ã‚’èª¿ã¹ã‚ˆã†', hint: 'å­£ç¯€ã®èŠ±ã‚’è¦³å¯Ÿ' },
            { emoji: 'ğŸ‚', text: 'è¡—è·¯æ¨¹ã®åå‰ã‚’èª¿ã¹ã‚ˆã†', hint: 'ã‚¤ãƒãƒ§ã‚¦ï¼Ÿã‚±ãƒ¤ã‚­ï¼Ÿãƒ—ãƒ©ã‚¿ãƒŠã‚¹ï¼Ÿ' },
            { emoji: 'â˜˜ï¸', text: 'é›‘è‰ã®åå‰ã‚’èª¿ã¹ã‚ˆã†', hint: 'å®Ÿã¯å¯æ„›ã„åå‰ã ã£ãŸã‚Š' },
            { emoji: 'ğŸŒ²', text: 'å¤§ããªæœ¨ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'æ¨¹é½¢ä½•å¹´ï¼Ÿ' },
            
            // ç”Ÿãç‰©ç³»
            { emoji: 'ğŸ¦', text: 'é³¥ã®å·£ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'çœ‹æ¿ã®è£ã€è»’ä¸‹ãªã©' },
            { emoji: 'ğŸˆ', text: 'çœ‹æ¿çŒ«/çœ‹æ¿çŠ¬ãŒã„ã‚‹åº—ã‚’æ¢ãã†', hint: 'åº—ç•ªã—ã¦ã‚‹å‹•ç‰©' },
            { emoji: 'ğŸ¦œ', text: 'è¦‹ã‹ã‘ãŸé³¥ã®åå‰ã‚’èª¿ã¹ã‚ˆã†', hint: 'é³´ãå£°ã€è‰²ã€å¤§ãã•ã«æ³¨ç›®' },
            { emoji: 'ğŸ¦‹', text: 'è¶ã®åå‰ã‚’èª¿ã¹ã‚ˆã†', hint: 'ã‚¢ã‚²ãƒï¼Ÿãƒ¢ãƒ³ã‚·ãƒ­ãƒãƒ§ã‚¦ï¼Ÿ' },
            
            // è‰²ãƒ»å…‰ç³»
            { emoji: 'ğŸŒˆ', text: 'åŒã˜è‰²ãŒ3ã¤ä¸¦ã‚“ã§ã„ã‚‹å ´æ‰€ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'å¶ç„¶ã®é…è‰²ã‚’æ¥½ã—ã‚€' },
            { emoji: 'â˜€ï¸', text: 'é¢ç™½ã„å½±ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'å»ºç‰©ã®å½±ã€æœ¨æ¼ã‚Œæ—¥' },
            { emoji: 'ğŸ’', text: 'çª“ã«æ˜ ã‚‹åå°„ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ“ãƒ«ã«æ˜ ã‚‹ãƒ“ãƒ«' },
            { emoji: 'ğŸ¨', text: 'é®®ã‚„ã‹ãªè‰²ã®å»ºç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ”ãƒ³ã‚¯ã€é’ã€é»„è‰²ãªã©' },
            
            // å‹•ç·šãƒ»é…ç½®ç³»
            { emoji: 'ğŸ”€', text: 'ä¸‰å‰è·¯ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'Yå­—è·¯ã€ã©ã£ã¡ã«è¡Œãï¼Ÿ' },
            { emoji: 'ğŸ›¤ï¸', text: 'è¡Œãæ­¢ã¾ã‚Šã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'çªç„¶çµ‚ã‚ã‚‹é“' },
            { emoji: 'ğŸ—»', text: 'æ€¥ãªå‚é“ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã“ã‚Œã¯ç™»ã‚Œãªã„ï¼' },
            { emoji: 'ğŸŒ‰', text: 'é«˜ä½å·®ã‚’æ„Ÿã˜ã‚ˆã†', hint: 'éšæ®µã€ã‚¹ãƒ­ãƒ¼ãƒ—ã€æ®µå·®' },
            
            // æ­´å²ãƒ»æ–‡åŒ–èª¿ã¹ã‚‹ç³»
            { emoji: 'ğŸ›ï¸', text: 'æ°—ã«ãªã‚‹å»ºç‰©ã®æ­´å²ã‚’èª¿ã¹ã‚ˆã†', hint: 'ã„ã¤å»ºã£ãŸï¼Ÿä½•ã«ä½¿ã‚ã‚Œã¦ã„ãŸï¼Ÿ' },
            { emoji: 'â›©ï¸', text: 'è¦‹ã‹ã‘ãŸç¥ç¤¾ã®ç”±æ¥ã‚’èª¿ã¹ã‚ˆã†', hint: 'ç¥€ã‚‰ã‚Œã¦ã„ã‚‹ã®ã¯èª°ï¼Ÿ' },
            { emoji: 'ğŸ—¿', text: 'çŸ³ç¢‘ã®æ–‡å­—ã‚’èª­ã‚“ã§ã¿ã‚ˆã†', hint: 'ä½•ãŒæ›¸ã„ã¦ã‚ã‚‹ï¼Ÿ' },
            { emoji: 'ğŸ“', text: 'åœ°åã®ç”±æ¥ã‚’èª¿ã¹ã‚ˆã†', hint: 'ãªãœã“ã®åœ°åï¼Ÿ' },
            { emoji: 'ğŸŒ‰', text: 'è¦‹ã‹ã‘ãŸæ©‹ã®åå‰ã®ç”±æ¥ã‚’èª¿ã¹ã‚ˆã†', hint: 'ãªãœã“ã®åå‰ï¼Ÿ' },
            { emoji: 'ğŸš‰', text: 'é§…åã®ç”±æ¥ã‚’èª¿ã¹ã‚ˆã†', hint: 'åœ°åï¼Ÿäººåï¼Ÿ' },
            
            // æƒ³åƒãƒ»æ„Ÿè¦šç³»
            { emoji: 'ğŸ”¨', text: 'å·¥äº‹ç¾å ´ã‚’è¦‹ã¤ã‘ã¦å®Œæˆã‚’æƒ³åƒã—ã‚ˆã†', hint: 'åŠå¹´å¾Œã«ã¾ãŸæ¥ã¦ã¿ã‚ˆã†' },
            { emoji: 'ğŸšï¸', text: 'æ°—ã«ãªã‚‹å»ºç‰©ã®éå»ã‚’æƒ³åƒã—ã‚ˆã†', hint: 'æ˜”ã¯ä½•ã ã£ãŸï¼Ÿèª°ãŒã„ãŸï¼Ÿ' },
            { emoji: 'ğŸ‘‚', text: 'è€³ã‚’æ¾„ã¾ã—ã¦éŸ³ã‚’èã“ã†', hint: 'é³¥ã€æ°´ã€é¢¨ã€è¡—ã®éŸ³' },
            { emoji: 'ğŸ‘ƒ', text: 'åŒ‚ã„ã«æ„è­˜ã‚’å‘ã‘ã‚ˆã†', hint: 'å­£ç¯€ã®åŒ‚ã„ã€åº—ã®åŒ‚ã„' }
        ];

        function showRandomMission() {
            const randomIndex = Math.floor(Math.random() * missions.length);
            const mission = missions[randomIndex];
            
            document.getElementById('missionEmoji').textContent = mission.emoji;
            document.getElementById('missionText').textContent = mission.text;
            document.getElementById('missionHint').textContent = mission.hint || '';
            
            document.getElementById('missionDisplay').classList.remove('hidden');
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        showMainScreen();
                    },
                    (error) => {
                        alert('ä½ç½®æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                );
            }
        }

        function showMainScreen() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            setTimeout(() => {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: userLocation,
                    zoom: 15
                });

                geocoder = new google.maps.Geocoder();

                new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: 'ç¾åœ¨åœ°',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });

                loadSavedDestinations();
            }, 100);
        }

        function setMode(mode) {
            currentMode = mode;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ
            const loopBtn = document.getElementById('loopModeBtn');
            const onewayBtn = document.getElementById('onewayModeBtn');
            
            if (mode === 'loop') {
                loopBtn.className = 'p-4 rounded-xl border-2 border-green-500 bg-green-50 transition-all';
                onewayBtn.className = 'p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 transition-all';
                document.getElementById('destinationSection').classList.add('hidden');
                document.getElementById('createRouteBtn').textContent = 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰';
            } else {
                loopBtn.className = 'p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 transition-all';
                onewayBtn.className = 'p-4 rounded-xl border-2 border-green-500 bg-green-50 transition-all';
                document.getElementById('destinationSection').classList.remove('hidden');
                document.getElementById('createRouteBtn').textContent = 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ';
            }

            // å‰ã®ãƒ«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }
            document.getElementById('routeInfo').classList.add('hidden');
            document.getElementById('routeSwitch').classList.add('hidden');
        }

        function updateSteps(value) {
            currentSteps = parseInt(value);
            document.getElementById('stepsDisplay').textContent = currentSteps.toLocaleString();
            const distance = ((currentSteps * 0.7) / 1000).toFixed(1);
            document.getElementById('distanceDisplay').textContent = `æ­© (${distance}km)`;
            
            // ç‰‡é“ãƒ¢ãƒ¼ãƒ‰ã§ç›®çš„åœ°ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€å¯„ã‚Šé“åˆ†ã‚’æ›´æ–°
            if (currentMode === 'oneway' && selectedDestination) {
                updateDestinationDisplay();
            }
        }

        function setSteps(value) {
            currentSteps = value;
            document.getElementById('stepsRange').value = value;
            updateSteps(value);
        }

        // ç™»éŒ²æ¸ˆã¿ç›®çš„åœ°ã‚’èª­ã¿è¾¼ã‚€
        function loadSavedDestinations() {
            const destinations = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
            const container = document.getElementById('savedDestinations');
            container.innerHTML = '';
            
            if (destinations.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 py-2">ç™»éŒ²ã•ã‚ŒãŸç›®çš„åœ°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            destinations.forEach((dest, index) => {
                const button = document.createElement('button');
                button.className = 'w-full p-3 rounded-lg border-2 border-gray-200 hover:border-green-500 transition-all text-left relative';
                button.innerHTML = `
                    <div class="font-medium">${dest.name}</div>
                    <div class="text-xs text-gray-500 mt-1">${dest.address || 'ä½æ‰€ãªã—'}</div>
                    <button onclick="deleteDestination(${index}); event.stopPropagation();" class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-xl">&times;</button>
                `;
                button.onclick = () => selectDestination(dest);
                container.appendChild(button);
            });
        }

        function showAddDestination() {
            document.getElementById('addDestinationModal').classList.remove('hidden');
        }

        function closeAddDestination() {
            document.getElementById('addDestinationModal').classList.add('hidden');
            document.getElementById('destName').value = '';
            document.getElementById('destAddress').value = '';
        }

        async function saveDestination() {
            const name = document.getElementById('destName').value.trim();
            const address = document.getElementById('destAddress').value.trim();
            
            if (!name) {
                alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!address) {
                alert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—
            try {
                const results = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === 'OK') {
                            resolve(results);
                        } else {
                            reject(status);
                        }
                    });
                });
                
                const location = results[0].geometry.location;
                const dest = {
                    name: name,
                    address: results[0].formatted_address,
                    lat: location.lat(),
                    lng: location.lng()
                };
                
                const destinations = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
                destinations.push(dest);
                localStorage.setItem('savedDestinations', JSON.stringify(destinations));
                
                closeAddDestination();
                loadSavedDestinations();
            } catch (error) {
                alert('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ­£ã—ã„ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function deleteDestination(index) {
            if (!confirm('ã“ã®ç›®çš„åœ°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const destinations = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
            destinations.splice(index, 1);
            localStorage.setItem('savedDestinations', JSON.stringify(destinations));
            
            if (selectedDestination && selectedDestination.index === index) {
                selectedDestination = null;
                document.getElementById('selectedDestinationDisplay').classList.add('hidden');
                if (destinationMarker) {
                    destinationMarker.setMap(null);
                    destinationMarker = null;
                }
            }
            
            loadSavedDestinations();
        }

        function selectDestination(dest) {
            selectedDestination = { ...dest };
            
            // åœ°å›³ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
            if (destinationMarker) {
                destinationMarker.setMap(null);
            }
            
            destinationMarker = new google.maps.Marker({
                position: { lat: dest.lat, lng: dest.lng },
                map: map,
                title: dest.name,
                animation: google.maps.Animation.DROP,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: '#EA4335',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                }
            });
            
            // åœ°å›³ã®ä¸­å¿ƒã‚’ç§»å‹•
            map.panTo({ lat: dest.lat, lng: dest.lng });
            
            updateDestinationDisplay();
        }

        function updateDestinationDisplay() {
            if (!selectedDestination) return;
            
            const directDistance = calculateDistance(userLocation, selectedDestination);
            const directSteps = Math.round((directDistance / 0.7) * 1000);
            const targetDistance = (currentSteps * 0.7) / 1000;
            const detourDistance = targetDistance - directDistance;
            
            document.getElementById('selectedDestinationName').textContent = selectedDestination.name;
            
            if (detourDistance > 0) {
                document.getElementById('selectedDestinationDistance').textContent = 
                    `ç›´ç·š: ${directDistance.toFixed(1)}km (${directSteps.toLocaleString()}æ­©) + å¯„ã‚Šé“: ${detourDistance.toFixed(1)}km (${Math.round((detourDistance / 0.7) * 1000).toLocaleString()}æ­©)`;
            } else {
                document.getElementById('selectedDestinationDistance').textContent = 
                    `ç›´ç·šè·é›¢: ${directDistance.toFixed(1)}km (${directSteps.toLocaleString()}æ­©) â€»è¨­å®šæ­©æ•°ã‚ˆã‚Šé•·ã„ãŸã‚æœ€çŸ­ãƒ«ãƒ¼ãƒˆã«ãªã‚Šã¾ã™`;
            }
            
            document.getElementById('selectedDestinationDisplay').classList.remove('hidden');
        }

        function selectFromMap() {
            if (!map) return;
            
            isSelectingFromMap = true;
            document.getElementById('mapSelectBtn').textContent = 'ğŸ“ åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç›®çš„åœ°ã‚’é¸æŠä¸­...';
            document.getElementById('mapSelectBtn').classList.add('bg-green-100', 'text-green-700');
            
            // ä¸€æ™‚çš„ãªãƒãƒ¼ã‚«ãƒ¼
            let tempMarker = null;
            
            const listener = map.addListener('click', (e) => {
                // ä¸€æ™‚ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                if (tempMarker) {
                    tempMarker.setMap(null);
                }
                
                const selectedLat = e.latLng.lat();
                const selectedLng = e.latLng.lng();
                
                selectedDestination = {
                    name: 'åœ°å›³ã§é¸æŠ',
                    lat: selectedLat,
                    lng: selectedLng
                };
                
                if (destinationMarker) {
                    destinationMarker.setMap(null);
                }
                
                destinationMarker = new google.maps.Marker({
                    position: e.latLng,
                    map: map,
                    title: 'é¸æŠã—ãŸç›®çš„åœ°',
                    animation: google.maps.Animation.DROP,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#EA4335',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    }
                });
                
                updateDestinationDisplay();
                isSelectingFromMap = false;
                document.getElementById('mapSelectBtn').textContent = 'ğŸ—ºï¸ åœ°å›³ã‹ã‚‰é¸æŠ';
                document.getElementById('mapSelectBtn').classList.remove('bg-green-100', 'text-green-700');
                google.maps.event.removeListener(listener);
                google.maps.event.removeListener(moveListener);
                
                // ä¿å­˜ã™ã‚‹ã‹ç¢ºèª
                const shouldSave = confirm('ã“ã®å ´æ‰€ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€â†’ åå‰ã‚’ã¤ã‘ã¦ä¿å­˜\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€â†’ ä»Šå›ã ã‘ä½¿ç”¨');
                
                if (shouldSave) {
                    const name = prompt('ç›®çš„åœ°ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nï¼ˆä¾‹: è‡ªå®…ã€è·å ´ã€ã‚«ãƒ•ã‚§ï¼‰', '');
                    if (name && name.trim()) {
                        const dest = {
                            name: name.trim(),
                            address: 'åœ°å›³ã§é¸æŠ',
                            lat: selectedLat,
                            lng: selectedLng
                        };
                        
                        const destinations = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
                        destinations.push(dest);
                        localStorage.setItem('savedDestinations', JSON.stringify(destinations));
                        
                        selectedDestination.name = name.trim();
                        loadSavedDestinations();
                        alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
                    }
                }
            });
            
            // ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ã§ä»®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
            const moveListener = map.addListener('mousemove', (e) => {
                if (tempMarker) {
                    tempMarker.setPosition(e.latLng);
                } else {
                    tempMarker = new google.maps.Marker({
                        position: e.latLng,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: '#EA4335',
                            fillOpacity: 0.5,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        }
                    });
                }
            });
        }

        async function createRoute() {
            if (!map || !userLocation) {
                alert('åœ°å›³ãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“');
                return;
            }

            if (currentMode === 'oneway' && !selectedDestination) {
                alert('ç›®çš„åœ°ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const button = document.getElementById('createRouteBtn');
            button.disabled = true;
            button.textContent = currentMode === 'loop' ? 'â³ ãƒ«ãƒ¼ãƒˆä½œæˆä¸­...ï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰' : 'â³ ãƒ«ãƒ¼ãƒˆä½œæˆä¸­...';

            // å‰å›ã®ãƒãƒªãƒ©ã‚¤ãƒ³ã‚’å‰Šé™¤
            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }

            try {
                const targetDistance = (currentSteps * 0.7) / 1000;
                const avoidHighways = document.getElementById('avoidHighways').checked;

                if (currentMode === 'loop') {
                    // å‘¨å›ãƒ¢ãƒ¼ãƒ‰
                    allRoutes = [];
                    const routePromises = [];

                    for (let i = 0; i < 3; i++) {
                        const waypoints = generateWaypoints(userLocation, targetDistance, i * 1000);
                        
                        const promise = fetch('/api/directions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                origin: userLocation,
                                destination: userLocation,
                                waypoints: waypoints,
                                avoidHighways: avoidHighways
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'OK' && data.routes && data.routes.length > 0) {
                                return data.routes[0];
                            }
                            return null;
                        });

                        routePromises.push(promise);
                    }

                    const routes = await Promise.all(routePromises);
                    allRoutes = routes.filter(route => route !== null);

                    console.log(`${allRoutes.length}å€‹ã®ãƒ«ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ`);

                    if (allRoutes.length > 0) {
                        displayRoute(0);
                        if (allRoutes.length > 1) {
                            showRouteSelection();
                        } else {
                            document.getElementById('routeSwitch').classList.add('hidden');
                        }
                    } else {
                        alert('ãƒ«ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } else {
                    // ç‰‡é“ãƒ¢ãƒ¼ãƒ‰
                    const directDistance = calculateDistance(userLocation, selectedDestination);
                    const detourDistance = targetDistance - directDistance;
                    
                    console.log(`=== ç‰‡é“ãƒ¢ãƒ¼ãƒ‰ ===`);
                    console.log(`ç›®æ¨™æ­©æ•°: ${currentSteps}æ­©`);
                    console.log(`ç›®æ¨™è·é›¢: ${targetDistance.toFixed(2)}km`);
                    console.log(`ç›´ç·šè·é›¢: ${directDistance.toFixed(2)}km (${Math.round((directDistance / 0.7) * 1000)}æ­©)`);
                    console.log(`å¿…è¦ãªå¯„ã‚Šé“: ${detourDistance.toFixed(2)}km (${Math.round((detourDistance / 0.7) * 1000)}æ­©)`);
                    
                    let waypoints = [];
                    if (detourDistance > 0) {
                        waypoints = generateDetourWaypoints(userLocation, selectedDestination, detourDistance);
                    } else {
                        console.log('ç›´ç·šè·é›¢ã®æ–¹ãŒé•·ã„ãŸã‚ã€æœ€çŸ­ãƒ«ãƒ¼ãƒˆã‚’ä½¿ç”¨');
                    }
                    
                    const response = await fetch('/api/directions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            origin: userLocation,
                            destination: selectedDestination,
                            waypoints: waypoints,
                            avoidHighways: avoidHighways
                        })
                    });

                    const data = await response.json();

                    if (data.status === 'OK' && data.routes && data.routes.length > 0) {
                        allRoutes = [data.routes[0]];
                        
                        // å®Ÿéš›ã®ãƒ«ãƒ¼ãƒˆè·é›¢ã‚’è¡¨ç¤º
                        let actualDistance = 0;
                        data.routes[0].legs.forEach(leg => {
                            actualDistance += leg.distance.value;
                        });
                        const actualSteps = Math.round((actualDistance / 1000) / 0.7 * 1000);
                        console.log(`å®Ÿéš›ã®ãƒ«ãƒ¼ãƒˆè·é›¢: ${(actualDistance / 1000).toFixed(2)}km (${actualSteps}æ­©)`);
                        console.log(`ç²¾åº¦: ${((actualSteps / currentSteps) * 100).toFixed(1)}%`);
                        
                        displayRoute(0);
                        document.getElementById('routeSwitch').classList.add('hidden');
                    } else {
                        alert('ãƒ«ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || data.status));
                    }
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = currentMode === 'loop' ? 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰' : 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ';
            }
        }

        // å¯„ã‚Šé“ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿæˆï¼ˆç‰‡é“ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
        function generateDetourWaypoints(origin, destination, detourDistanceKm) {
            const waypoints = [];
            
            console.log(`=== å¯„ã‚Šé“è¨ˆç®— ===`);
            console.log(`å¿…è¦ãªå¯„ã‚Šé“è·é›¢: ${detourDistanceKm.toFixed(2)}km`);
            
            // å¯„ã‚Šé“è·é›¢ã«å¿œã˜ã¦ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’æ±ºå®š
            let numWaypoints;
            if (detourDistanceKm < 1.0) {
                numWaypoints = 2;
            } else if (detourDistanceKm < 2.0) {
                numWaypoints = 3;
            } else if (detourDistanceKm < 3.5) {
                numWaypoints = 4;
            } else if (detourDistanceKm < 5.0) {
                numWaypoints = 5;
            } else {
                numWaypoints = 6;
            }
            
            console.log(`ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆæ•°: ${numWaypoints}`);
            
            // ç¾åœ¨åœ°â†’ç›®çš„åœ°ã®ç›´ç·šè·é›¢
            const directDistance = calculateDistance(origin, destination);
            
            // å¯„ã‚Šé“ã®åŠå¾„ï¼ˆä¿‚æ•°ã‚’å¤§å¹…ã«å°ã•ã: 4.0 â†’ 2.5ï¼‰
            const radiusKm = detourDistanceKm / 2.5;
            console.log(`å¯„ã‚Šé“åŠå¾„: ${radiusKm.toFixed(2)}km`);
            
            // é€²è¡Œæ–¹å‘ã®è§’åº¦ã‚’è¨ˆç®—
            const mainAngle = Math.atan2(destination.lng - origin.lng, destination.lat - origin.lat);
            
            // å·¦å³ã©ã¡ã‚‰ã«å¯„ã‚Šé“ã™ã‚‹ã‹ãƒ©ãƒ³ãƒ€ãƒ ã§æ±ºå®š
            const side = Math.random() > 0.5 ? 1 : -1;
            console.log(`å¯„ã‚Šé“æ–¹å‘: ${side > 0 ? 'å³' : 'å·¦'}`);
            
            // ä¸­é–“åœ°ç‚¹ã‚’åŸºæº–ç‚¹ã¨ã™ã‚‹
            const midLat = (origin.lat + destination.lat) / 2;
            const midLng = (origin.lng + destination.lng) / 2;
            
            // ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿæˆ
            for (let i = 0; i < numWaypoints; i++) {
                // é€²è¡Œæ–¹å‘ã«æ²¿ã£ãŸä½ç½®ï¼ˆ0.15ï½0.85ã®ç¯„å›²ã§é…ç½®ï¼‰
                const progress = 0.15 + (i / (numWaypoints - 1)) * 0.7;
                
                // ãƒ™ãƒ¼ã‚¹ä½ç½®ï¼ˆç¾åœ¨åœ°â†’ç›®çš„åœ°ã®ãƒ©ã‚¤ãƒ³ä¸Šï¼‰
                const baseLat = origin.lat + (destination.lat - origin.lat) * progress;
                const baseLng = origin.lng + (destination.lng - origin.lng) * progress;
                
                // å‚ç›´æ–¹å‘ã¸ã®å¯„ã‚Šé“è·é›¢ï¼ˆä¸­å¤®ãŒæœ€å¤§ï¼‰
                // å±±ãªã‚Šã®å½¢ã«ã™ã‚‹ãŒã€ã‚ˆã‚Šå¤§ããå¯„ã‚Šé“
                const detourFactor = Math.sin(Math.PI * (i + 1) / (numWaypoints + 1));
                // ä¿‚æ•°ã‚’1.2å€ã«ã—ã¦ã•ã‚‰ã«å¤§ããå¯„ã‚Šé“
                const perpDistance = radiusKm * detourFactor * side * 1.2;
                
                console.log(`çµŒç”±åœ°${i + 1}: progress=${progress.toFixed(2)}, detourFactor=${detourFactor.toFixed(2)}, perpDistance=${perpDistance.toFixed(2)}km`);
                
                // å‚ç›´æ–¹å‘ã®è§’åº¦
                const perpAngle = mainAngle + Math.PI / 2;
                
                // æœ€çµ‚çš„ãªåº§æ¨™
                const lat = baseLat + (perpDistance / 111) * Math.cos(perpAngle);
                const lng = baseLng + (perpDistance / (111 * Math.cos(baseLat * Math.PI / 180))) * Math.sin(perpAngle);
                
                waypoints.push({ lat, lng });
            }
            
            console.log(`ç”Ÿæˆã—ãŸã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆ:`, waypoints);
            
            return waypoints;
        }

        // ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayRoute(routeIndex) {
            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }

            currentRoute = allRoutes[routeIndex];

            const path = google.maps.geometry.encoding.decodePath(currentRoute.overview_polyline.points);
            
            currentPolyline = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#22c55e',
                strokeOpacity: 1.0,
                strokeWeight: 5,
                map: map
            });

            const bounds = new google.maps.LatLngBounds();
            path.forEach(point => bounds.extend(point));
            map.fitBounds(bounds);

            let totalDistance = 0;
            let totalDuration = 0;

            currentRoute.legs.forEach(leg => {
                totalDistance += leg.distance.value;
                totalDuration += leg.duration.value;
            });

            const distanceKm = (totalDistance / 1000).toFixed(1);
            const actualSteps = Math.round((totalDistance / 1000) / 0.7 * 1000);
            const timeMinutes = Math.round(totalDuration / 60);

            document.getElementById('routeDistance').textContent = distanceKm;
            document.getElementById('routeSteps').textContent = actualSteps.toLocaleString();
            document.getElementById('routeTime').textContent = timeMinutes;

            // Phase 2: çµŒç”±åœ°ã®å ´æ‰€åã‚’è¡¨ç¤º
            displayWaypoints(currentRoute);

            document.getElementById('routeInfo').classList.remove('hidden');
        }

        // Phase 2: çµŒç”±åœ°ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        async function displayWaypoints(route) {
            const waypointsList = document.getElementById('waypointsList');
            waypointsList.innerHTML = '<div class="text-sm text-gray-500">çµŒç”±åœ°æƒ…å ±ã‚’å–å¾—ä¸­...</div>';

            const waypoints = [];
            
            // å„ãƒ¬ã‚°ã®çµ‚ç‚¹ã‚’çµŒç”±åœ°ã¨ã—ã¦å–å¾—ï¼ˆæœ€å¾Œã®ãƒ¬ã‚°ã¯é™¤ãï¼‰
            route.legs.forEach((leg, index) => {
                if (index < route.legs.length - 1) {
                    waypoints.push({
                        lat: leg.end_location.lat,
                        lng: leg.end_location.lng
                    });
                }
            });

            if (waypoints.length === 0) {
                waypointsList.innerHTML = '<div class="text-sm text-gray-500">çµŒç”±åœ°ãªã—ï¼ˆç›´ç·šãƒ«ãƒ¼ãƒˆï¼‰</div>';
                return;
            }

            // å„çµŒç”±åœ°ã®å ´æ‰€åã‚’å–å¾—
            const placeNames = await Promise.all(
                waypoints.map(wp => getPlaceName(wp.lat, wp.lng))
            );

            // çµŒç”±åœ°æƒ…å ±ã‚’è¡¨ç¤º
            waypointsList.innerHTML = '';
            waypoints.forEach((wp, index) => {
                const waypointDiv = document.createElement('div');
                waypointDiv.className = 'bg-gray-50 p-3 rounded-lg';
                waypointDiv.innerHTML = `
                    <div class="flex items-start gap-2">
                        <div class="text-lg">ğŸ“</div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">çµŒç”±åœ°${index + 1}</div>
                            <div class="text-sm text-gray-600 mt-1">${placeNames[index]}</div>
                            <div class="text-xs text-gray-400 mt-1">${wp.lat.toFixed(5)}, ${wp.lng.toFixed(5)}</div>
                        </div>
                    </div>
                `;
                waypointsList.appendChild(waypointDiv);
            });
        }

        // ãƒ«ãƒ¼ãƒˆé¸æŠãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆåœ°å›³ã®ä¸‹ã«ç°¡æ˜“ç‰ˆï¼‰
        function showRouteSelection() {
            const routeSwitchContainer = document.getElementById('routeSwitchButtons');
            routeSwitchContainer.innerHTML = '';

            allRoutes.forEach((route, index) => {
                let totalDistance = 0;
                route.legs.forEach(leg => {
                    totalDistance += leg.distance.value;
                });

                const distanceKm = (totalDistance / 1000).toFixed(1);
                const actualSteps = Math.round((totalDistance / 1000) / 0.7 * 1000);

                const button = document.createElement('button');
                button.className = 'flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 hover:border-green-500 transition-all font-medium';
                button.innerHTML = `
                    <div class="text-center">
                        <div class="text-sm">ãƒ«ãƒ¼ãƒˆ${index + 1}</div>
                        <div class="text-xs text-gray-600 mt-1">${distanceKm}km Â· ${actualSteps.toLocaleString()}æ­©</div>
                    </div>
                `;
                button.onclick = () => {
                    displayRoute(index);
                    document.querySelectorAll('#routeSwitchButtons button').forEach(btn => {
                        btn.classList.remove('border-green-500', 'bg-green-50');
                        btn.classList.add('border-gray-200');
                    });
                    button.classList.add('border-green-500', 'bg-green-50');
                    button.classList.remove('border-gray-200');
                };

                routeSwitchContainer.appendChild(button);
            });

            const firstButton = routeSwitchContainer.querySelector('button');
            if (firstButton) {
                firstButton.classList.add('border-green-500', 'bg-green-50');
                firstButton.classList.remove('border-gray-200');
            }

            document.getElementById('routeSwitch').classList.remove('hidden');
        }

        function generateWaypoints(center, targetDistanceKm, seed = 0) {
            const waypoints = [];
            const timeSeed = (Date.now() % 1000 + seed) / 1000;
            
            const numWaypoints = 4;
            const radiusKm = targetDistanceKm / 7.45;
            
            const minDistanceBetweenWaypoints = radiusKm * 1.0;
            
            const startAngle = Math.random() * Math.PI * 2 + timeSeed * Math.PI;

            let attempts = 0;
            const maxAttempts = 50;

            while (waypoints.length < numWaypoints && attempts < maxAttempts) {
                const i = waypoints.length;
                const baseAngle = (Math.PI * 2 / numWaypoints) * i;
                const randomOffset = (Math.random() - 0.5) * 0.15;
                const angle = startAngle + baseAngle + randomOffset;
                const distance = radiusKm * (0.97 + Math.random() * 0.06);

                const lat = center.lat + (distance / 111) * Math.cos(angle);
                const lng = center.lng + (distance / (111 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle);

                const newWaypoint = { lat, lng };

                let tooClose = false;
                for (const existingWaypoint of waypoints) {
                    const dist = calculateDistance(existingWaypoint, newWaypoint);
                    if (dist < minDistanceBetweenWaypoints) {
                        tooClose = true;
                        break;
                    }
                }

                if (!tooClose) {
                    waypoints.push(newWaypoint);
                } else {
                    attempts++;
                }
            }

            if (waypoints.length < numWaypoints) {
                console.log('æœ€å°è·é›¢åˆ¶ç´„ã‚’ç·©ã‚ã¦å†ç”Ÿæˆ');
                return generateWaypointsSimple(center, targetDistanceKm, seed);
            }

            return waypoints;
        }

        function generateWaypointsSimple(center, targetDistanceKm, seed = 0) {
            const waypoints = [];
            const timeSeed = (Date.now() % 1000 + seed) / 1000;
            const numWaypoints = 4;
            const radiusKm = targetDistanceKm / 7.45;
            const startAngle = Math.random() * Math.PI * 2 + timeSeed * Math.PI;

            for (let i = 0; i < numWaypoints; i++) {
                const baseAngle = (Math.PI * 2 / numWaypoints) * i;
                const randomOffset = (Math.random() - 0.5) * 0.15;
                const angle = startAngle + baseAngle + randomOffset;
                const distance = radiusKm * (0.97 + Math.random() * 0.06);

                const lat = center.lat + (distance / 111) * Math.cos(angle);
                const lng = center.lng + (distance / (111 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle);

                waypoints.push({ lat, lng });
            }

            return waypoints;
        }

        function calculateDistance(point1, point2) {
            const R = 6371;
            const dLat = (point2.lat - point1.lat) * Math.PI / 180;
            const dLng = (point2.lng - point1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // åº§æ¨™ã‹ã‚‰å ´æ‰€åã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆPhase 2 - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµŒç”±ç‰ˆï¼‰
        async function getPlaceName(lat, lng) {
            try {
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIçµŒç”±ã§Places APIã‚’å‘¼ã³å‡ºã™
                const response = await fetch(`/api/places?lat=${lat}&lng=${lng}`);
                const data = await response.json();
                
                if (data.placeName && data.placeName !== 'ä¸æ˜ãªå ´æ‰€') {
                    return data.placeName;
                }
                
                // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯é“è·¯åãƒ»åœ°åã‚’å–å¾—
                return 'ğŸ“ çµŒç”±åœ°';
            } catch (error) {
                console.error('å ´æ‰€åå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return 'ğŸ“ çµŒç”±åœ°';
            }
        }

        function openInGoogleMaps() {
            if (!currentRoute || !userLocation) {
                alert('ã¾ãšãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }

            const waypoints = [];
            currentRoute.legs.forEach((leg, index) => {
                if (index < currentRoute.legs.length - 1) {
                    const loc = leg.end_location;
                    waypoints.push(`${loc.lat},${loc.lng}`);
                }
            });

            const origin = `${userLocation.lat},${userLocation.lng}`;
            let destination;
            
            if (currentMode === 'loop') {
                destination = origin;
            } else {
                destination = `${selectedDestination.lat},${selectedDestination.lng}`;
            }
            
            const waypointsParam = waypoints.join('|');
            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypointsParam}&travelmode=walking`;

            window.open(url, '_blank');
        }
    </script>
</body>
</html>
