<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; width: 100%; }
        @media (max-width: 640px) { #map { height: 400px; } }
        .pac-container { z-index: 10000; font-family: inherit; border-radius: 0.5rem; margin-top: 0.25rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .pac-item { padding: 0.75rem 1rem; cursor: pointer; border-top: 1px solid #e5e7eb; }
        .pac-item:hover { background-color: #f3f4f6; }
        .pac-item-query { font-weight: 600; color: #1f2937; }
        .pac-icon { display: none; }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        .nav-pulse { animation: pulse-ring 1.5s ease-out infinite; }
        #map.nav-mode { height: 70vh; min-height: 400px; }
        .stamp-card { transition: all 0.2s; }
        .stamp-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .stamp-visited { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-color: #10b981; }
        .stamp-unvisited { background: white; border-color: #e5e7eb; }
        .category-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: transparent; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-4">
    
    <!-- é–‹å§‹ç”»é¢ -->
    <div id="startScreen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="bg-green-500 p-4 rounded-2xl inline-block mb-4">
                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold mb-2">ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>
                <p class="text-gray-500">æ•£æ­©ã‚³ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
            </div>
            <button onclick="getLocation()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl hover:bg-green-600 transition-colors">
                ğŸ“ ç¾åœ¨åœ°ã‚’ä½¿ã†
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="max-w-4xl mx-auto space-y-6 hidden">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h1 class="text-2xl font-bold">ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>
            <p class="text-sm text-gray-500">Google Mapsç‰ˆ</p>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
        <div id="modeSection" class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="font-medium mb-3">ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h2>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="setMode('loop')" id="loopModeBtn" class="p-4 rounded-xl border-2 border-green-500 bg-green-50 transition-all">
                    <div class="text-2xl mb-2">ğŸ”„</div>
                    <div class="font-bold text-sm">å‘¨å›</div>
                    <div class="text-xs text-gray-600 mt-1">æˆ»ã£ã¦ãã‚‹</div>
                </button>
                <button onclick="setMode('oneway')" id="onewayModeBtn" class="p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 transition-all">
                    <div class="text-2xl mb-2">â¡ï¸</div>
                    <div class="font-bold text-sm">ç‰‡é“</div>
                    <div class="text-xs text-gray-600 mt-1">ç›®çš„åœ°ã¾ã§</div>
                </button>
                <button onclick="setMode('stamp')" id="stampModeBtn" class="p-4 rounded-xl border-2 border-gray-200 hover:border-purple-500 transition-all">
                    <div class="text-2xl mb-2">ğŸ“</div>
                    <div class="font-bold text-sm">ã‚¹ã‚¿ãƒ³ãƒ—</div>
                    <div class="text-xs text-gray-600 mt-1">ãƒ©ãƒªãƒ¼å·¡ã‚Š</div>
                </button>
            </div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒˆä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="routeCreationSection">
            <!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³ -->
            <div id="missionSection" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h2>
                <button onclick="showRandomMission()" class="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold hover:shadow-xl transition-all text-lg">
                    ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹
                </button>
                <div id="missionDisplay" class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl hidden">
                    <div class="text-center">
                        <div id="missionEmoji" class="text-5xl mb-3">ğŸªœ</div>
                        <div id="missionText" class="text-lg font-bold text-gray-800 mb-2"></div>
                        <div id="missionHint" class="text-sm text-gray-600 mb-4"></div>
                        <button onclick="showRandomMission()" class="px-4 py-2 bg-white rounded-lg text-purple-600 font-medium hover:bg-purple-50 transition-all">ğŸ”„ åˆ¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</button>
                    </div>
                </div>
            </div>

            <!-- ç‰‡é“ãƒ¢ãƒ¼ãƒ‰: ç›®çš„åœ°é¸æŠ -->
            <div id="destinationSection" class="bg-white rounded-2xl shadow-lg p-6 mb-6 hidden">
                <h2 class="font-medium mb-3">ğŸ“ ç›®çš„åœ°</h2>
                <button onclick="selectFromMap()" id="mapSelectBtn" class="w-full mb-4 py-4 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition-all text-lg">ğŸ—ºï¸ åœ°å›³ã‹ã‚‰é¸æŠ</button>
                <div class="mb-3">
                    <div class="text-sm font-medium text-gray-600 mb-2">ç™»éŒ²æ¸ˆã¿ã®ç›®çš„åœ°:</div>
                    <div id="savedDestinations" class="space-y-2"></div>
                </div>
                <button onclick="showAddDestination()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-green-500 hover:text-green-600 transition-all text-sm">ï¼‹ ä½æ‰€ã§è¿½åŠ </button>
                <div id="selectedDestinationDisplay" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
                    <div class="text-sm text-gray-600">é¸æŠä¸­:</div>
                    <div id="selectedDestinationName" class="font-bold text-lg"></div>
                    <div id="selectedDestinationDistance" class="text-sm text-gray-600 mt-1"></div>
                </div>
            </div>

            <!-- æ­©æ•°è¨­å®š -->
            <div id="stepsSection" class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ç›®æ¨™æ­©æ•°</h2>
                <div class="flex items-center gap-4">
                    <input type="range" id="stepsRange" min="1000" max="20000" step="500" value="5000" class="flex-1 h-2 bg-gray-200 rounded-lg cursor-pointer accent-green-500" oninput="updateSteps(this.value)">
                    <div class="text-right min-w-32">
                        <div id="stepsDisplay" class="text-3xl font-bold text-green-600">5,000</div>
                        <div id="distanceDisplay" class="text-sm text-gray-500">æ­© (3.5km)</div>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="setSteps(3000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">3åƒæ­©</button>
                    <button onclick="setSteps(5000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">5åƒæ­©</button>
                    <button onclick="setSteps(10000)" class="flex-1 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">1ä¸‡æ­©</button>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒˆè¨­å®š -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ãƒ«ãƒ¼ãƒˆè¨­å®š</h2>
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="avoidHighways" checked class="w-5 h-5 accent-green-500">
                    <span class="text-gray-700">å¤§é€šã‚Šãƒ»å¹¹ç·šé“è·¯ã‚’é¿ã‘ã‚‹</span>
                </label>
            </div>

            <!-- ãƒ«ãƒ¼ãƒˆä½œæˆãƒœã‚¿ãƒ³ -->
            <button onclick="createRoute()" id="createRouteBtn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition-all mb-6">
                ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰
            </button>
        </div>

        <!-- ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="stampRallySection" class="hidden">
            <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ã‚«ãƒ†ã‚´ãƒª</h2>
                <div class="flex flex-wrap gap-2" id="categoryButtons">
                    <button onclick="filterByCategory('all')" class="category-btn active px-4 py-2 rounded-full border-2 transition-all text-sm font-medium">ğŸ¯ ã™ã¹ã¦</button>
                    <button onclick="filterByCategory('temples')" class="category-btn px-4 py-2 rounded-full border-2 border-gray-200 transition-all text-sm font-medium">â›©ï¸ ç¥ç¤¾ä»é–£</button>
                    <button onclick="filterByCategory('public')" class="category-btn px-4 py-2 rounded-full border-2 border-gray-200 transition-all text-sm font-medium">ğŸ›ï¸ å…¬å…±æ–½è¨­</button>
                </div>
            </div>

            <!-- ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ä¸€è¦§ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="font-medium mb-3">ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h2>
                <div id="rallyList" class="space-y-3"></div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ‰ -->
            <div id="rallyDetailSection" class="bg-white rounded-2xl shadow-lg p-6 mb-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="closeRallyDetail()" class="text-gray-500 hover:text-gray-700">â† æˆ»ã‚‹</button>
                    <div id="rallyProgress" class="text-sm font-medium text-green-600"></div>
                </div>
                <h2 id="rallyDetailTitle" class="text-xl font-bold mb-2"></h2>
                <p id="rallyDetailDesc" class="text-sm text-gray-600 mb-4"></p>
                
                <!-- ãƒ«ãƒ¼ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ« -->
                <div class="flex items-center justify-between mb-4 p-3 bg-blue-50 rounded-xl">
                    <span class="font-medium text-blue-800">ğŸ—ºï¸ è¤‡æ•°é¸æŠã—ã¦ãƒ«ãƒ¼ãƒˆä½œæˆ</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="routeSelectMode" class="sr-only peer" onchange="toggleRouteSelectMode()">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                    </label>
                </div>
                
                <!-- é¸æŠæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
                <div id="selectedActionBar" class="hidden mb-4 p-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl text-white">
                    <div class="flex items-center justify-between">
                        <span id="selectedCount" class="font-bold">0ä»¶é¸æŠä¸­</span>
                        <div class="flex gap-2">
                            <button onclick="createRouteFromSelected()" class="px-3 py-1 bg-white text-blue-600 rounded-lg text-sm font-bold">ãƒ«ãƒ¼ãƒˆä½œæˆ</button>
                            <button onclick="openSelectedInGoogleMaps()" class="px-3 py-1 bg-white text-red-500 rounded-lg text-sm font-bold">ğŸ“Maps</button>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <button onclick="sortSpots('default')" class="sort-btn active px-3 py-1 text-sm rounded-lg bg-gray-100">ç•ªå·é †</button>
                    <button onclick="sortSpots('distance')" class="sort-btn px-3 py-1 text-sm rounded-lg bg-gray-100">è·é›¢é †</button>
                    <button onclick="sortSpots('unvisited')" class="sort-btn px-3 py-1 text-sm rounded-lg bg-gray-100">æœªè¨ªå•å„ªå…ˆ</button>
                </div>
                
                <div id="spotList" class="space-y-3"></div>
                
                <!-- Googleãƒãƒƒãƒ—ã§é–‹ããƒœã‚¿ãƒ³ -->
                <div class="mt-4 space-y-2">
                    <button onclick="openRallyInGoogleMaps('all')" class="w-full py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-bold hover:shadow-xl transition-all">
                        ğŸ—ºï¸ å…¨ã‚¹ãƒãƒƒãƒˆã‚’Googleãƒãƒƒãƒ—ã§é–‹ã
                    </button>
                    <button onclick="openRallyInGoogleMaps('unvisited')" class="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-all">
                        ğŸ“ æœªè¨ªå•ã®ã¿Googleãƒãƒƒãƒ—ã§é–‹ã
                    </button>
                </div>
            </div>
        </div>

        <!-- åœ°å›³ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-lg font-bold mb-4">ğŸ“ åœ°å›³</h2>
            <div id="map" class="rounded-xl border-2 border-gray-200"></div>
            <div id="routeSwitch" class="mt-4 hidden">
                <div class="text-sm font-medium text-gray-600 mb-2">ãƒ«ãƒ¼ãƒˆã‚’é¸æŠ:</div>
                <div id="routeSwitchButtons" class="flex gap-2"></div>
            </div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒˆæƒ…å ± -->
        <div id="routeInfo" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <h2 class="text-lg font-bold mb-4">ğŸ“Š ãƒ«ãƒ¼ãƒˆæƒ…å ±</h2>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-green-50 p-4 rounded-xl text-center">
                    <div id="routeDistance" class="text-2xl font-bold text-green-600">0</div>
                    <div class="text-sm text-gray-600">km</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl text-center">
                    <div id="routeSteps" class="text-2xl font-bold text-blue-600">0</div>
                    <div class="text-sm text-gray-600">æ­©</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl text-center">
                    <div id="routeTime" class="text-2xl font-bold text-purple-600">0</div>
                    <div class="text-sm text-gray-600">åˆ†</div>
                </div>
            </div>
            <button onclick="startNavigation()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 rounded-xl hover:shadow-xl transition-all mb-3">ğŸ§­ ãƒŠãƒ“é–‹å§‹</button>
            <button onclick="openInGoogleMaps()" class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200 transition-colors">ğŸ“± Googleãƒãƒƒãƒ—ã§é–‹ã</button>
        </div>

        <!-- ãƒŠãƒ“ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="navModePanel" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold">ğŸ§­ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä¸­</h2>
                <div id="navStatus" class="text-sm text-green-600 font-medium">ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...</div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-xl text-center">
                    <div id="navWalkedDistance" class="text-2xl font-bold text-blue-600">0</div>
                    <div class="text-sm text-gray-600">æ­©ã„ãŸè·é›¢ (km)</div>
                </div>
                <div class="bg-green-50 p-4 rounded-xl text-center">
                    <div id="navRemainingDistance" class="text-2xl font-bold text-green-600">0</div>
                    <div class="text-sm text-gray-600">æ®‹ã‚Š (km)</div>
                </div>
            </div>
            <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 rounded-xl">
                <span class="font-medium">åœ°å›³ã®è‡ªå‹•è¿½å¾“</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="followModeToggle" checked class="sr-only peer" onchange="toggleFollowMode()">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                </label>
            </div>
            <button onclick="stopNavigation()" class="w-full bg-red-500 text-white font-bold py-3 rounded-xl hover:bg-red-600 transition-colors">â¹ï¸ ãƒŠãƒ“ã‚’çµ‚äº†</button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ -->
    <div id="addDestinationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">æ–°ã—ã„ç›®çš„åœ°ã‚’è¿½åŠ </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åå‰</label>
                    <input type="text" id="destName" placeholder="ä¾‹: è‡ªå®…ã€è·å ´" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä½æ‰€ãƒ»æ–½è¨­å</label>
                    <input type="text" id="destAddress" placeholder="ä¾‹: å¤§é˜ªåŸå…¬åœ’" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-green-500 outline-none">
                </div>
            </div>
            <div class="space-y-3 mt-6">
                <button onclick="useDestinationNow()" class="w-full py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-bold">ğŸš€ ã™ãä½¿ã†</button>
                <div class="flex gap-3">
                    <button onclick="closeAddDestination()" class="flex-1 py-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="saveDestination()" class="flex-1 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600">ğŸ’¾ ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div id="checkinModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div id="checkinContent" class="text-center"></div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYFFfCe_7Ry15jh7J1n8gw7fF4JLJohxE&libraries=geometry,places"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map = null;
        let userLocation = null;
        let currentSteps = 5000;
        let currentRoute = null;
        let currentPolyline = null;
        let allRoutes = [];
        let currentMode = 'loop';
        let selectedDestination = null;
        let destinationMarker = null;
        let isSelectingFromMap = false;
        let geocoder = null;
        let autocomplete = null;
        let autocompletePlace = null;

        let isNavigating = false;
        let watchId = null;
        let currentPositionMarker = null;
        let currentPositionCircle = null;
        let followMode = true;
        let startPosition = null;
        let totalRouteDistance = 0;

        // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ç”¨
        let stampRallies = {};
        let currentRallyKey = null;
        let currentSortMode = 'default';
        let stampMarkers = [];
        let routeSelectMode = false;
        let selectedSpots = [];  // {id, lat, lng, name} ã®é…åˆ—

        // ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
        const missions = [
            { emoji: 'ğŸªœ', text: 'æ„å‘³ã®ãªã„éšæ®µã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã©ã“ã«ã‚‚è¡Œã‹ãªã„ç´”ç²‹éšæ®µ' },
            { emoji: 'ğŸšª', text: 'é–‹ã‹ãªã„æ‰‰ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'å£ã®ä¸­ã®ãƒ‰ã‚¢ã€2éšã®å®™ã¶ã‚‰ã‚Šã‚“ãƒ‰ã‚¢' },
            { emoji: 'ğŸªŸ', text: 'å¡ãŒã‚ŒãŸçª“ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ¬ãƒ³ã‚¬ã‚„ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã§å¡ãŒã‚ŒãŸçª“æ ' },
            { emoji: 'ğŸ—ï¸', text: 'å·¥äº‹ç¾å ´ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ä½•ãŒã§ãã‚‹ï¼ŸåŠå¹´å¾Œã«æ¥ã¦ã¿ã‚ˆã†' },
            { emoji: 'ğŸšï¸', text: 'å»ƒå¢Ÿã£ã½ã„å»ºç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'æ™‚ãŒæ­¢ã¾ã£ãŸå ´æ‰€' },
            { emoji: 'âœï¸', text: 'æ‰‹æ›¸ãã®çœ‹æ¿ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'åº—ä¸»ã®äººæŸ„ãŒå‡ºã‚‹' },
            { emoji: 'ğŸ®', text: 'æ˜­å’Œã®é›°å›²æ°—ã®çœ‹æ¿ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ›ãƒ¼ãƒ­ãƒ¼çœ‹æ¿ã€å¤ã„å­—ä½“' },
            { emoji: 'â­•', text: 'é¢ç™½ã„ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ãƒ‡ã‚¶ã‚¤ãƒ³ãƒãƒ³ãƒ›ãƒ¼ãƒ«' },
            { emoji: 'ğŸŒ±', text: 'éš™é–“ã®æ¤ç‰©ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'ã‚¢ã‚¹ãƒ•ã‚¡ãƒ«ãƒˆã®å‰²ã‚Œç›®ã‹ã‚‰' },
            { emoji: 'ğŸ”€', text: 'ä¸‰å‰è·¯ã‚’è¦‹ã¤ã‘ã‚ˆã†', hint: 'Yå­—è·¯ã€ã©ã£ã¡ã«è¡Œãï¼Ÿ' },
            { emoji: 'â›©ï¸', text: 'è¦‹ã‹ã‘ãŸç¥ç¤¾ã®ç”±æ¥ã‚’èª¿ã¹ã‚ˆã†', hint: 'ç¥€ã‚‰ã‚Œã¦ã„ã‚‹ã®ã¯èª°ï¼Ÿ' },
            { emoji: 'ğŸ—¿', text: 'çŸ³ç¢‘ã®æ–‡å­—ã‚’èª­ã‚“ã§ã¿ã‚ˆã†', hint: 'ä½•ãŒæ›¸ã„ã¦ã‚ã‚‹ï¼Ÿ' },
            { emoji: 'ğŸ‘‚', text: 'è€³ã‚’æ¾„ã¾ã—ã¦éŸ³ã‚’èã“ã†', hint: 'é³¥ã€æ°´ã€é¢¨ã€è¡—ã®éŸ³' }
        ];

        // åˆæœŸåŒ–
        async function loadStampRallies() {
            try {
                const response = await fetch('/data/stamp-rallies.json');
                stampRallies = await response.json();
                console.log('ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(stampRallies).length + 'ä»¶');
            } catch (error) {
                console.error('ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                stampRallies = {};
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (pos) => {
                        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        await loadStampRallies();
                        showMainScreen();
                    },
                    () => alert('ä½ç½®æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
                );
            }
        }

        function showMainScreen() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            setTimeout(() => {
                map = new google.maps.Map(document.getElementById('map'), { center: userLocation, zoom: 15 });
                geocoder = new google.maps.Geocoder();
                initAutocomplete();

                new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: 'ç¾åœ¨åœ°',
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2 }
                });

                loadSavedDestinations();
                renderRallyList();
            }, 100);
        }

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function setMode(mode) {
            currentMode = mode;
            const loopBtn = document.getElementById('loopModeBtn');
            const onewayBtn = document.getElementById('onewayModeBtn');
            const stampBtn = document.getElementById('stampModeBtn');
            
            loopBtn.className = 'p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 transition-all';
            onewayBtn.className = 'p-4 rounded-xl border-2 border-gray-200 hover:border-green-500 transition-all';
            stampBtn.className = 'p-4 rounded-xl border-2 border-gray-200 hover:border-purple-500 transition-all';
            
            const routeSection = document.getElementById('routeCreationSection');
            const stampSection = document.getElementById('stampRallySection');
            
            if (mode === 'loop') {
                loopBtn.className = 'p-4 rounded-xl border-2 border-green-500 bg-green-50 transition-all';
                routeSection.classList.remove('hidden');
                stampSection.classList.add('hidden');
                document.getElementById('destinationSection').classList.add('hidden');
                document.getElementById('createRouteBtn').textContent = 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰';
            } else if (mode === 'oneway') {
                onewayBtn.className = 'p-4 rounded-xl border-2 border-green-500 bg-green-50 transition-all';
                routeSection.classList.remove('hidden');
                stampSection.classList.add('hidden');
                document.getElementById('destinationSection').classList.remove('hidden');
                document.getElementById('createRouteBtn').textContent = 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ';
            } else if (mode === 'stamp') {
                stampBtn.className = 'p-4 rounded-xl border-2 border-purple-500 bg-purple-50 transition-all';
                routeSection.classList.add('hidden');
                stampSection.classList.remove('hidden');
                clearStampMarkers();
                renderRallyList();
            }

            if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }
            document.getElementById('routeInfo').classList.add('hidden');
            document.getElementById('routeSwitch').classList.add('hidden');
        }

        // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼æ©Ÿèƒ½
        function renderRallyList(category = 'all') {
            const container = document.getElementById('rallyList');
            container.innerHTML = '';
            
            for (const [key, rally] of Object.entries(stampRallies)) {
                if (category !== 'all' && rally.category !== category) continue;
                
                const visited = JSON.parse(localStorage.getItem(`stamp_${key}`) || '[]');
                const progress = `${visited.length}/${rally.spots.length}`;
                const isComplete = visited.length === rally.spots.length;
                
                const card = document.createElement('div');
                card.className = `stamp-card p-4 rounded-xl border-2 cursor-pointer ${isComplete ? 'stamp-visited' : 'stamp-unvisited'}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="text-3xl">${rally.icon}</div>
                            <div>
                                <div class="font-bold">${rally.name}</div>
                                <div class="text-xs text-gray-600">${rally.description}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${isComplete ? 'text-green-600' : 'text-gray-600'}">${progress}</div>
                            ${isComplete ? '<div class="text-xs text-green-600">ğŸ† åˆ¶è¦‡ï¼</div>' : ''}
                        </div>
                    </div>
                `;
                card.onclick = () => openRallyDetail(key);
                container.appendChild(card);
            }
        }

        function filterByCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('border-gray-200');
            });
            event.target.classList.add('active');
            event.target.classList.remove('border-gray-200');
            renderRallyList(category);
        }

        function openRallyDetail(rallyKey) {
            currentRallyKey = rallyKey;
            const rally = stampRallies[rallyKey];
            
            document.getElementById('rallyDetailTitle').textContent = `${rally.icon} ${rally.name}`;
            document.getElementById('rallyDetailDesc').textContent = rally.description;
            
            const visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
            document.getElementById('rallyProgress').textContent = `${visited.length}/${rally.spots.length} è¨ªå•æ¸ˆã¿`;
            
            renderSpotList(rallyKey);
            showSpotsOnMap(rallyKey);
            document.getElementById('rallyDetailSection').classList.remove('hidden');
        }

        function closeRallyDetail() {
            currentRallyKey = null;
            routeSelectMode = false;
            selectedSpots = [];
            document.getElementById('routeSelectMode').checked = false;
            document.getElementById('selectedActionBar').classList.add('hidden');
            document.getElementById('rallyDetailSection').classList.add('hidden');
            clearStampMarkers();
            renderRallyList();
        }

        function renderSpotList(rallyKey, sortMode = 'default') {
            const rally = stampRallies[rallyKey];
            const visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
            const container = document.getElementById('spotList');
            container.innerHTML = '';
            
            let spots = [...rally.spots];
            
            if (sortMode === 'distance' && userLocation) {
                spots.sort((a, b) => calculateDistance(userLocation, {lat: a.lat, lng: a.lng}) - calculateDistance(userLocation, {lat: b.lat, lng: b.lng}));
            } else if (sortMode === 'unvisited') {
                spots.sort((a, b) => (visited.includes(a.id) ? 1 : 0) - (visited.includes(b.id) ? 1 : 0));
            }
            
            spots.forEach(spot => {
                const isVisited = visited.includes(spot.id);
                const distance = userLocation ? calculateDistance(userLocation, {lat: spot.lat, lng: spot.lng}) : null;
                const googleMapUrl = `https://www.google.com/maps/search/?api=1&query=${spot.lat},${spot.lng}`;
                const isSelected = selectedSpots.some(s => s.id === spot.id);
                
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl border-2 ${isVisited ? 'stamp-visited' : 'stamp-unvisited'} ${isSelected ? 'ring-2 ring-blue-500' : ''}`;
                
                if (routeSelectMode) {
                    // é¸æŠãƒ¢ãƒ¼ãƒ‰æ™‚
                    card.innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" 
                                id="spot_${spot.id}" 
                                ${isSelected ? 'checked' : ''} 
                                onchange="toggleSpotSelection(${spot.id}, ${spot.lat}, ${spot.lng}, '${spot.name.replace(/'/g, "\\'")}')"
                                class="w-6 h-6 accent-blue-500 cursor-pointer flex-shrink-0">
                            <label for="spot_${spot.id}" class="flex-1 cursor-pointer">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">${isVisited ? 'âœ…' : 'â¬œ'}</span>
                                    <span class="font-bold">${spot.name}</span>
                                </div>
                                ${spot.detail ? `<div class="text-sm text-gray-600 ml-7">${spot.detail}</div>` : ''}
                                ${distance !== null ? `<div class="text-xs text-gray-500 ml-7">ğŸ“ ${(distance * 1000).toFixed(0)}m</div>` : ''}
                            </label>
                        </div>
                    `;
                } else {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰æ™‚
                    card.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">${isVisited ? 'âœ…' : 'â¬œ'}</span>
                                    <span class="font-bold">${spot.name}</span>
                                </div>
                                ${spot.detail ? `<div class="text-sm text-gray-600 ml-7">${spot.detail}</div>` : ''}
                                ${spot.blessing ? `<div class="text-xs text-purple-600 ml-7">ğŸ™ ${spot.blessing}</div>` : ''}
                                ${distance !== null ? `<div class="text-xs text-gray-500 ml-7">ğŸ“ ${(distance * 1000).toFixed(0)}m</div>` : ''}
                            </div>
                            <div class="flex flex-col gap-1">
                                ${!isVisited ? `<button onclick="checkIn('${rallyKey}', ${spot.id})" class="px-3 py-1 bg-green-500 text-white rounded-lg text-xs font-bold hover:bg-green-600">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</button>` : ''}
                                <button onclick="createRouteToSpot(${spot.lat}, ${spot.lng}, '${spot.name.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-xs font-bold hover:bg-blue-600">ãƒ«ãƒ¼ãƒˆ</button>
                                <a href="${googleMapUrl}" target="_blank" class="px-3 py-1 bg-red-500 text-white rounded-lg text-xs font-bold hover:bg-red-600 text-center">ğŸ“Maps</a>
                            </div>
                        </div>
                    `;
                }
                container.appendChild(card);
            });
        }

        function sortSpots(mode) {
            currentSortMode = mode;
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active', 'bg-green-100'));
            event.target.classList.add('active', 'bg-green-100');
            renderSpotList(currentRallyKey, mode);
        }

        function showSpotsOnMap(rallyKey) {
            clearStampMarkers();
            const rally = stampRallies[rallyKey];
            const visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
            const bounds = new google.maps.LatLngBounds();
            if (userLocation) bounds.extend(userLocation);
            
            rally.spots.forEach(spot => {
                const isVisited = visited.includes(spot.id);
                const googleMapUrl = `https://www.google.com/maps/search/?api=1&query=${spot.lat},${spot.lng}`;
                
                const marker = new google.maps.Marker({
                    position: {lat: spot.lat, lng: spot.lng},
                    map: map,
                    title: spot.name,
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 12, fillColor: isVisited ? '#10b981' : '#ef4444', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2 }
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding:8px; min-width:180px;">
                            <strong>${spot.name}</strong><br>
                            <span style="font-size:12px;color:#666;">${spot.detail || ''}</span><br>
                            <span style="font-size:12px;">${isVisited ? 'âœ… è¨ªå•æ¸ˆã¿' : 'â¬œ æœªè¨ªå•'}</span>
                            <hr style="margin:8px 0;border:0;border-top:1px solid #eee;">
                            <a href="${googleMapUrl}" target="_blank" style="display:block;text-align:center;color:#EA4335;text-decoration:none;font-weight:bold;font-size:12px;">
                                ğŸ“ Googleãƒãƒƒãƒ—ã§é–‹ã
                            </a>
                        </div>
                    `
                });
                marker.addListener('click', () => infoWindow.open(map, marker));
                stampMarkers.push(marker);
                bounds.extend({lat: spot.lat, lng: spot.lng});
            });
            map.fitBounds(bounds);
        }

        function clearStampMarkers() {
            stampMarkers.forEach(m => m.setMap(null));
            stampMarkers = [];
        }

        // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
        function checkIn(rallyKey, spotId) {
            if (!navigator.geolocation) { alert('ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
            
            navigator.geolocation.getCurrentPosition(pos => {
                const userPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
                const rally = stampRallies[rallyKey];
                const spot = rally.spots.find(s => s.id === spotId);
                const distance = calculateDistance(userPos, {lat: spot.lat, lng: spot.lng});
                
                if (distance <= 0.1) {
                    let visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
                    if (!visited.includes(spotId)) {
                        visited.push(spotId);
                        localStorage.setItem(`stamp_${rallyKey}`, JSON.stringify(visited));
                    }
                    
                    const overlaps = findOverlappingSpots(spot.name, spot.lat, spot.lng, rallyKey);
                    const isComplete = visited.length === rally.spots.length;
                    
                    if (overlaps.length > 0) {
                        showOverlapDialog(spot.name, spot.blessing, overlaps, isComplete, rallyKey);
                    } else if (isComplete) {
                        showCompleteModal(rally.name);
                    } else {
                        showCheckinSuccess(spot.name, spot.blessing);
                    }
                    openRallyDetail(rallyKey);
                } else {
                    alert(`ã¾ã ${spot.name}ã‹ã‚‰${(distance * 1000).toFixed(0)}mé›¢ã‚Œã¦ã„ã¾ã™ã€‚\n100mä»¥å†…ã«è¿‘ã¥ã„ã¦ãã ã•ã„ã€‚`);
                }
            }, () => alert('ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'));
        }

        function findOverlappingSpots(spotName, spotLat, spotLng, currentRallyKey) {
            const overlaps = [];
            const baseSpotName = spotName.replace(/ï¼ˆ.*ï¼‰/g, '').replace(/\(.*\)/g, '');
            
            for (const [rallyKey, rally] of Object.entries(stampRallies)) {
                if (rallyKey === currentRallyKey) continue;
                for (const spot of rally.spots) {
                    const baseTargetName = spot.name.replace(/ï¼ˆ.*ï¼‰/g, '').replace(/\(.*\)/g, '');
                    const distance = calculateDistance({lat: spotLat, lng: spotLng}, {lat: spot.lat, lng: spot.lng});
                    
                    if (baseSpotName.includes(baseTargetName) || baseTargetName.includes(baseSpotName) || distance <= 0.05) {
                        const visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
                        if (!visited.includes(spot.id)) {
                            overlaps.push({ rallyKey, rallyName: rally.name, rallyIcon: rally.icon, spotId: spot.id, spotName: spot.name, spotDetail: spot.detail });
                        }
                    }
                }
            }
            return overlaps;
        }

        function showOverlapDialog(spotName, blessing, overlaps, isComplete, currentRallyKey) {
            let checkboxes = overlaps.map((o, i) => `
                <label style="display:flex;align-items:center;padding:10px;background:#f5f5f5;border-radius:8px;margin:5px 0;cursor:pointer;">
                    <input type="checkbox" id="overlap_${i}" data-rally="${o.rallyKey}" data-spot="${o.spotId}" checked style="width:20px;height:20px;margin-right:10px;">
                    <div><div style="font-weight:bold;">${o.rallyIcon} ${o.rallyName}</div><div style="font-size:12px;color:#666;">${o.spotName}${o.spotDetail ? ' - ' + o.spotDetail : ''}</div></div>
                </label>
            `).join('');
            
            document.getElementById('checkinContent').innerHTML = `
                <div class="text-5xl mb-4">âœ…</div>
                <h2 class="text-xl font-bold mb-2">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æˆåŠŸï¼</h2>
                <p class="font-bold text-lg">${spotName}</p>
                ${blessing ? `<p class="text-purple-600 mt-2">ğŸ™ ${blessing}</p>` : ''}
                <div class="mt-4 p-4 bg-orange-50 rounded-xl text-left">
                    <p class="font-bold mb-2">ğŸ“ ã“ã®å ´æ‰€ã¯ä»–ã®ãƒ©ãƒªãƒ¼ã«ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ï¼š</p>
                    ${checkboxes}
                </div>
                <button onclick="applyOverlapCheckins(${isComplete}, '${currentRallyKey}')" class="w-full mt-4 py-3 bg-green-500 text-white rounded-xl font-bold">é¸æŠã—ãŸãƒ©ãƒªãƒ¼ã‚‚è¨ªå•æ¸ˆã¿ã«ã™ã‚‹</button>
                <button onclick="closeCheckinModal();${isComplete ? `showCompleteModal(stampRallies['${currentRallyKey}'].name)` : ''}" class="w-full mt-2 py-3 bg-gray-200 rounded-xl font-bold">ã“ã®ãƒ©ãƒªãƒ¼ã ã‘</button>
            `;
            document.getElementById('checkinModal').style.display = 'flex';
        }

        function applyOverlapCheckins(isComplete, currentRallyKey) {
            const checkboxes = document.querySelectorAll('#checkinContent input[type="checkbox"]:checked');
            let appliedCount = 0;
            let completedRallies = [];
            
            checkboxes.forEach(cb => {
                const rallyKey = cb.dataset.rally;
                const spotId = parseInt(cb.dataset.spot);
                let visited = JSON.parse(localStorage.getItem(`stamp_${rallyKey}`) || '[]');
                if (!visited.includes(spotId)) {
                    visited.push(spotId);
                    localStorage.setItem(`stamp_${rallyKey}`, JSON.stringify(visited));
                    appliedCount++;
                    if (visited.length === stampRallies[rallyKey].spots.length) completedRallies.push(stampRallies[rallyKey].name);
                }
            });
            
            let resultHtml = `<div class="text-5xl mb-4">${completedRallies.length > 0 || isComplete ? 'ğŸ†' : 'âœ…'}</div><h2 class="text-xl font-bold mb-2">${appliedCount}ä»¶ã®ãƒ©ãƒªãƒ¼ã«åæ˜ ã—ã¾ã—ãŸï¼</h2>`;
            if (isComplete) completedRallies.unshift(stampRallies[currentRallyKey].name);
            if (completedRallies.length > 0) resultHtml += `<div class="mt-4 p-4 bg-green-50 rounded-xl"><p class="font-bold">ğŸ‰ å…¨åˆ¶è¦‡é”æˆï¼</p>${completedRallies.map(n => `<p>ãƒ»${n}</p>`).join('')}</div>`;
            resultHtml += `<button onclick="closeCheckinModal()" class="w-full mt-4 py-3 bg-green-500 text-white rounded-xl font-bold">é–‰ã˜ã‚‹</button>`;
            document.getElementById('checkinContent').innerHTML = resultHtml;
        }

        function showCheckinSuccess(spotName, blessing) {
            document.getElementById('checkinContent').innerHTML = `
                <div class="text-5xl mb-4">âœ…</div>
                <h2 class="text-xl font-bold mb-2">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æˆåŠŸï¼</h2>
                <p class="font-bold text-lg">${spotName}</p>
                ${blessing ? `<p class="text-purple-600 mt-2">ğŸ™ ${blessing}</p>` : ''}
                <button onclick="closeCheckinModal()" class="w-full mt-4 py-3 bg-green-500 text-white rounded-xl font-bold">é–‰ã˜ã‚‹</button>
            `;
            document.getElementById('checkinModal').style.display = 'flex';
        }

        function showCompleteModal(rallyName) {
            document.getElementById('checkinContent').innerHTML = `
                <div class="text-5xl mb-4">ğŸ†</div>
                <h2 class="text-xl font-bold mb-2">å…¨åˆ¶è¦‡ãŠã‚ã§ã¨ã†ï¼</h2>
                <p class="font-bold text-lg">${rallyName}</p>
                <div class="text-4xl mt-4">ğŸ‰ğŸŠğŸ‰</div>
                <button onclick="closeCheckinModal()" class="w-full mt-4 py-3 bg-green-500 text-white rounded-xl font-bold">é–‰ã˜ã‚‹</button>
            `;
            document.getElementById('checkinModal').style.display = 'flex';
        }

        function closeCheckinModal() { document.getElementById('checkinModal').style.display = 'none'; }

        // é¸æŠã—ãŸã‚¹ãƒãƒƒãƒˆã¸ãƒ«ãƒ¼ãƒˆä½œæˆ
        function createRouteToSpot(lat, lng, name) {
            setMode('oneway');
            selectDestination({ name: name, lat: lat, lng: lng });
            // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼è©³ç´°ã‚’é–‰ã˜ã¦ãƒ«ãƒ¼ãƒˆä½œæˆç”»é¢ã¸
            document.getElementById('rallyDetailSection').classList.add('hidden');
            alert(`${name}ã¸ã®çµŒè·¯ã‚’ä½œæˆã—ã¾ã™ã€‚\næ­©æ•°ã‚’è¨­å®šã—ã¦ã€Œãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
        }

        // ãƒ«ãƒ¼ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ‰ã®ãƒˆã‚°ãƒ«
        function toggleRouteSelectMode() {
            routeSelectMode = document.getElementById('routeSelectMode').checked;
            if (!routeSelectMode) {
                selectedSpots = [];
            }
            updateSelectedUI();
            renderSpotList(currentRallyKey, currentSortMode);
        }

        // ã‚¹ãƒãƒƒãƒˆé¸æŠã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleSpotSelection(id, lat, lng, name) {
            const index = selectedSpots.findIndex(s => s.id === id);
            if (index > -1) {
                selectedSpots.splice(index, 1);
            } else {
                selectedSpots.push({ id, lat, lng, name });
            }
            updateSelectedUI();
        }

        // é¸æŠUIã®æ›´æ–°
        function updateSelectedUI() {
            const actionBar = document.getElementById('selectedActionBar');
            const countEl = document.getElementById('selectedCount');
            
            if (routeSelectMode && selectedSpots.length > 0) {
                actionBar.classList.remove('hidden');
                countEl.textContent = `${selectedSpots.length}ä»¶é¸æŠä¸­`;
            } else {
                actionBar.classList.add('hidden');
            }
        }

        // é¸æŠã‚’ã‚¯ãƒªã‚¢
        function clearSelectedSpots() {
            selectedSpots = [];
            updateSelectedUI();
            renderSpotList(currentRallyKey, currentSortMode);
        }

        // é¸æŠã—ãŸã‚¹ãƒãƒƒãƒˆã§ãƒ«ãƒ¼ãƒˆä½œæˆ
        function createRouteFromSelected() {
            if (selectedSpots.length === 0) {
                alert('ã‚¹ãƒãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // è·é›¢é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæœ€çŸ­å·¡å›ï¼‰
            let sortedSpots = [...selectedSpots];
            if (userLocation) {
                // è²ªæ¬²æ³•ã§æœ€çŸ­é †ã«ä¸¦ã¹æ›¿ãˆ
                const ordered = [];
                let current = userLocation;
                const remaining = [...sortedSpots];
                
                while (remaining.length > 0) {
                    let nearestIdx = 0;
                    let nearestDist = Infinity;
                    for (let i = 0; i < remaining.length; i++) {
                        const dist = calculateDistance(current, { lat: remaining[i].lat, lng: remaining[i].lng });
                        if (dist < nearestDist) {
                            nearestDist = dist;
                            nearestIdx = i;
                        }
                    }
                    const nearest = remaining.splice(nearestIdx, 1)[0];
                    ordered.push(nearest);
                    current = { lat: nearest.lat, lng: nearest.lng };
                }
                sortedSpots = ordered;
            }
            
            // ç‰‡é“ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã€æœ€å¾Œã®ã‚¹ãƒãƒƒãƒˆã‚’ç›®çš„åœ°ã«
            setMode('oneway');
            const destination = sortedSpots[sortedSpots.length - 1];
            selectDestination({ name: destination.name, lat: destination.lat, lng: destination.lng });
            
            // çµŒç”±åœ°ã‚’ä¿å­˜ï¼ˆå¾Œã§ãƒ«ãƒ¼ãƒˆä½œæˆæ™‚ã«ä½¿ç”¨ï¼‰
            window.selectedWaypoints = sortedSpots.slice(0, -1);
            
            document.getElementById('rallyDetailSection').classList.add('hidden');
            
            const waypointNames = sortedSpots.map(s => s.name).join(' â†’ ');
            alert(`${sortedSpots.length}ç®‡æ‰€ã‚’å·¡ã‚‹ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚\n\n${waypointNames}\n\næ­©æ•°ã‚’è¨­å®šã—ã¦ã€Œãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
        }

        // é¸æŠã—ãŸã‚¹ãƒãƒƒãƒˆã‚’Googleãƒãƒƒãƒ—ã§é–‹ã
        function openSelectedInGoogleMaps() {
            if (selectedSpots.length === 0) {
                alert('ã‚¹ãƒãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // è·é›¢é †ã«ã‚½ãƒ¼ãƒˆ
            let sortedSpots = [...selectedSpots];
            if (userLocation) {
                const ordered = [];
                let current = userLocation;
                const remaining = [...sortedSpots];
                
                while (remaining.length > 0) {
                    let nearestIdx = 0;
                    let nearestDist = Infinity;
                    for (let i = 0; i < remaining.length; i++) {
                        const dist = calculateDistance(current, { lat: remaining[i].lat, lng: remaining[i].lng });
                        if (dist < nearestDist) {
                            nearestDist = dist;
                            nearestIdx = i;
                        }
                    }
                    const nearest = remaining.splice(nearestIdx, 1)[0];
                    ordered.push(nearest);
                    current = { lat: nearest.lat, lng: nearest.lng };
                }
                sortedSpots = ordered;
            }
            
            const origin = userLocation ? `${userLocation.lat},${userLocation.lng}` : `${sortedSpots[0].lat},${sortedSpots[0].lng}`;
            const maxWaypoints = 10;
            
            if (sortedSpots.length === 1) {
                const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${sortedSpots[0].lat},${sortedSpots[0].lng}&travelmode=walking`;
                window.open(url, '_blank');
            } else if (sortedSpots.length <= maxWaypoints + 1) {
                const waypoints = sortedSpots.slice(0, -1).map(s => `${s.lat},${s.lng}`).join('|');
                const destination = sortedSpots[sortedSpots.length - 1];
                const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination.lat},${destination.lng}&waypoints=${waypoints}&travelmode=walking`;
                window.open(url, '_blank');
            } else {
                const limitedSpots = sortedSpots.slice(0, maxWaypoints + 1);
                const waypoints = limitedSpots.slice(0, -1).map(s => `${s.lat},${s.lng}`).join('|');
                const destination = limitedSpots[limitedSpots.length - 1];
                const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination.lat},${destination.lng}&waypoints=${waypoints}&travelmode=walking`;
                alert(`é¸æŠãŒå¤šã„ãŸã‚ã€è¿‘ã„é †ã«${maxWaypoints + 1}ç®‡æ‰€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`);
                window.open(url, '_blank');
            }
        }

        // Googleãƒãƒƒãƒ—ã§ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã‚’é–‹ã
        function openRallyInGoogleMaps(mode) {
            if (!currentRallyKey) return;
            const rally = stampRallies[currentRallyKey];
            const visited = JSON.parse(localStorage.getItem(`stamp_${currentRallyKey}`) || '[]');
            
            let spots = rally.spots;
            if (mode === 'unvisited') {
                spots = spots.filter(s => !visited.includes(s.id));
                if (spots.length === 0) {
                    alert('ã™ã¹ã¦ã®ã‚¹ãƒãƒƒãƒˆã‚’è¨ªå•æ¸ˆã¿ã§ã™ï¼');
                    return;
                }
            }
            
            // è·é›¢é †ã«ã‚½ãƒ¼ãƒˆï¼ˆåŠ¹ç‡çš„ãªå·¡å›é †ï¼‰
            if (userLocation) {
                spots = [...spots].sort((a, b) => 
                    calculateDistance(userLocation, {lat: a.lat, lng: a.lng}) - 
                    calculateDistance(userLocation, {lat: b.lat, lng: b.lng})
                );
            }
            
            // Google Mapsã§é–‹ãï¼ˆæœ€å¤§10ç®‡æ‰€ã¾ã§çµŒç”±åœ°ã¨ã—ã¦è¨­å®šå¯èƒ½ï¼‰
            const maxWaypoints = 10;
            const origin = userLocation ? `${userLocation.lat},${userLocation.lng}` : `${spots[0].lat},${spots[0].lng}`;
            
            if (spots.length === 1) {
                // 1ç®‡æ‰€ã ã‘ã®å ´åˆ
                const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${spots[0].lat},${spots[0].lng}&travelmode=walking`;
                window.open(url, '_blank');
            } else if (spots.length <= maxWaypoints + 1) {
                // çµŒç”±åœ°ã¨ã—ã¦å…¨éƒ¨å…¥ã‚‹å ´åˆ
                const waypoints = spots.slice(0, -1).map(s => `${s.lat},${s.lng}`).join('|');
                const destination = spots[spots.length - 1];
                const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination.lat},${destination.lng}&waypoints=${waypoints}&travelmode=walking`;
                window.open(url, '_blank');
            } else {
                // å¤šã™ãã‚‹å ´åˆã¯æœ€åˆã®10ç®‡æ‰€ + è­¦å‘Š
                const limitedSpots = spots.slice(0, maxWaypoints + 1);
                const waypoints = limitedSpots.slice(0, -1).map(s => `${s.lat},${s.lng}`).join('|');
                const destination = limitedSpots[limitedSpots.length - 1];
                const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination.lat},${destination.lng}&waypoints=${waypoints}&travelmode=walking`;
                
                alert(`ã‚¹ãƒãƒƒãƒˆãŒå¤šã„ãŸã‚ã€è¿‘ã„é †ã«${maxWaypoints + 1}ç®‡æ‰€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚\nï¼ˆå…¨${spots.length}ç®‡æ‰€ä¸­ï¼‰`);
                window.open(url, '_blank');
            }
        }

        // ãƒ«ãƒ¼ãƒˆä½œæˆ
        function showRandomMission() {
            const m = missions[Math.floor(Math.random() * missions.length)];
            document.getElementById('missionEmoji').textContent = m.emoji;
            document.getElementById('missionText').textContent = m.text;
            document.getElementById('missionHint').textContent = m.hint || '';
            document.getElementById('missionDisplay').classList.remove('hidden');
        }

        function updateSteps(value) {
            currentSteps = parseInt(value);
            document.getElementById('stepsDisplay').textContent = currentSteps.toLocaleString();
            document.getElementById('distanceDisplay').textContent = `æ­© (${((currentSteps * 0.7) / 1000).toFixed(1)}km)`;
            if (currentMode === 'oneway' && selectedDestination) updateDestinationDisplay();
        }

        function setSteps(value) { currentSteps = value; document.getElementById('stepsRange').value = value; updateSteps(value); }

        function initAutocomplete() {
            const input = document.getElementById('destAddress');
            autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: {country: 'jp'}, fields: ['formatted_address', 'geometry', 'name', 'place_id'], types: ['establishment', 'geocode'] });
            if (map) autocomplete.bindTo('bounds', map);
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry?.location) {
                    autocompletePlace = { name: place.name || place.formatted_address, address: place.formatted_address, location: { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() } };
                }
            });
        }

        function loadSavedDestinations() {
            const destinations = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
            const container = document.getElementById('savedDestinations');
            container.innerHTML = destinations.length === 0 ? '<div class="text-sm text-gray-500 py-2">ç™»éŒ²ãªã—</div>' : '';
            destinations.forEach((dest, index) => {
                const btn = document.createElement('button');
                btn.className = 'w-full p-3 rounded-lg border-2 border-gray-200 hover:border-green-500 transition-all text-left relative';
                btn.innerHTML = `<div class="font-medium">${dest.name}</div><div class="text-xs text-gray-500 mt-1">${dest.address || ''}</div><button onclick="deleteDestination(${index}); event.stopPropagation();" class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-xl">&times;</button>`;
                btn.onclick = () => selectDestination(dest);
                container.appendChild(btn);
            });
        }

        function showAddDestination() { document.getElementById('addDestinationModal').classList.remove('hidden'); }
        function closeAddDestination() { document.getElementById('addDestinationModal').classList.add('hidden'); document.getElementById('destName').value = ''; document.getElementById('destAddress').value = ''; autocompletePlace = null; }

        async function saveDestination() {
            const name = document.getElementById('destName').value.trim();
            const addr = document.getElementById('destAddress').value.trim();
            if (!name) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (!addr) { alert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            
            let dest;
            if (autocompletePlace) {
                dest = { name, address: autocompletePlace.address, lat: autocompletePlace.location.lat, lng: autocompletePlace.location.lng };
            } else {
                try {
                    const results = await new Promise((resolve, reject) => geocoder.geocode({address: addr}, (r, s) => s === 'OK' ? resolve(r) : reject(s)));
                    const loc = results[0].geometry.location;
                    dest = { name, address: results[0].formatted_address, lat: loc.lat(), lng: loc.lng() };
                } catch { alert('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return; }
            }
            const dests = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
            dests.push(dest);
            localStorage.setItem('savedDestinations', JSON.stringify(dests));
            selectDestination(dest);
            closeAddDestination();
            loadSavedDestinations();
        }

        async function useDestinationNow() {
            const addr = document.getElementById('destAddress').value.trim();
            if (!addr) { alert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (autocompletePlace) {
                selectDestination({ name: autocompletePlace.name, address: autocompletePlace.address, lat: autocompletePlace.location.lat, lng: autocompletePlace.location.lng });
                closeAddDestination();
                return;
            }
            try {
                const results = await new Promise((resolve, reject) => geocoder.geocode({address: addr}, (r, s) => s === 'OK' ? resolve(r) : reject(s)));
                const loc = results[0].geometry.location;
                selectDestination({ name: results[0].formatted_address, address: results[0].formatted_address, lat: loc.lat(), lng: loc.lng() });
                closeAddDestination();
            } catch { alert('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); }
        }

        function deleteDestination(index) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const dests = JSON.parse(localStorage.getItem('savedDestinations') || '[]');
            dests.splice(index, 1);
            localStorage.setItem('savedDestinations', JSON.stringify(dests));
            loadSavedDestinations();
        }

        function selectDestination(dest) {
            selectedDestination = {...dest};
            if (destinationMarker) destinationMarker.setMap(null);
            destinationMarker = new google.maps.Marker({
                position: {lat: dest.lat, lng: dest.lng}, map, title: dest.name, animation: google.maps.Animation.DROP,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 15, fillColor: '#EA4335', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 3 }
            });
            map.panTo({lat: dest.lat, lng: dest.lng});
            updateDestinationDisplay();
        }

        function updateDestinationDisplay() {
            if (!selectedDestination) return;
            const directDist = calculateDistance(userLocation, selectedDestination);
            const targetDist = (currentSteps * 0.7) / 1000;
            const detour = targetDist - directDist;
            document.getElementById('selectedDestinationName').textContent = selectedDestination.name;
            document.getElementById('selectedDestinationDistance').textContent = detour > 0 ? `ç›´ç·š: ${directDist.toFixed(1)}km + å¯„ã‚Šé“: ${detour.toFixed(1)}km` : `ç›´ç·šè·é›¢: ${directDist.toFixed(1)}km`;
            document.getElementById('selectedDestinationDisplay').classList.remove('hidden');
        }

        function selectFromMap() {
            if (!map) return;
            isSelectingFromMap = true;
            document.getElementById('mapSelectBtn').textContent = 'ğŸ“ åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠä¸­...';
            let tempMarker = null;
            
            const listener = map.addListener('click', e => {
                if (tempMarker) tempMarker.setMap(null);
                selectedDestination = { name: 'åœ°å›³ã§é¸æŠ', lat: e.latLng.lat(), lng: e.latLng.lng() };
                if (destinationMarker) destinationMarker.setMap(null);
                destinationMarker = new google.maps.Marker({
                    position: e.latLng, map, title: 'é¸æŠã—ãŸç›®çš„åœ°', animation: google.maps.Animation.DROP,
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 15, fillColor: '#EA4335', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 3 }
                });
                updateDestinationDisplay();
                isSelectingFromMap = false;
                document.getElementById('mapSelectBtn').textContent = 'ğŸ—ºï¸ åœ°å›³ã‹ã‚‰é¸æŠ';
                google.maps.event.removeListener(listener);
            });
        }

        async function createRoute() {
            if (!map || !userLocation) { alert('åœ°å›³ãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“'); return; }
            if (currentMode === 'oneway' && !selectedDestination) { alert('ç›®çš„åœ°ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

            const button = document.getElementById('createRouteBtn');
            button.disabled = true;
            button.textContent = 'â³ ãƒ«ãƒ¼ãƒˆä½œæˆä¸­...';
            if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }

            try {
                const targetDist = (currentSteps * 0.7) / 1000;
                const avoidHighways = document.getElementById('avoidHighways').checked;

                if (currentMode === 'loop') {
                    allRoutes = [];
                    const promises = [];
                    for (let i = 0; i < 6; i++) {
                        const waypoints = generateWaypoints(userLocation, targetDist, i * 1000);
                        promises.push(fetch('/api/directions', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ origin: userLocation, destination: userLocation, waypoints, avoidHighways, optimizeWaypoints: false })
                        }).then(r => r.json()).then(d => d.status === 'OK' && d.routes?.[0] ? d.routes[0] : null));
                    }
                    const routes = await Promise.all(promises);
                    const valid = routes.filter(r => r).map(r => ({route: r, score: calculateRouteOverlapScore(r)})).sort((a,b) => a.score - b.score);
                    allRoutes = valid.slice(0, 3).map(v => v.route);
                    if (allRoutes.length > 0) { displayRoute(0); if (allRoutes.length > 1) showRouteSelection(); else document.getElementById('routeSwitch').classList.add('hidden'); }
                    else alert('ãƒ«ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                } else {
                    // è¤‡æ•°ã‚¹ãƒãƒƒãƒˆé¸æŠæ™‚ã¯çµŒç”±åœ°ã¨ã—ã¦ä½¿ç”¨
                    let waypoints = [];
                    if (window.selectedWaypoints && window.selectedWaypoints.length > 0) {
                        waypoints = window.selectedWaypoints.map(s => ({ lat: s.lat, lng: s.lng }));
                        window.selectedWaypoints = null; // ä½¿ç”¨å¾Œã‚¯ãƒªã‚¢
                    } else {
                        const directDist = calculateDistance(userLocation, selectedDestination);
                        const detour = targetDist - directDist;
                        waypoints = detour > 0 ? generateDetourWaypoints(userLocation, selectedDestination, detour) : [];
                    }
                    const response = await fetch('/api/directions', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ origin: userLocation, destination: selectedDestination, waypoints, avoidHighways, optimizeWaypoints: false })
                    });
                    const data = await response.json();
                    if (data.status === 'OK' && data.routes?.[0]) { allRoutes = [data.routes[0]]; displayRoute(0); document.getElementById('routeSwitch').classList.add('hidden'); }
                    else alert('ãƒ«ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
            finally { button.disabled = false; button.textContent = currentMode === 'loop' ? 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰' : 'ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ'; }
        }

        function calculateRouteOverlapScore(route) {
            const path = google.maps.geometry.encoding.decodePath(route.overview_polyline.points);
            const segs = new Map();
            let overlap = 0;
            for (let i = 0; i < path.length - 1; i++) {
                const k1 = `${path[i].lat().toFixed(5)},${path[i].lng().toFixed(5)}`;
                const k2 = `${path[i+1].lat().toFixed(5)},${path[i+1].lng().toFixed(5)}`;
                const key = k1 < k2 ? `${k1}-${k2}` : `${k2}-${k1}`;
                if (segs.has(key)) overlap++;
                segs.set(key, (segs.get(key) || 0) + 1);
            }
            return path.length > 1 ? overlap / (path.length - 1) : 0;
        }

        function generateDetourWaypoints(origin, dest, detourKm) {
            const waypoints = [];
            const num = detourKm < 1 ? 2 : detourKm < 2 ? 3 : detourKm < 3.5 ? 4 : detourKm < 5 ? 5 : 6;
            const radius = detourKm / 2;
            const mainAngle = Math.atan2(dest.lng - origin.lng, dest.lat - origin.lat);
            const side = Math.random() > 0.5 ? 1 : -1;
            
            for (let i = 0; i < num; i++) {
                const progress = 0.15 + (i / (num - 1)) * 0.7;
                const baseLat = origin.lat + (dest.lat - origin.lat) * progress;
                const baseLng = origin.lng + (dest.lng - origin.lng) * progress;
                const factor = Math.sin(Math.PI * (i + 1) / (num + 1));
                const perpDist = radius * factor * side;
                const perpAngle = mainAngle + Math.PI / 2;
                waypoints.push({ lat: baseLat + (perpDist / 111) * Math.cos(perpAngle), lng: baseLng + (perpDist / (111 * Math.cos(baseLat * Math.PI / 180))) * Math.sin(perpAngle) });
            }
            return waypoints;
        }

        function displayRoute(idx) {
            if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }
            currentRoute = allRoutes[idx];
            const path = google.maps.geometry.encoding.decodePath(currentRoute.overview_polyline.points);
            currentPolyline = new google.maps.Polyline({ path, geodesic: true, strokeColor: '#22c55e', strokeOpacity: 1, strokeWeight: 5, map });
            const bounds = new google.maps.LatLngBounds();
            path.forEach(p => bounds.extend(p));
            map.fitBounds(bounds);

            let totalDist = 0, totalDur = 0;
            currentRoute.legs.forEach(leg => { totalDist += leg.distance.value; totalDur += leg.duration.value; });
            totalRouteDistance = totalDist;
            document.getElementById('routeDistance').textContent = (totalDist / 1000).toFixed(1);
            document.getElementById('routeSteps').textContent = Math.round((totalDist / 1000) / 0.7 * 1000).toLocaleString();
            document.getElementById('routeTime').textContent = Math.round(totalDur / 60);
            document.getElementById('routeInfo').classList.remove('hidden');
        }

        function showRouteSelection() {
            const container = document.getElementById('routeSwitchButtons');
            container.innerHTML = '';
            allRoutes.forEach((route, idx) => {
                let dist = 0;
                route.legs.forEach(leg => dist += leg.distance.value);
                const btn = document.createElement('button');
                btn.className = 'flex-1 py-3 px-4 rounded-lg border-2 border-gray-200 hover:border-green-500 transition-all font-medium';
                btn.innerHTML = `<div class="text-center"><div class="text-sm">ãƒ«ãƒ¼ãƒˆ${idx + 1}</div><div class="text-xs text-gray-600 mt-1">${(dist/1000).toFixed(1)}km</div></div>`;
                btn.onclick = () => {
                    displayRoute(idx);
                    document.querySelectorAll('#routeSwitchButtons button').forEach(b => { b.classList.remove('border-green-500', 'bg-green-50'); b.classList.add('border-gray-200'); });
                    btn.classList.add('border-green-500', 'bg-green-50');
                    btn.classList.remove('border-gray-200');
                };
                container.appendChild(btn);
            });
            container.querySelector('button')?.classList.add('border-green-500', 'bg-green-50');
            document.getElementById('routeSwitch').classList.remove('hidden');
        }

        function generateWaypoints(center, targetKm, seed = 0) {
            const waypoints = [];
            const timeSeed = (Date.now() % 1000 + seed) / 1000;
            const num = 4, radius = targetKm / 7.45;
            const startAngle = Math.random() * Math.PI * 2 + timeSeed * Math.PI;
            for (let i = 0; i < num; i++) {
                const angle = startAngle + (Math.PI * 2 / num) * i + (Math.random() - 0.5) * 0.15;
                const dist = radius * (0.97 + Math.random() * 0.06);
                waypoints.push({ lat: center.lat + (dist / 111) * Math.cos(angle), lng: center.lng + (dist / (111 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle) });
            }
            return waypoints;
        }

        function calculateDistance(p1, p2) {
            const R = 6371, dLat = (p2.lat - p1.lat) * Math.PI / 180, dLng = (p2.lng - p1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat * Math.PI/180) * Math.cos(p2.lat * Math.PI/180) * Math.sin(dLng/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function openInGoogleMaps() {
            if (!currentRoute || !userLocation) { alert('ã¾ãšãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„'); return; }
            const waypoints = [];
            currentRoute.legs.forEach((leg, i) => { if (i < currentRoute.legs.length - 1) waypoints.push(`${leg.end_location.lat},${leg.end_location.lng}`); });
            const origin = `${userLocation.lat},${userLocation.lng}`;
            const dest = currentMode === 'loop' ? origin : `${selectedDestination.lat},${selectedDestination.lng}`;
            window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&waypoints=${waypoints.join('|')}&travelmode=walking`, '_blank');
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        function startNavigation() {
            if (!currentRoute) { alert('ãƒ«ãƒ¼ãƒˆã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„'); return; }
            if (!navigator.geolocation) { alert('ä½ç½®æƒ…å ±éå¯¾å¿œ'); return; }
            isNavigating = true; followMode = true; startPosition = {...userLocation};
            enterNavigationMode();
            watchId = navigator.geolocation.watchPosition(updateCurrentPosition, () => { document.getElementById('navStatus').textContent = 'âš ï¸ GPSä¿¡å·å¼±'; }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
            document.getElementById('navStatus').textContent = 'ğŸ“ GPSè¿½è·¡ä¸­';
        }

        function stopNavigation() {
            if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
            isNavigating = false;
            if (currentPositionMarker) { currentPositionMarker.setMap(null); currentPositionMarker = null; }
            if (currentPositionCircle) { currentPositionCircle.setMap(null); currentPositionCircle = null; }
            exitNavigationMode();
        }

        function enterNavigationMode() {
            document.getElementById('modeSection').classList.add('hidden');
            document.getElementById('routeCreationSection').classList.add('hidden');
            document.getElementById('stampRallySection').classList.add('hidden');
            document.getElementById('routeSwitch').classList.add('hidden');
            document.getElementById('routeInfo').classList.add('hidden');
            document.getElementById('navModePanel').classList.remove('hidden');
            document.getElementById('map').classList.add('nav-mode');
            setTimeout(() => { google.maps.event.trigger(map, 'resize'); if (userLocation) { map.setCenter(userLocation); map.setZoom(17); } }, 100);
        }

        function exitNavigationMode() {
            document.getElementById('modeSection').classList.remove('hidden');
            if (currentMode === 'stamp') document.getElementById('stampRallySection').classList.remove('hidden');
            else document.getElementById('routeCreationSection').classList.remove('hidden');
            if (allRoutes.length > 1) document.getElementById('routeSwitch').classList.remove('hidden');
            document.getElementById('routeInfo').classList.remove('hidden');
            document.getElementById('navModePanel').classList.add('hidden');
            document.getElementById('map').classList.remove('nav-mode');
            setTimeout(() => google.maps.event.trigger(map, 'resize'), 100);
        }

        function updateCurrentPosition(pos) {
            const cur = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            if (currentPositionMarker) currentPositionMarker.setPosition(cur);
            else currentPositionMarker = new google.maps.Marker({ position: cur, map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: '#4285F4', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 3 }, zIndex: 999 });
            if (currentPositionCircle) currentPositionCircle.setCenter(cur);
            else currentPositionCircle = new google.maps.Circle({ strokeColor: '#4285F4', strokeOpacity: 0.4, strokeWeight: 2, fillColor: '#4285F4', fillOpacity: 0.15, map, center: cur, radius: pos.coords.accuracy || 20, zIndex: 998 });
            if (followMode) map.panTo(cur);
            const walked = calculateDistance(startPosition, cur);
            document.getElementById('navWalkedDistance').textContent = walked.toFixed(2);
            document.getElementById('navRemainingDistance').textContent = Math.max(0, (totalRouteDistance / 1000) - walked).toFixed(2);
        }

        function toggleFollowMode() { followMode = document.getElementById('followModeToggle').checked; }
    </script>
</body>
</html>
